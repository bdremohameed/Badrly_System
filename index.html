<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badrly POS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=IBM+Plex+Sans+Arabic:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        :root {
            --font-sans: 'Inter', sans-serif;
            --font-receipt: 'IBM Plex Sans Arabic', sans-serif;
            --bg-color: #f3f3f3; 
            --text-primary: #000000;
            --text-secondary: #555555;
            --accent-color: #0078d4; 
            --accent-hover: #106ebe;
            --accent-glow: rgba(0, 120, 212, 0.3);
            --btn-text-primary: #FFFFFF;
            --panel-bg: #ffffff; 
            --panel-border: #e0e0e0;
            --input-bg: #ffffff;
            --input-border: #cccccc;
            --secondary-btn-bg: #e1e1e1;
            --secondary-btn-hover: #d1d1d1;
        }
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        #login-view {
            background-color: #f0f4f8;
            background-image: 
                radial-gradient(at 0% 0%, hsla(215, 60%, 98%, 1) 0px, transparent 50%),
                radial-gradient(at 100% 0%, hsla(200, 70%, 95%, 1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, hsla(215, 60%, 90%, 1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(195, 50%, 95%, 1) 0px, transparent 50%);
        }

        @keyframes cutePopup {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            80% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .login-panel-enter {
             animation: cutePopup 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .view-enter-effect {
             animation: cutePopup 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .btn-glow:hover {
            box-shadow: 0 0 25px var(--accent-glow);
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); }
        ::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-hover); }

        .panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.08);
            border-radius: 1rem;
        }
        .input-field, select, textarea {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }
        .input-field::placeholder { color: var(--text-secondary); }
        .btn-primary {
            background-color: var(--accent-color);
            color: var(--btn-text-primary);
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
            transform: translateY(-2px);
        }
        .btn-primary:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }
        .btn-secondary {
            background-color: var(--secondary-btn-bg);
            color: var(--text-primary);
            font-weight: 700;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover { background-color: var(--secondary-btn-hover); }
        .product-card {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1);
            border-color: var(--accent-color);
        }
        .product-card.out-of-stock {
            opacity: 0.5;
            background-color: #fde8e8;
        }
         .product-card.low-stock {
            border-color: #f59e0b; 
        }
        .hidden-view { display: none !important; }

        @keyframes fadeInScaleUp {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .product-card-enter {
            animation: fadeInScaleUp 0.3s ease-out forwards;
            opacity: 0;
        }

        /* Updated product card styles */
        .product-card {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            border-color: var(--accent-color);
        }
        .product-card.out-of-stock {
            opacity: 0.6;
            background-color: #f8f8f8;
            cursor: not-allowed;
        }
        .product-card.low-stock {
            border-left: 4px solid #f59e0b; 
        }
        .product-card.out-of-stock .product-stock {
            color: #ef4444; /* red-500 */
            background-color: #fee2e2; /* red-100 */
        }

        @keyframes bell-shake {
            0% { transform: rotate(0); }
            15% { transform: rotate(5deg); }
            30% { transform: rotate(-5deg); }
            45% { transform: rotate(4deg); }
            60% { transform: rotate(-4deg); }
            75% { transform: rotate(2deg); }
            85% { transform: rotate(-2deg); }
            92% { transform: rotate(1deg); }
            100% { transform: rotate(0); }
        }

        .vibrating-bell {
            animation: bell-shake 0.8s ease-in-out infinite;
        }

        .inventory-card-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            padding-top: 0;
            padding-bottom: 0;
        }

        .inventory-card.expanded .inventory-card-details {
            max-height: 500px; /* A large enough value to show all content */
            transition: max-height 0.5s ease-in;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .stock-progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #e2e8f0; /* slate-200 */
            overflow: hidden;
        }
        .stock-progress-bar-inner {
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body>

    <div id="login-view" class="flex items-center justify-center h-screen p-4 bg-slate-50">
        <div class="login-panel-enter w-full max-w-md text-center">
            
            <div class="relative panel bg-white/80 backdrop-blur-xl p-8 sm:p-12 rounded-2xl shadow-2xl shadow-slate-300/20">
                <button id="login-help-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors" title="Help Center">
                    <i data-lucide="life-buoy" class="w-6 h-6"></i>
                </button>
                
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-400 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/30 relative">
                    <span class="font-black text-6xl opacity-80" style="font-family: 'Inter', sans-serif;">B</span>
                    <svg class="absolute w-16 h-16 text-white/90" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12h18"></path>
                    </svg>
                </div>
                
                <h1 class="text-4xl font-black text-slate-800 mb-2">Welcome to Badrly</h1>
                <p class="text-slate-500 mb-8">Securely access your sales data from anywhere.</p>

                <div class="space-y-4">
                    <button id="login-btn" class="w-full flex items-center justify-center gap-3 btn-primary text-white font-bold py-4 px-4 rounded-xl shadow-lg shadow-blue-500/30 text-lg transition-all transform hover:scale-105 btn-glow">
                        <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.657-3.356-11.303-7.962l-6.571,4.819C9.656,39.663,16.318,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.021,35.596,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                        <span>Continue with Google</span>
                    </button>
                    <button id="owner-settings-btn" class="w-full flex items-center justify-center gap-3 bg-white hover:bg-slate-50 text-slate-600 font-bold py-4 px-4 rounded-xl shadow-sm border border-slate-200 text-lg transition-all transform hover:scale-105">
                        <i data-lucide="shield-check" class="text-slate-500"></i>
                        <span>Owner Access</span>
                    </button>
                </div>

                <p id="login-status-message" class="text-slate-400 mt-8 h-6 transition-all"></p>

                <div class="absolute bottom-4 left-0 right-0 text-center text-xs text-slate-400">
                    <p>Powered by Al-Badr</p>
                    <a href="http://badre.site/" target="_blank" class="font-semibold text-sky-500 hover:text-sky-600 transition-colors">Website</a>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="in-app-maintenance-view" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[200] flex items-center justify-center p-4 text-center">
            <div class="login-panel-enter w-full max-w-lg">
                <div class="relative panel bg-slate-800/50 backdrop-blur-xl p-8 sm:p-12 rounded-2xl shadow-2xl shadow-slate-900/20">
                    <button id="maintenance-help-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-300 hover:bg-slate-700 hover:text-white transition-colors" title="Help Center">
                        <i data-lucide="life-buoy" class="w-6 h-6"></i>
                    </button>
                    <div class="w-24 h-24 bg-gradient-to-br from-amber-500 to-orange-500 text-white rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-lg shadow-amber-500/30 animate-pulse">
                        <i data-lucide="wrench" class="w-12 h-12"></i>
                    </div>
                    <h1 class="text-4xl font-black text-white mb-4">Under Maintenance</h1>
                    <p id="in-app-maintenance-message" class="text-slate-300 text-lg max-w-md mx-auto">The system is currently down for scheduled maintenance. Please check back later.</p>
                </div>
            </div>
        </div>
        <div class="w-full max-w-7xl mx-auto p-4">
            <div id="pos-view" class="flex flex-col lg:flex-row h-[calc(100vh-2rem)] gap-4">
                <div class="w-full lg:w-3/5 panel p-6 flex flex-col">
                    <div id="products-section" class="flex flex-col h-full">
                         <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-4">
                                <h2 class="text-3xl font-bold text-[var(--text-primary)]">Products</h2>
                            </div>
                            <div id="user-info" class="text-right relative"></div>
                        </div>
                        <div class="relative mb-4">
                            <input type="text" id="search-input" placeholder="Search for a product by name or code..." class="w-full p-3 pr-10 input-field"/>
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><i data-lucide="search" class="text-[var(--text-secondary)]"></i></div>
                        </div>
                        <div class="flex-grow overflow-y-auto pl-2">
                            <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                        </div>
                        <div id="add-new-product-section" class="hidden mt-4 pt-4 border-t border-[var(--panel-border)]">
                            <h3 class="text-xl font-bold text-[var(--text-primary)] mb-3">Add New Product to List</h3>
                            <div class="bg-gray-50 p-4 rounded-lg space-y-4">
                                <!-- Row 1: Name -->
                                <div>
                                    <label for="new-product-name" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Product Name</label>
                                    <div class="relative">
                                        <i data-lucide="package" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                                        <input type="text" id="new-product-name" class="w-full p-2 pl-10 input-field">
                                    </div>
                                </div>
                                <!-- Row 2: Pricing -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label for="new-product-purchase-price" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Purchase Price</label>
                                        <input type="number" id="new-product-purchase-price" placeholder="0.00" class="w-full p-2 input-field">
                                    </div>
                                    <div>
                                        <label for="new-product-profit-margin" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Profit Margin (%)</label>
                                        <input type="number" id="new-product-profit-margin" placeholder="e.g., 25" class="w-full p-2 input-field">
                                    </div>
                                    <div>
                                        <label for="new-product-price" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Selling Price</label>
                                        <input type="number" id="new-product-price" placeholder="0.00" class="w-full p-2 input-field font-bold bg-slate-200">
                                    </div>
                                </div>
                                <!-- Row 3: Stock & Add -->
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                    <div class="md:col-span-4">
                                        <label for="new-product-quantity" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">On-Hand Quantity</label>
                                        <input type="number" id="new-product-quantity" class="w-full p-2 input-field">
                                    </div>
                                    <div class="md:col-span-4 flex flex-col items-center justify-center pt-5">
                                         <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="unlimited-stock-checkbox" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            <span class="ms-3 text-sm font-medium text-gray-900">Imported (Unlimited)</span>
                                        </label>
                                    </div>
                                    <div class="md:col-span-4 flex items-center justify-end">
                                        <button id="add-new-product-btn" class="w-12 h-12 flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-bold rounded-full shadow-lg transition-all transform hover:scale-110">
                                            <i data-lucide="plus" class="h-7 w-7"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="product-screen-footer" class="mt-4 pt-4 border-t border-[var(--panel-border)] text-center text-xs text-[var(--text-secondary)] space-y-1">
                            <div id="footer-live-info" class="flex justify-center items-center gap-4">
                            </div>
                            <div id="footer-session-info" class="h-4">
                            </div>
                        </div>
                    </div>
                    <div id="receipt-preview-area" class="hidden flex-col h-full panel p-4"></div>
                </div>

                <div class="w-full lg:w-2/5 panel p-6 flex flex-col">
                    <div class="flex justify-between items-start">
                        <h2 id="invoice-title" class="text-3xl font-bold text-[var(--text-primary)]">Invoice</h2>
                    </div>
                    
                    <div class="bg-slate-50/70 border border-slate-200/80 rounded-xl p-3 my-4 space-y-3">
                        <h3 class="text-sm font-semibold text-slate-600">customer information.</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="relative">
                                <i data-lucide="user" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                                <input type="text" id="customer-name-input" placeholder="Customer Name" class="w-full p-2 pl-9 input-field rounded-lg text-sm">
                            </div>
                             <div class="relative">
                                <i data-lucide="phone" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                                <input type="text" id="customer-phone-input" placeholder="Phone Number" class="w-full p-2 pl-9 input-field rounded-lg text-sm">
                            </div>
                        </div>
                        <div class="relative">
                             <i data-lucide="user-check" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <select id="cashier-select" class="w-full p-2 pl-9 input-field rounded-lg appearance-none text-sm">
                                <option value="">-- Select Cashier --</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                        <div class="relative">
                            <i data-lucide="sticky-note" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                            <textarea id="invoice-notes-input" placeholder="Invoice Notes (for internal use)" class="w-full p-2 pl-9 input-field rounded-lg text-sm" rows="1"></textarea>
                        </div>
                    </div>

                    <div class="flex-grow h-0 overflow-y-auto border-y border-[var(--panel-border)] mb-4">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-[var(--panel-bg)]">
                                <tr>
                                    <th class="py-3 text-left font-bold text-[var(--text-secondary)]">Item</th>
                                    <th class="py-3 text-center font-bold text-[var(--text-secondary)]">Qty</th>
                                    <th class="py-3 text-center font-bold text-[var(--text-secondary)]">Discount</th>
                                    <th class="py-3 text-right font-bold text-[var(--text-secondary)]">Total</th>
                                    <th class="py-3"></th>
                                </tr>
                            </thead>
                            <tbody id="cart-items"></tbody>
                        </table>
                    </div>
                    
                    <div class="my-4">
                        <div class="bg-slate-50/70 p-3 rounded-xl border border-slate-200/80">
                             <div class="grid grid-cols-12 gap-2 items-center">
                                <div class="col-span-6">
                                    <div class="relative">
                                        <i data-lucide="package" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                                        <input type="text" id="custom-item-name" placeholder="Custom Item" class="w-full p-2 pl-9 input-field text-sm">
                                    </div>
                                </div>
                                <div class="col-span-4">
                                    <div class="relative">
                                        <i data-lucide="dollar-sign" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                                        <input type="number" id="custom-item-price" placeholder="Price" class="w-full p-2 pl-9 input-field text-sm">
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <button id="add-custom-item-btn" class="w-full h-full p-2 flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow-md transition-all transform hover:scale-105"><i data-lucide="plus" class="h-5 w-5"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center font-medium text-[var(--text-secondary)]"><span>Subtotal:</span><span id="subtotal" class="font-bold text-[var(--text-primary)]">0.00</span></div>
                        <div class="flex justify-between items-center font-medium text-[var(--text-secondary)]"><span>Items Discount:</span><span id="total-discount" class="w-28 p-1 text-right text-base font-bold text-[var(--text-primary)]">0.00</span></div>
                        <div class="flex justify-between items-center font-medium text-[var(--text-secondary)]"><span>Invoice Discount:</span><input type="number" id="invoice-discount-input" placeholder="0.00" class="w-28 p-1 input-field text-right text-base font-bold text-red-600"/></div>
                        <hr class="border-[var(--panel-border)]"/>
                        <div class="flex justify-between items-center font-bold text-2xl text-[var(--text-primary)]"><span>Total:</span><span id="total">0.00</span></div>
                        <div class="flex justify-between items-center font-medium"><span>Tendered:</span><input type="number" id="tendered-input" placeholder="Leave empty" class="w-40 p-1 input-field text-right text-base font-bold"/></div>
                        <hr class="my-1 border-[var(--panel-border)]"/>
                        <div id="change-container" class="flex justify-between items-center font-bold text-lg p-1.5 rounded-lg"><span>Change:</span><span id="change">0.00</span></div>
                        <div class="flex justify-between items-center font-medium text-[var(--text-secondary)]">
                            <span>Payment Method:</span>
                            <select id="payment-method" class="w-40 p-1 input-field text-sm font-bold">
                                <option value="Cash">Cash</option>
                                <option value="Vodafone Cash">Vodafone Cash</option>
                                <option value="InstaPay">InstaPay</option>
                                <option value="Credit">Credit</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="space-y-3 mt-auto pt-4 border-t">
                        <div class="flex items-stretch gap-2">
                            <button id="print-receipt-btn" class="flex-grow flex items-center justify-center gap-2 btn-primary py-3 rounded-xl shadow-lg text-base font-bold btn-glow transform hover:scale-105 transition-all"><i data-lucide="printer" class="w-4 h-4"></i><span>Save & Print</span></button>
                            <button id="preview-receipt-btn" title="Preview" class="w-14 h-auto flex-shrink-0 flex items-center justify-center bg-sky-500 hover:bg-sky-600 text-white font-bold rounded-xl shadow-lg transform hover:scale-105 transition-all"><i data-lucide="eye" class="w-4 h-4"></i></button>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <button id="view-invoices-btn" class="flex flex-col items-center justify-center gap-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 rounded-xl transition-colors"><i data-lucide="history" class="w-4 h-4"></i><span class="text-xs">Invoices</span></button>
                            <button id="view-returns-btn" class="flex flex-col items-center justify-center gap-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 rounded-xl transition-colors"><i data-lucide="undo-2" class="w-4 h-4"></i><span class="text-xs">Returns</span></button>
                            <button id="view-customers-btn" class="flex flex-col items-center justify-center gap-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 rounded-xl transition-colors"><i data-lucide="users-2" class="w-4 h-4"></i><span class="text-xs">Customers</span></button>
                            <button id="clear-sale-btn" class="flex flex-col items-center justify-center gap-1 bg-red-50 hover:bg-red-100 text-red-600 border border-red-200/50 font-semibold py-3 rounded-xl transition-colors"><i data-lucide="x-circle" class="w-4 h-4"></i><span class="text-xs">Clear</span></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="invoices-view" class="hidden-view h-[calc(100vh-2rem)] p-6 flex-col panel view-enter-effect">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold text-[var(--text-primary)]">Saved Invoices</h2>
                    <div class="flex items-center gap-2">
                        <button id="show-archive-btn" class="flex items-center justify-center gap-2 bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-colors" title="Invoice Archive">
                            <i data-lucide="history"></i>
                        </button>
                        <button id="show-unconfirmed-btn" class="relative flex items-center justify-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-colors" title="Unconfirmed Invoices">
                            <i id="unconfirmed-icon" data-lucide="bell"></i>
                            <span id="unconfirmed-count-badge" class="hidden absolute -top-2 -right-2 w-5 h-5 bg-red-600 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                        </button>
                        <button id="back-to-pos-btn" class="flex items-center justify-center gap-2 btn-primary py-2 px-4 rounded-lg shadow-lg"><i data-lucide="arrow-left"></i><span>Back</span></button>
                    </div>
                </div>
                <div class="mb-4 p-4 bg-gray-100 rounded-lg flex flex-col md:flex-row gap-4 items-center">
                    <div class="relative flex-grow w-full md:w-auto">
                        <input type="text" id="invoice-search-input" placeholder="Search by ID, customer name, or phone..." class="w-full p-3 pr-10 input-field"/>
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><i data-lucide="search" class="text-[var(--text-secondary)]"></i></div>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="invoice-start-date" class="text-sm font-medium text-[var(--text-secondary)] whitespace-nowrap">From:</label>
                        <input type="date" id="invoice-start-date" class="p-2 input-field">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="invoice-end-date" class="text-sm font-medium text-[var(--text-secondary)] whitespace-nowrap">To:</label>
                        <input type="date" id="invoice-end-date" class="p-2 input-field">
                    </div>
                </div>
                <div class="flex-grow bg-gray-50 rounded-lg p-6 overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="sticky top-0 bg-[var(--panel-bg)]">
                            <tr>
                                <th class="p-3 text-[var(--text-secondary)]">Invoice #</th><th class="p-3 text-[var(--text-secondary)]">Date</th><th class="p-3 text-[var(--text-secondary)]">Customer</th><th class="p-3 text-[var(--text-secondary)]">Total</th><th class="p-3 text-[var(--text-secondary)]">Paid</th><th class="p-3 text-[var(--text-secondary)]">Discount</th><th class="p-3 text-[var(--text-secondary)]">Remaining</th><th class="p-3 text-right text-[var(--text-secondary)]">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoices-list"></tbody>
                        <tfoot id="invoices-summary" class="bg-gray-200 font-bold text-[var(--text-primary)]"></tfoot>
                    </table>
                </div>
            </div>

            <div id="returns-view" class="hidden-view h-[calc(100vh-2rem)] p-6 flex-col panel view-enter-effect">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold text-[var(--text-primary)]">Returns List</h2>
                    <button id="back-to-pos-from-returns-btn" class="flex items-center justify-center gap-2 btn-primary py-2 px-4 rounded-lg shadow-lg"><i data-lucide="arrow-left"></i><span>Back</span></button>
                </div>
                <div class="mb-4 p-4 bg-gray-100 rounded-lg flex flex-col md:flex-row gap-4 items-center">
                    <div class="relative flex-grow w-full md:w-auto">
                        <input type="text" id="return-search-input" placeholder="Search by return ID, customer, or original invoice..." class="w-full p-3 pr-10 input-field"/>
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><i data-lucide="search" class="text-[var(--text-secondary)]"></i></div>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="return-start-date" class="text-sm font-medium text-[var(--text-secondary)] whitespace-nowrap">From:</label>
                        <input type="date" id="return-start-date" class="p-2 input-field">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="return-end-date" class="text-sm font-medium text-[var(--text-secondary)] whitespace-nowrap">To:</label>
                        <input type="date" id="return-end-date" class="p-2 input-field">
                    </div>
                </div>
                <div class="flex-grow bg-gray-50 rounded-lg p-6 overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="sticky top-0 bg-[var(--panel-bg)]">
                            <tr>
                                <th class="p-3 text-[var(--text-secondary)]">Return #</th>
                                <th class="p-3 text-[var(--text-secondary)]">Date</th>
                                <th class="p-3 text-[var(--text-secondary)]">Customer</th>
                                <th class="p-3 text-[var(--text-secondary)]">Original Invoice</th>
                                <th class="p-3 text-[var(--text-secondary)]">Return Value</th>
                                <th class="p-3 text-right text-[var(--text-secondary)]">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="returns-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="invoice-details-view" class="hidden-view h-[calc(100vh-2rem)] p-6 flex-col panel" dir="rtl">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold text-[var(--text-primary)]">تفاصيل الفاتورة</h2>
                    <button id="back-to-invoices-btn" class="flex items-center justify-center gap-2 btn-secondary py-2 px-4 rounded-lg"><i data-lucide="arrow-right"></i><span>العودة للقائمة</span></button>
                </div>
                <div id="invoice-details-content" class="flex-grow bg-gray-50 rounded-lg p-8 overflow-y-auto"></div>
                 <div id="invoice-details-actions" class="mt-4 flex justify-start gap-3 flex-wrap">
                </div>
            </div>

            <div id="expenses-view" class="hidden-view h-[calc(100vh-2rem)] p-6 flex-col panel view-enter-effect">
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
                     <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-orange-500 text-white rounded-xl flex items-center justify-center shadow-lg shadow-red-500/30">
                            <i data-lucide="trending-down" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800">Expenses</h2>
                            <p class="text-sm text-slate-500">Track and manage your business expenses.</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <button id="print-expenses-btn" class="flex items-center justify-center gap-2 bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-colors"><i data-lucide="printer"></i><span>Print</span></button>
                         <button id="delete-all-expenses-btn" class="flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-colors"><i data-lucide="trash-2"></i><span>Delete All</span></button>
                        <button id="back-to-pos-from-expenses-btn" class="flex items-center justify-center gap-2 btn-primary py-2 px-4 rounded-lg shadow-lg"><i data-lucide="arrow-left"></i><span>Back</span></button>
                    </div>
                </div>

                <!-- Add Expense Form -->
                <div class="mb-6 p-5 bg-slate-50/70 rounded-xl border border-slate-200/80">
                    <h3 class="text-lg font-semibold flex items-center gap-3 mb-4 text-slate-700"><i data-lucide="plus-circle" class="w-5 h-5 text-green-500"></i>Add New Expense</h4>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="expense-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <input type="text" id="expense-description" class="w-full p-3 input-field">
                            </div>
                            <div>
                                <label for="expense-type" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                <input type="text" id="expense-type" class="w-full p-3 input-field cursor-pointer" readonly placeholder="Select type...">
                            </div>
                            <div>
                                <label for="expense-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                                <input type="number" id="expense-amount" class="w-full p-3 input-field">
                            </div>
                        </div>
                        <div class="grid grid-cols-12 gap-4 items-end">
                            <div class="col-span-10">
                                <label for="expense-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                <textarea id="expense-notes" class="w-full p-3 input-field" rows="1" placeholder="Optional notes..."></textarea>
                            </div>
                            <div class="col-span-2 flex justify-end">
                                 <button id="add-expense-btn" class="w-12 h-12 btn-primary rounded-full flex items-center justify-center transition-transform transform hover:scale-110 btn-glow">
                                    <i data-lucide="plus" class="w-6 h-6"></i>
                                 </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expenses List -->
                <div class="flex-grow overflow-y-auto pr-2">
                    <div id="expenses-grid" class="space-y-3">
                        <!-- Expense items will be injected here -->
                    </div>
                </div>
            </div>
            
            <div id="inventory-view" class="hidden-view h-[calc(100vh-2rem)] p-6 flex-col panel view-enter-effect">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
                     <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 text-white rounded-xl flex items-center justify-center shadow-lg shadow-purple-500/30">
                            <i data-lucide="archive" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800">Inventory Management</h2>
                            <p class="text-sm text-slate-500">View and manage product stock.</p>
                        </div>
                    </div>
                    <button id="back-to-pos-from-inventory-btn" class="flex items-center justify-center gap-2 btn-primary py-2 px-4 rounded-lg shadow-lg"><i data-lucide="arrow-left"></i><span>Back</span></button>
                </div>

                <!-- Search and Filter -->
                <div class="mb-4">
                     <div class="relative flex-grow w-full">
                        <input type="text" id="inventory-search-input" placeholder="Search by product name or code..." class="w-full p-3 pr-10 input-field"/>
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><i data-lucide="search" class="text-[var(--text-secondary)]"></i></div>
                    </div>
                </div>

                <!-- Inventory Grid -->
                <div class="flex-grow overflow-y-auto pr-2">
                    <div id="inventory-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Inventory product cards will be injected here -->
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div id="edit-expense-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="login-panel-enter w-full max-w-md">
            <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-amber-500 text-white rounded-xl flex items-center justify-center shadow-lg shadow-orange-500/30">
                        <i data-lucide="edit-3" class="w-7 h-7"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800">Edit Expense</h3>
                        <p class="text-sm text-slate-500">Update expense details below.</p>
                    </div>
                </div>
                
                <input type="hidden" id="edit-expense-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-expense-description" class="block text-sm font-medium text-slate-600 mb-1">Description</label>
                        <input type="text" id="edit-expense-description" class="w-full p-3 input-field rounded-lg border-slate-200">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="edit-expense-type" class="block text-sm font-medium text-slate-600 mb-1">Type</label>
                            <input type="text" id="edit-expense-type" class="w-full p-3 input-field rounded-lg border-slate-200 cursor-pointer" readonly placeholder="Select type...">
                        </div>
                        <div>
                            <label for="edit-expense-amount" class="block text-sm font-medium text-slate-600 mb-1">Amount</label>
                            <input type="number" id="edit-expense-amount" class="w-full p-3 input-field rounded-lg border-slate-200">
                        </div>
                    </div>
                    <div>
                        <label for="edit-expense-notes" class="block text-sm font-medium text-slate-600 mb-1">Notes</label>
                        <textarea id="edit-expense-notes" rows="3" class="w-full p-3 input-field rounded-lg border-slate-200"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8 pt-6 border-t border-slate-200/80">
                    <button id="modal-edit-expense-cancel-btn" class="px-5 py-2.5 bg-white hover:bg-slate-50 text-slate-600 font-bold rounded-lg shadow-sm border border-slate-200 transition-all">Cancel</button>
                    <button id="modal-save-expense-btn" class="px-5 py-2.5 btn-primary rounded-lg font-bold btn-glow transform transition-transform hover:scale-105">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    <div id="expense-type-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="login-panel-enter w-full max-w-sm">
            <div class="relative panel bg-white/80 backdrop-blur-xl p-6 rounded-2xl shadow-2xl shadow-slate-300/20">
                <button id="expense-type-close-btn" class="absolute top-3 right-3 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
                <h3 class="text-xl font-bold text-slate-800 mb-4 text-center">Select Expense Type</h3>
                <div id="expense-type-list" class="grid grid-cols-2 gap-2 max-h-[50vh] overflow-y-auto">
                    <!-- Expense types will be populated here by JS -->
                </div>
                <div id="add-expense-type-section" class="mt-4 pt-4 border-t border-slate-200/80">
                    <h4 class="text-sm font-semibold text-slate-600 mb-2 text-center">Or Add a New Type</h4>
                    <div class="flex items-center gap-2">
                        <input type="text" id="new-expense-type-input" placeholder="e.g., Transportation" class="input-field w-full p-2 rounded-lg">
                        <button id="add-new-expense-type-btn" class="p-2 btn-primary rounded-lg flex-shrink-0">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-[110] p-4">
        <div class="login-panel-enter w-full max-w-sm text-center">
            <div class="relative panel bg-white/80 backdrop-blur-xl p-8 sm:p-10 rounded-2xl shadow-2xl shadow-slate-300/20">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-400 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/30">
                    <i data-lucide="info" class="w-10 h-10"></i>
                </div>
                <p id="alert-message" class="text-lg mb-8 text-slate-700 font-medium"></p>
                <button id="alert-ok-btn" class="w-full py-3 btn-primary rounded-lg btn-glow transform transition-transform hover:scale-105">OK</button>
            </div>
        </div>
    </div>
    <div id="password-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-[105] p-4">
        <div class="login-panel-enter w-full max-w-sm text-center">
            <div class="relative panel bg-white/80 backdrop-blur-xl p-8 sm:p-10 rounded-2xl shadow-2xl shadow-slate-300/20">
                <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-amber-400 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-orange-500/30">
                    <i data-lucide="key-round" class="w-10 h-10"></i>
                </div>
                <h3 id="modal-title" class="text-2xl font-bold mb-2 text-slate-800">Password Required</h3>
                <p id="modal-message" class="text-slate-500 mb-6">Please enter the password to continue.</p>
                <input type="password" id="password-input" class="w-full p-3 input-field rounded-lg text-center mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <button id="modal-cancel-btn" class="w-full py-3 bg-white hover:bg-slate-50 text-slate-600 font-bold rounded-lg shadow-sm border border-slate-200 transition-all">Cancel</button>
                    <button id="modal-confirm-btn" class="w-full py-3 btn-primary rounded-lg btn-glow transform transition-transform hover:scale-105">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-product-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="login-panel-enter w-full max-w-4xl">
            <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20 max-h-[90vh] flex flex-col">
                <div class="flex-shrink-0 flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-400 text-white rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/30">
                        <i data-lucide="package-plus" class="w-7 h-7"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800">Edit Product</h3>
                        <p class="text-sm text-slate-500">Update product details below.</p>
                    </div>
                </div>
                
                <input type="hidden" id="edit-product-id">
                
                <div class="flex-grow overflow-y-auto pr-4 -mr-4 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <!-- Left Column -->
                        <div class="space-y-4">
                            <!-- Product Name -->
                            <div>
                                <label for="edit-product-name" class="block text-sm font-medium text-slate-600 mb-1">Product Name</label>
                                <div class="relative">
                                    <i data-lucide="package" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                                    <input type="text" id="edit-product-name" class="w-full p-3 pl-10 input-field rounded-lg border-slate-200">
                                </div>
                            </div>
                            
                            <!-- Stock Management -->
                            <div class="grid grid-cols-2 gap-4 items-end">
                                <div>
                                    <label for="edit-product-quantity" class="block text-sm font-medium text-slate-600 mb-1">On-Hand</label>
                                    <div class="relative">
                                        <i data-lucide="boxes" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                                        <input type="number" id="edit-product-quantity" class="w-full p-3 pl-10 input-field rounded-lg border-slate-200">
                                    </div>
                                </div>
                                <div class="pb-1">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="edit-unlimited-stock-checkbox" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        <span class="ms-3 text-sm font-medium text-slate-600">Unlimited</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="space-y-4">
                            <!-- Pricing details -->
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label for="edit-product-purchase-price" class="block text-sm font-medium text-slate-600 mb-1">Purchase</label>
                                    <input type="number" id="edit-product-purchase-price" class="w-full p-3 input-field rounded-lg border-slate-200">
                                </div>
                                <div>
                                    <label for="edit-product-profit-margin" class="block text-sm font-medium text-slate-600 mb-1">Profit %</label>
                                    <input type="number" id="edit-product-profit-margin" class="w-full p-3 input-field rounded-lg border-slate-200">
                                </div>
                                <div>
                                    <label for="edit-product-price" class="block text-sm font-medium text-slate-600 mb-1">Selling</label>
                                    <input type="number" id="edit-product-price" class="w-full p-3 input-field rounded-lg border-slate-200 font-bold bg-slate-100">
                                </div>
                            </div>
                            
                            <!-- Discount -->
                            <div>
                                <label for="edit-product-discount" class="block text-sm font-medium text-slate-600 mb-1">Discount (%)</label>
                                <div class="relative">
                                    <i data-lucide="percent" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                                    <input type="number" id="edit-product-discount" placeholder="e.g., 15" class="w-full p-3 pl-10 input-field rounded-lg border-slate-200">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Codes -->
                    <div class="pt-6 border-t border-slate-200/80">
                        <label class="block text-sm font-medium text-slate-600 mb-2">Product Codes/Variations</label>
                        <div id="product-codes-list" class="space-y-3 mb-4 max-h-48 overflow-y-auto pr-2">
                            <!-- Existing codes will be listed here -->
                        </div>
                        <div class="bg-slate-50/70 p-4 rounded-xl border border-slate-200/80">
                            <h5 class="text-sm font-semibold flex items-center gap-2 mb-3 text-slate-600">
                                <i data-lucide="plus-circle" class="w-4 h-4 text-green-500"></i>
                                <span>Add New Variation</span>
                            </h5>
                            <div class="flex flex-col md:flex-row items-start md:items-end gap-3">
                                <div class="w-full md:w-1/4">
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Variation Name / Code</label>
                                    <input type="text" id="new-product-code-input" placeholder="e.g., L, Blue, #12345" class="w-full p-2 input-field rounded-lg text-sm">
                                </div>
                                <div class="w-full flex-grow grid grid-cols-2 md:grid-cols-5 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Purchase</label>
                                        <input type="number" id="new-product-code-purchase-price" placeholder="0.00" class="w-full p-2 input-field rounded-lg text-sm">
                                    </div>
                                    <div>
                                         <label class="block text-xs font-medium text-slate-500 mb-1">Profit %</label>
                                        <input type="number" id="new-product-code-profit-margin" placeholder="25" class="w-full p-2 input-field rounded-lg text-sm">
                                    </div>
                                    <div>
                                         <label class="block text-xs font-medium text-slate-500 mb-1">Selling</label>
                                        <input type="number" id="new-product-code-price" placeholder="0.00" class="w-full p-2 input-field rounded-lg text-sm font-bold bg-slate-200">
                                    </div>
                                    <div>
                                         <label class="block text-xs font-medium text-slate-500 mb-1">Qty</label>
                                        <input type="number" id="new-product-code-quantity" placeholder="0" class="w-full p-2 input-field rounded-lg text-sm">
                                    </div>
                                    <div>
                                         <label class="block text-xs font-medium text-slate-500 mb-1">Disc. %</label>
                                        <input type="number" id="new-product-code-discount" placeholder="10" class="w-full p-2 input-field rounded-lg text-sm">
                                    </div>
                                </div>
                                <div class="w-full md:w-auto flex-shrink-0">
                                    <button id="add-product-code-btn" class="w-full md:w-auto h-full flex items-center justify-center gap-2 p-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                        <span class="hidden md:inline">Add</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0 flex justify-between items-center mt-8 pt-6 border-t border-slate-200/80">
                    <button id="modal-delete-product-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg flex items-center gap-2 font-semibold transition-all transform hover:scale-105">
                        <i data-lucide="trash-2" class="h-4 w-4"></i><span>Delete</span>
                    </button>
                    <div class="flex gap-4">
                        <button id="modal-edit-cancel-btn" class="px-5 py-2.5 bg-white hover:bg-slate-50 text-slate-600 font-bold rounded-lg shadow-sm border border-slate-200 transition-all">Cancel</button>
                        <button id="modal-save-btn" class="px-5 py-2.5 btn-primary rounded-lg font-bold btn-glow transform transition-transform hover:scale-105">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-product-code-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-[55] p-4">
        <div class="login-panel-enter w-full max-w-lg">
            <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 text-white rounded-xl flex items-center justify-center shadow-lg shadow-purple-500/30">
                        <i data-lucide="edit" class="w-7 h-7"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800">Edit Variation</h3>
                        <p class="text-sm text-slate-500">Update variation details below.</p>
                    </div>
                </div>
                
                <input type="hidden" id="edit-product-code-original-code">
                
                <div class="space-y-4">
                    <div>
                        <label for="edit-code-name-input" class="block text-sm font-medium text-slate-600 mb-1">Variation Name / Code</label>
                        <input type="text" id="edit-code-name-input" class="w-full p-3 input-field rounded-lg border-slate-200">
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label for="edit-code-purchase-price" class="block text-sm font-medium text-slate-600 mb-1">Purchase</label>
                            <input type="number" id="edit-code-purchase-price" class="w-full p-3 input-field rounded-lg border-slate-200">
                        </div>
                        <div>
                            <label for="edit-code-profit-margin" class="block text-sm font-medium text-slate-600 mb-1">Profit %</label>
                            <input type="number" id="edit-code-profit-margin" class="w-full p-3 input-field rounded-lg border-slate-200">
                        </div>
                        <div>
                            <label for="edit-code-price" class="block text-sm font-medium text-slate-600 mb-1">Selling</label>
                            <input type="number" id="edit-code-price" class="w-full p-3 input-field rounded-lg border-slate-200 font-bold bg-slate-100">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="edit-code-quantity" class="block text-sm font-medium text-slate-600 mb-1">Quantity</label>
                            <input type="number" id="edit-code-quantity" class="w-full p-3 input-field rounded-lg border-slate-200">
                        </div>
                        <div>
                            <label for="edit-code-discount" class="block text-sm font-medium text-slate-600 mb-1">Discount %</label>
                            <input type="number" id="edit-code-discount" class="w-full p-3 input-field rounded-lg border-slate-200">
                        </div>
                    </div>
                </div>
    
                <div class="flex justify-end gap-4 mt-8 pt-6 border-t border-slate-200/80">
                    <button id="modal-edit-code-cancel-btn" class="px-5 py-2.5 bg-white hover:bg-slate-50 text-slate-600 font-bold rounded-lg shadow-sm border border-slate-200 transition-all">Cancel</button>
                    <button id="modal-save-code-btn" class="px-5 py-2.5 btn-primary rounded-lg font-bold btn-glow transform transition-transform hover:scale-105">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="login-panel-enter w-full max-w-lg">
             <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20">
                <button id="settings-close-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                 <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-500 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-indigo-500/30">
                    <i data-lucide="shield-check" class="w-10 h-10"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800 mb-2 text-center">Owner Settings</h3>
                <p class="text-slate-500 mb-6 text-center">Manage system access and security.</p>
                
                <div class="space-y-6 text-left max-h-[60vh] overflow-y-auto p-1 pr-3">
                    <!-- Session Management -->
                    <div class="bg-slate-50/70 p-4 rounded-xl border border-slate-200/80">
                        <h4 class="font-bold text-slate-700 flex items-center gap-3 mb-2"><i data-lucide="users" class="w-5 h-5 text-green-500"></i>Account Session Control</h4>
                        <p class="text-sm text-slate-500 mb-4">Manage login duration for authorized users.</p>
                        
                        <label for="authorized-accounts-select" class="block text-sm font-medium text-slate-600 mb-1">Authorized Account:</label>
                        <select id="authorized-accounts-select" class="input-field p-3 rounded-lg w-full border-slate-200"></select>

                        <div id="session-controls" class="hidden mt-4 space-y-3"> 
                            <label class="block text-sm font-medium text-slate-600">Set Session Expiration:</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="account-logout-duration-value" class="input-field w-full p-3 rounded-lg text-center border-slate-200" placeholder="e.g., 30">
                                <select id="account-logout-duration-unit" class="input-field p-3 rounded-lg border-slate-200">
                                    <option value="minutes">Minutes</option>
                                    <option value="hours">Hours</option>
                                    <option value="days">Days</option>
                                    <option value="months">Months</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3 pt-2">
                                 <button id="save-account-session-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all transform hover:scale-105 font-semibold"><i data-lucide="check-circle" class="w-4 h-4"></i>Set Duration</button>
                                 <button id="cancel-account-session-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all transform hover:scale-105 font-semibold"><i data-lucide="x-circle" class="w-4 h-4"></i>Expire Now</button>
                            </div>
                             <p id="session-status-message" class="text-xs text-center mt-2 h-4 font-medium"></p>
                        </div>
                    </div>
                    
                     <!-- Maintenance Mode -->
                    <div class="bg-slate-50/70 p-4 rounded-xl border border-slate-200/80">
                        <h4 class="font-bold text-slate-700 flex items-center gap-3 mb-2"><i data-lucide="server-off" class="w-5 h-5 text-amber-500"></i>Maintenance Mode</h4>
                        <p class="text-sm text-slate-500 mb-4">Temporarily disable access to the app for all users.</p>
                        <div class="flex items-center justify-between mb-4">
                            <label for="maintenance-mode-toggle" class="font-medium text-slate-600">Enable Maintenance Mode</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="maintenance-mode-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                            </label>
                        </div>
                        <div id="maintenance-message-controls" class="hidden">
                            <label for="maintenance-message-input" class="block text-sm font-medium text-slate-600 mb-1">Custom Message</label>
                            <textarea id="maintenance-message-input" class="input-field w-full p-3 rounded-lg border-slate-200" rows="3"></textarea>
                            <button id="save-maintenance-settings-btn" class="w-full mt-3 px-5 py-3 bg-slate-700 text-white rounded-lg hover:bg-slate-800 transition-all transform hover:scale-105 font-semibold">Save Settings</button>
                        </div>
                    </div>

                    <!-- Owner Password -->
                    <div class="bg-slate-50/70 p-4 rounded-xl border border-slate-200/80">
                        <h4 class="font-bold text-slate-700 flex items-center gap-3 mb-2"><i data-lucide="key-round" class="w-5 h-5 text-orange-500"></i>Manager Password</h4>
                        <p class="text-sm text-slate-500 mb-4">Set the password used to enable manager mode.</p>
                        <div class="flex items-center gap-3">
                            <input type="text" id="worker-password-input" placeholder="Enter New Password" class="input-field w-full p-3 rounded-lg border-slate-200">
                            <button id="save-worker-password-btn" class="px-5 py-3 bg-slate-700 text-white rounded-lg hover:bg-slate-800 transition-all transform hover:scale-105 font-semibold">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="worker-permissions-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="login-panel-enter w-full max-w-3xl">
             <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20 max-h-[90vh] flex flex-col">
                <button id="permissions-close-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                 <div class="flex-shrink-0 flex items-center gap-4 mb-6 pb-4 border-b border-slate-200/80">
                     <div class="w-16 h-16 bg-gradient-to-br from-teal-500 to-cyan-500 text-white rounded-3xl flex items-center justify-center shadow-lg shadow-teal-500/30">
                        <i data-lucide="user-cog" class="w-10 h-10"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800">Manager Settings</h3>
                        <p class="text-sm text-slate-500">Manage cashier profiles and data access.</p>
                    </div>
                </div>

                <div class="flex-grow space-y-6 text-left overflow-y-auto pr-3 p-1">
                    <!-- Cashier Profiles Section -->
                    <div class="bg-slate-50/70 p-5 rounded-xl border border-slate-200/80">
                        <button id="open-cashier-profiles-btn" class="w-full text-left transition-all p-2 -m-2 rounded-lg hover:bg-slate-200/60">
                            <h4 class="text-lg font-semibold flex items-center justify-between text-slate-700">
                                <span class="flex items-center gap-3"><i data-lucide="users" class="w-5 h-5 text-teal-500"></i>Cashier Profiles</span>
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </h4>
                            <p class="text-sm text-slate-500 mt-1 pl-8">Manage cashier accounts, codes, and activation keys.</p>
                        </button>
                    </div>

                    <!-- System Lock Section -->
                    <div class="bg-slate-50/70 p-5 rounded-xl border border-slate-200/80">
                        <h4 class="text-lg font-semibold flex items-center gap-3 mb-4 text-slate-700"><i data-lucide="clock" class="w-5 h-5 text-indigo-500"></i>System Lock Schedule</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <label for="system-lock-enabled-toggle" class="font-medium text-slate-600">Enable Automatic Lock</label>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="system-lock-enabled-toggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div id="system-lock-times-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="system-lock-time-input" class="block text-sm font-medium text-gray-700 mb-1">Lock Time</label>
                                    <input type="time" id="system-lock-time-input" class="w-full p-3 input-field">
                                </div>
                                <div>
                                    <label for="system-unlock-time-input" class="block text-sm font-medium text-gray-700 mb-1">Unlock Time</label>
                                    <input type="time" id="system-unlock-time-input" class="w-full p-3 input-field">
                                </div>
                            </div>
                        </div>
                    </div>
        
                    <!-- Data Management Section -->
                    <div class="mt-6 pt-6 border-t border-slate-200/80">
                        <button id="open-danger-zone-btn" class="w-full flex items-center justify-center gap-3 py-3 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-semibold transition-colors">
                            <i data-lucide="shield-alert" class="w-5 h-5"></i>
                            <span>Danger Zone</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="cashier-profiles-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-[60] p-4">
        <div class="login-panel-enter w-full max-w-3xl">
             <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20 max-h-[90vh] flex flex-col">
                <button id="cashier-profiles-close-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                 <div class="flex-shrink-0 flex items-center gap-4 mb-6 pb-4 border-b border-slate-200/80">
                     <div class="w-16 h-16 bg-gradient-to-br from-teal-500 to-cyan-500 text-white rounded-3xl flex items-center justify-center shadow-lg shadow-teal-500/30">
                        <i data-lucide="users" class="w-10 h-10"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800">Cashier Profiles</h3>
                        <p class="text-sm text-slate-500">Manage cashier accounts, codes, and activation keys.</p>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto pr-3 p-1">
                    <div class="bg-slate-50/70 p-5 rounded-xl border border-slate-200/80">
                        <h4 class="text-lg font-semibold flex items-center gap-3 mb-4 text-slate-700"><i data-lucide="users" class="w-5 h-5 text-teal-500"></i>Cashier Profiles</h4>
                        <div id="cashier-profiles-list" class="space-y-3 mb-6">
                            <!-- Cashier items will be injected here -->
                        </div>
                        <div class="p-4 bg-white/50 rounded-lg mt-4 border border-slate-200/60">
                            <h5 class="font-bold mb-3 text-base text-slate-600">Add New Cashier</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-slate-500 mb-1 block">Seller Name</label>
                                    <div class="relative"><i data-lucide="user" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i><input type="text" id="new-cashier-name" placeholder="e.g., John Doe" class="input-field p-3 pl-10 w-full rounded-lg border-slate-200"></div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-slate-500 mb-1 block">Cashier Code</label>
                                    <div class="relative"><i data-lucide="hash" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i><input type="text" id="new-cashier-code" placeholder="e.g., 007" class="input-field p-3 pl-10 w-full rounded-lg border-slate-200"></div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-slate-500 mb-1 block">Activation Key</label>
                                    <div class="relative"><i data-lucide="key-round" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i><input type="text" id="new-cashier-key" placeholder="e.g., 1234" class="input-field p-3 pl-10 w-full rounded-lg border-slate-200"></div>
                                </div>
                            </div>
                            <button id="add-cashier-btn" class="btn-primary py-3 rounded-lg w-full mt-4 flex items-center justify-center gap-2 btn-glow transform transition-transform hover:scale-105"><i data-lucide="plus-circle" class="w-5 h-5"></i>Add Cashier</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="danger-zone-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-[55] p-4">
        <div class="login-panel-enter w-full max-w-2xl">
             <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20">
                <button id="danger-zone-close-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                 <div class="flex-shrink-0 flex items-center gap-4 mb-6 pb-4 border-b border-red-200/80">
                     <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-orange-500 text-white rounded-3xl flex items-center justify-center shadow-lg shadow-red-500/30">
                        <i data-lucide="shield-alert" class="w-10 h-10"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-red-700">Danger Zone</h3>
                        <p class="text-sm text-slate-500">Sensitive and irreversible actions.</p>
                    </div>
                </div>
                <div class="bg-red-50/50 p-5 rounded-xl border border-red-200/80">
                    <h4 class="text-lg font-semibold flex items-center gap-3 mb-2 text-red-800"><i data-lucide="alert-triangle" class="w-5 h-5"></i>Permanent Data Deletion</h4>
                    <p class="text-sm text-red-700/90 mb-4">These actions are irreversible and will permanently delete data. Proceed with extreme caution.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button id="owner-delete-all-invoices-btn" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-semibold transition-colors"><i data-lucide="file-x" class="w-5 h-5"></i>Delete All Invoices</button>
                        <button id="owner-delete-all-returns-btn" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-semibold transition-colors"><i data-lucide="archive-restore" class="w-5 h-5"></i>Delete All Returns</button>
                        <button id="owner-delete-archive-btn" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-semibold transition-colors"><i data-lucide="archive-x" class="w-5 h-5"></i>Delete Archive</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="invoice-customization-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="login-panel-enter w-full max-w-lg">
             <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20">
                <button id="invoice-customization-close-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                 <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-400 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/30">
                    <i data-lucide="file-cog" class="w-10 h-10"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800 mb-2 text-center">Invoice Customization</h3>
                <p class="text-slate-500 mb-6 text-center">Adjust the details that appear on printed invoices.</p>
                <div class="space-y-4 text-left max-h-[60vh] overflow-y-auto p-1 pr-3">
                    <div>
                        <label for="invoice-shop-name-input" class="block text-sm font-medium text-slate-600 mb-1 flex items-center gap-2"><i data-lucide="store" class="w-4 h-4"></i>Shop Name</label>
                        <input type="text" id="invoice-shop-name-input" class="w-full p-3 input-field rounded-lg border-slate-200" placeholder="e.g., Badrly">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="invoice-branch-info-input" class="block text-sm font-medium text-slate-600 mb-1 flex items-center gap-2"><i data-lucide="map" class="w-4 h-4"></i>Branch Info</label>
                            <input type="text" id="invoice-branch-info-input" class="w-full p-3 input-field rounded-lg border-slate-200" placeholder="e.g., 63511 Saad Zaghloul">
                        </div>
                        <div>
                            <label for="invoice-machine-number-input" class="block text-sm font-medium text-slate-600 mb-1 flex items-center gap-2"><i data-lucide="printer" class="w-4 h-4"></i>Machine Number</label>
                        <input type="text" id="invoice-machine-number-input" class="w-full p-3 input-field rounded-lg border-slate-200" placeholder="e.g., LPQ80-ESC">
                    </div>
                </div>
                <div>
                    <label for="invoice-address-input" class="block text-sm font-medium text-slate-600 mb-1 flex items-center gap-2"><i data-lucide="map-pin" class="w-4 h-4"></i>Invoice Address</label>
                    <textarea id="invoice-address-input" rows="3" class="w-full p-3 input-field rounded-lg border-slate-200" placeholder="Enter the address that will appear on the invoice..."></textarea>
                </div>
                <div>
                    <label for="invoice-contact-number-input" class="block text-sm font-medium text-slate-600 mb-1 flex items-center gap-2"><i data-lucide="phone" class="w-4 h-4"></i>Contact Number</label>
                    <input type="text" id="invoice-contact-number-input" class="w-full p-3 input-field rounded-lg border-slate-200" placeholder="e.g., 01012345678">
                </div>
                <div>
                    <label for="return-policy-input" class="block text-sm font-medium text-slate-600 mb-1 flex items-center gap-2"><i data-lucide="file-text" class="w-4 h-4"></i>Invoice Return Policy</label>
                    <textarea id="return-policy-input" rows="3" class="w-full p-3 input-field rounded-lg border-slate-200" placeholder="Enter the return and exchange policy that will appear on the invoice..."></textarea>
                </div>
                     <div class="pt-4 border-t mt-4">
                        <label class="block text-sm font-medium text-slate-600 mb-1 flex items-center gap-2"><i data-lucide="barcode" class="w-4 h-4"></i>Barcode Settings</label>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                 <label for="invoice-facebook-link-input" class="block text-xs font-medium text-slate-500 mb-1">Facebook Page Link</label>
                                <input type="text" id="invoice-facebook-link-input" class="w-full p-3 input-field rounded-lg border-slate-200" placeholder="https://facebook.com/page">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                    <button id="invoice-customization-save-btn" class="w-full flex items-center justify-center gap-2 btn-primary py-3 rounded-lg shadow-lg btn-glow transform transition-transform hover:scale-105">
                        <i data-lucide="check-circle"></i><span>Save and Close</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="help-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-[210] p-4">
        <div class="login-panel-enter w-full max-w-lg text-center">
             <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20">
                <button id="help-close-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                 <div class="w-16 h-16 bg-gradient-to-br from-amber-500 to-orange-400 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-orange-500/30">
                    <i data-lucide="life-buoy" class="w-10 h-10"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800 mb-2">Help & Support</h3>
                <p class="text-slate-500 mb-6">Having trouble? Send us a message and we'll get back to you.</p>
                <div class="space-y-4 text-left">
                    <div>
                        <label for="complaint-email" class="block text-sm font-medium text-slate-600 mb-1">Your Email (for contact)</label>
                        <input type="email" id="complaint-email" class="w-full p-3 input-field rounded-lg border-slate-200" placeholder="you@example.com">
                    </div>
                    <div>
                        <label for="complaint-message" class="block text-sm font-medium text-slate-600 mb-1">Your Message</label>
                        <textarea id="complaint-message" rows="5" class="w-full p-3 input-field rounded-lg border-slate-200" placeholder="Describe your issue or suggestion..."></textarea>
                    </div>
                </div>
                <div class="mt-6">
                    <button id="send-complaint-btn" class="w-full flex items-center justify-center gap-2 btn-primary py-3 rounded-lg shadow-lg btn-glow transform transition-transform hover:scale-105">
                        <i data-lucide="send"></i><span>Send Message</span>
                    </button>
                </div>
                <div class="mt-4 text-center text-xs text-slate-500">
                    or contact us via the <a href="http://badre.site/" target="_blank" class="font-semibold text-sky-500 hover:text-sky-600 transition-colors">website</a>
                </div>
            </div>
        </div>
    </div>
    <div id="customers-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="login-panel-enter w-full max-w-2xl">
             <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20 h-[80vh] flex flex-col">
                <button id="customers-close-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <div class="flex-shrink-0 flex items-center gap-4 mb-6">
                     <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-400 text-white rounded-3xl flex items-center justify-center shadow-lg shadow-green-500/30">
                        <i data-lucide="users-2" class="w-10 h-10"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800">Customer Database</h3>
                        <p class="text-sm text-slate-500">Search and manage customer information.</p>
                    </div>
                </div>
                <div class="relative mb-4 flex-shrink-0">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"></i>
                    <input type="text" id="customer-search-input" placeholder="Search by name or phone..." class="w-full p-3 pl-12 input-field rounded-lg border-slate-200"/>
                </div>
                <div class="flex-grow overflow-y-auto bg-slate-50/70 rounded-lg p-2 border border-slate-200/80">
                    <div id="customers-list" class="grid grid-cols-1 gap-2">
                        <!-- Customer items will be injected here -->
                    </div>
                </div>
                <div class="mt-6 flex-shrink-0">
                    <button id="download-customers-btn" class="w-full flex items-center justify-center gap-2 btn-primary py-3 rounded-lg shadow-lg btn-glow transform transition-transform hover:scale-105">
                        <i data-lucide="download"></i><span>Download as Excel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="reports-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="login-panel-enter w-full max-w-5xl">
            <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20 h-[90vh] flex flex-col">
                <button id="reports-close-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <div class="flex-shrink-0 flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-fuchsia-500 text-white rounded-3xl flex items-center justify-center shadow-lg shadow-purple-500/30">
                        <i data-lucide="file-check-2" class="w-10 h-10"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800">Sales Reports</h3>
                        <p class="text-sm text-slate-500">Generate coordinated and relevant sales reports.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4 p-4 bg-slate-50/70 rounded-lg border border-slate-200/80 flex-shrink-0">
                    <div class="md:col-span-1">
                        <label for="report-type-select" class="block text-sm font-medium text-slate-600 mb-1">Report Type</label>
                        <select id="report-type-select" class="w-full p-3 input-field rounded-lg border-slate-200">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div id="report-start-date-picker" class="md:col-span-1">
                        <label for="report-date-input" id="report-start-date-label" class="block text-sm font-medium text-slate-600 mb-1">Select Date</label>
                        <input type="date" id="report-date-input" class="w-full p-2.5 input-field rounded-lg border-slate-200">
                    </div>
                     <div id="report-end-date-picker" class="md:col-span-1 hidden">
                        <label for="report-end-date-input" class="block text-sm font-medium text-slate-600 mb-1">End Date</label>
                        <input type="date" id="report-end-date-input" class="w-full p-2.5 input-field rounded-lg border-slate-200">
                    </div>
                    <div class="md:col-span-1">
                         <button id="generate-report-btn" class="w-full flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-800 text-white font-semibold py-3 rounded-lg shadow-lg transition-all transform hover:scale-105">
                            <i data-lucide="file-check"></i><span>Generate</span>
                        </button>
                    </div>
                </div>
                <div id="report-content" class="flex-grow overflow-y-auto bg-white p-6 rounded-lg border border-slate-200/80" style="font-family: var(--font-receipt);">
                    <div class="flex items-center justify-center h-full text-slate-500">
                        <p>Select a report type and date range to generate a report.</p>
                    </div>
                </div>
                <div class="mt-6 flex-shrink-0">
                    <button id="print-report-btn" class="w-full flex items-center justify-center gap-2 btn-primary py-3 rounded-lg shadow-lg btn-glow transform transition-transform hover:scale-105" disabled>
                        <i data-lucide="printer"></i><span>Print Report</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="reauth-confirm-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-[105] p-4">
        <div class="login-panel-enter w-full max-w-sm text-center">
            <div class="relative panel bg-white/80 backdrop-blur-xl p-8 sm:p-10 rounded-2xl shadow-2xl shadow-slate-300/20">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-400 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/30">
                    <i data-lucide="shield-check" class="h-10 w-10"></i>
                </div>
                <h3 class="text-2xl font-bold mb-2 text-slate-800">Confirm Identity</h3>
                <p class="text-slate-500 mb-8">For security, a Google pop-up will open to re-verify your account.</p>
                <div class="grid grid-cols-2 gap-4">
                    <button id="reauth-cancel-btn" class="w-full py-3 bg-white hover:bg-slate-50 text-slate-600 font-bold rounded-lg shadow-sm border border-slate-200 transition-all">Cancel</button>
                    <button id="reauth-confirm-btn" class="w-full py-3 btn-primary rounded-lg flex items-center justify-center gap-2 btn-glow transform transition-transform hover:scale-105">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.657-3.356-11.303-7.962l-6.571,4.819C9.656,39.663,16.318,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.021,35.596,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                        Continue
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="developer-info-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center z-50 p-4">
        <div class="login-panel-enter w-full max-w-4xl">
            <div class="relative panel bg-slate-50/80 backdrop-blur-2xl rounded-2xl shadow-2xl flex flex-col md:flex-row overflow-hidden max-h-[90vh]">
                <button id="developer-info-close-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-500 bg-white/50 hover:bg-slate-200/80 transition-colors z-10">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <!-- Left Column -->
                <div class="w-full md:w-1/3 bg-white/40 p-8 flex flex-col items-center justify-center text-center border-r border-slate-200/60">
                    <img src="https://i.ibb.co/gZLR0jJd/5990e47e-caab-4e0a-ab8c-4ebd601a9bb7.jpg" alt="Developer Picture" class="w-32 h-32 rounded-full mb-4 ring-4 ring-white/60 shadow-lg">
                    <h3 class="text-2xl font-bold text-slate-800">Badr Ibrahim Mohamed</h3>
                    <p class="text-slate-500 mt-1 font-semibold">Graphic & Software Designer</p>
                    <div class="mt-4 pt-4 border-t border-slate-200/80 w-full text-sm text-slate-600 space-y-2">
                         <a href="tel:+201069913150" class="flex items-center justify-center gap-2 hover:text-sky-600 transition-colors">
                            <i data-lucide="phone" class="w-4 h-4"></i>
                            <span>+201069913150</span>
                        </a>
                        <a href="mailto:bdr.e.mohameed@gmail.com" class="flex items-center justify-center gap-2 hover:text-sky-600 transition-colors">
                            <i data-lucide="mail" class="w-4 h-4"></i>
                            <span>bdr.e.mohameed@gmail.com</span>
                        </a>
                    </div>
                    <div class="flex items-center justify-center flex-wrap gap-3 mt-6">
                        <a href="https://badre.site/" target="_blank" class="p-3 bg-white/70 rounded-full text-sky-800 hover:bg-sky-500 hover:text-white transition-all transform hover:scale-110 shadow-md" title="Portfolio">
                           <i data-lucide="globe" class="w-6 h-6"></i>
                        </a>
                        <a href="https://www.facebook.com/bdr.e.mohmed" target="_blank" class="p-3 bg-white/70 rounded-full text-slate-600 hover:bg-blue-600 hover:text-white transition-colors" title="Facebook">
                           <svg class="w-6 h-6" role="img" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                        </a>
                        <a href="https://www.instagram.com/bdr_e_mohamed" target="_blank" class="p-3 bg-white/70 rounded-full text-slate-600 hover:bg-pink-600 hover:text-white transition-colors" title="Instagram">
                            <i data-lucide="instagram" class="w-6 h-6"></i>
                        </a>
                        <a href="https://github.com/bdremohameed" target="_blank" class="p-3 bg-white/70 rounded-full text-slate-600 hover:bg-gray-800 hover:text-white transition-colors" title="GitHub">
                            <i data-lucide="github" class="w-6 h-6"></i>
                        </a>
                   </div>
                </div>

                <!-- Right Column -->
                <div class="w-full md:w-2/3 p-8 relative overflow-y-auto">
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-bold text-slate-800 flex items-center gap-3 mb-3 text-xl">
                                <i data-lucide="user-round" class="w-6 h-6 text-sky-500"></i>
                                <span>About Me</span>
                            </h4>
                            <p class="text-slate-600 leading-relaxed">
                                Creative graphic designer and software developer from Faiyum, Egypt with over 3 years of experience in print and digital advertising. Skilled in using 3D elements, Adobe Creative Suite, and modern web technologies to deliver high-quality, impactful visual projects and user experiences.
                            </p>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-slate-800 flex items-center gap-3 mb-4 text-xl">
                                <i data-lucide="sparkles" class="w-6 h-6 text-green-500"></i>
                                <span>My Services</span>
                            </h4>
                            <ul class="space-y-2 text-slate-600">
                                <li class="flex items-center gap-3"><i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i><span>Software Systems Design</span></li>
                                <li class="flex items-center gap-3"><i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i><span>Database Management</span></li>
                                <li class="flex items-center gap-3"><i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i><span>Sales and Inventory Reports</span></li>
                                <li class="flex items-center gap-3"><i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i><span>Technical Support & System Updates</span></li>
                                <li class="flex items-center gap-3"><i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i><span>Data Security & System Protection</span></li>
                            </ul>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-slate-800 flex items-center gap-3 mb-4 text-xl">
                                <i data-lucide="layers" class="w-6 h-6 text-purple-500"></i>
                                <span>Skills & Technologies</span>
                            </h4>
                            <div class="space-y-4">
                                <div>
                                     <h5 class="font-semibold text-slate-500 mb-2">Programming Languages</h5>
                                     <div class="flex flex-wrap gap-2">
                                        <span class="bg-purple-100 text-purple-800 text-sm font-medium px-3 py-1 rounded-full">JavaScript</span>
                                        <span class="bg-purple-100 text-purple-800 text-sm font-medium px-3 py-1 rounded-full">SQL</span>
                                        <span class="bg-purple-100 text-purple-800 text-sm font-medium px-3 py-1 rounded-full">C#</span>
                                        <span class="bg-purple-100 text-purple-800 text-sm font-medium px-3 py-1 rounded-full">PHP</span>
                                    </div>
                                </div>
                                 <div>
                                     <h5 class="font-semibold text-slate-500 mb-2">Software Used</h5>
                                     <div class="flex flex-wrap gap-2">
                                        <span class="bg-sky-100 text-sky-800 text-sm font-medium px-3 py-1 rounded-full">Visual Studio</span>
                                        <span class="bg-sky-100 text-sky-800 text-sm font-medium px-3 py-1 rounded-full">MySQL / SQL Server</span>
                                        <span class="bg-sky-100 text-sky-800 text-sm font-medium px-3 py-1 rounded-full">Firebase</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="unconfirmed-invoices-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="login-panel-enter w-full max-w-5xl">
             <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20 h-[80vh] flex flex-col">
                <button id="unconfirmed-invoices-close-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <div class="flex-shrink-0 flex items-center gap-4 mb-6">
                     <div class="w-16 h-16 bg-gradient-to-br from-yellow-500 to-orange-400 text-white rounded-3xl flex items-center justify-center shadow-lg shadow-yellow-500/30">
                        <i data-lucide="clipboard-check" class="w-10 h-10"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800">Unconfirmed Invoices</h3>
                        <p class="text-sm text-slate-500">Confirm or cancel recent transactions.</p>
                    </div>
                </div>
                <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 overflow-hidden">
                    <div class="flex flex-col h-full overflow-y-auto bg-slate-50/70 rounded-lg p-2 border border-slate-200/80">
                        <div id="unconfirmed-invoices-list" class="space-y-3">
                            <!-- Unconfirmed invoices will be injected here -->
                        </div>
                    </div>
                    <div id="unconfirmed-invoice-details" class="bg-white rounded-lg p-4 border border-slate-200 overflow-y-auto">
                        <div class="flex items-center justify-center h-full text-slate-400">
                            <p>Select an invoice to view details.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="invoice-archive-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="login-panel-enter w-full max-w-3xl">
             <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20 h-[80vh] flex flex-col">
                <button id="invoice-archive-close-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <div class="flex-shrink-0 flex items-center gap-4 mb-6">
                     <div class="w-16 h-16 bg-gradient-to-br from-slate-500 to-gray-600 text-white rounded-3xl flex items-center justify-center shadow-lg shadow-slate-500/30">
                        <i data-lucide="history" class="w-10 h-10"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-800">Invoice Archive</h3>
                        <p class="text-sm text-slate-500">A log of all invoice activities.</p>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto bg-slate-50/70 rounded-lg p-2 border border-slate-200/80">
                    <div id="invoice-archive-list" class="space-y-2">
                        <!-- Archive items will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="archive-details-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-[60] p-4">
        <div class="login-panel-enter w-full max-w-md">
            <div class="relative panel bg-white/80 backdrop-blur-xl p-1 rounded-2xl shadow-2xl shadow-slate-300/20 max-h-[90vh] flex flex-col">
                <button id="archive-details-close-btn" class="absolute top-3 right-3 p-2 rounded-full text-slate-400 bg-white/50 hover:bg-slate-100 hover:text-slate-600 transition-colors z-10">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <div id="archive-details-content" class="flex-grow overflow-y-auto rounded-2xl">
                    <!-- Details will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <div id="system-lock-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center z-[100] p-4">
        <div class="login-panel-enter w-full max-w-lg text-center">
            <div class="relative panel bg-white/90 backdrop-blur-xl p-8 sm:p-12 rounded-2xl shadow-2xl shadow-slate-300/20">
                <div class="w-20 h-20 bg-gradient-to-br from-red-500 to-orange-500 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-red-500/30">
                    <i data-lucide="clock" class="w-12 h-12"></i>
                </div>
                <h3 class="text-3xl font-bold text-slate-800 mb-2">System Locked</h3>
                <p id="system-lock-message" class="text-slate-600 text-lg">The system is currently locked for the day. Access will be restored automatically at the scheduled time.</p>

                <div class="mt-8 pt-6 border-t border-slate-200/60">
                    <p class="text-sm text-slate-500 mb-4">For exceptional access, click below to log in as a manager.</p>
                    <button id="lock-override-prompt-btn" class="w-full px-5 py-3 btn-primary rounded-lg font-semibold btn-glow transform transition-transform hover:scale-105">Manager Override</button>
                </div>
            </div>
        </div>
    </div>

    <div id="product-code-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="login-panel-enter w-full max-w-sm">
            <div class="relative panel bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl shadow-slate-300/20">
                <button id="product-code-close-btn" class="absolute top-4 right-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-400 text-white rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/30">
                        <i data-lucide="scan-barcode" class="w-7 h-7"></i>
                    </div>
                    <div>
                        <h3 id="product-code-modal-title" class="text-2xl font-bold text-slate-800">Select Code</h3>
                        <p class="text-sm text-slate-500">Choose an option for this product.</p>
                    </div>
                </div>
                <div id="product-codes-selection-list" class="space-y-2 max-h-[40vh] overflow-y-auto">
                    <!-- Codes will be populated here -->
                </div>
                <div class="mt-6">
                     <button id="product-code-skip-btn" class="w-full py-3 bg-white hover:bg-slate-50 text-slate-600 font-bold rounded-lg shadow-sm border border-slate-200 transition-all">Add without Code</button>
                </div>
            </div>
        </div>
    </div>

    <div id="cancellation-notes-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-[105] p-4">
        <div class="login-panel-enter w-full max-w-sm text-center">
            <div class="relative panel bg-white/80 backdrop-blur-xl p-8 sm:p-10 rounded-2xl shadow-2xl shadow-slate-300/20">
                <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-orange-400 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-orange-500/30">
                    <i data-lucide="file-x-2" class="w-10 h-10"></i>
                </div>
                <h3 class="text-2xl font-bold mb-2 text-slate-800">Cancel Invoice</h3>
                <p class="text-slate-500 mb-6">Please provide a reason for cancelling this invoice.</p>
                <textarea id="cancellation-notes-input" class="w-full p-3 input-field rounded-lg text-left mb-6" rows="3" placeholder="Cancellation notes..."></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <button id="modal-cancel-notes-btn" class="w-full py-3 bg-white hover:bg-slate-50 text-slate-600 font-bold rounded-lg shadow-sm border border-slate-200 transition-all">Cancel</button>
                    <button id="modal-confirm-notes-btn" class="w-full py-3 btn-primary rounded-lg btn-glow transform transition-transform hover:scale-105">Confirm Cancellation</button>
                </div>
            </div>
        </div>
    </div>

        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, reauthenticateWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc, getDocs, writeBatch, setDoc, updateDoc, addDoc, getDoc, query, where, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration ---
        // IMPORTANT SECURITY NOTE: The keys below are visible in the client-side code. For a production
        // application, it's highly recommended to use a more secure method like environment variables
        // or Firebase Hosting's reserved URLs to manage these keys and prevent them from being exposed.
        const firebaseConfig = {
            apiKey: "AIzaSyDKDBTWdSYtlyUSy2q9j2kKCCbmaJPNsvQ", 
            authDomain: "gedar-36be1.firebaseapp.com",
            projectId: "gedar-36be1",
            storageBucket: "gedar-36be1.appspot.com",
            messagingSenderId: "119312589070",
            appId: "1:119312589070:web:e6ca96a9bce4fe8003775f",
            measurementId: "G-QJLCWE7S7G"
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            // The EmailJS key is also exposed here. Consider securing this in a production environment.
            emailjs.init('pJmeQCFlRxOxllnrj');

            let products = []; 
            let cart = [];
            let tendered = 0;
            let customerName = '';
            let customerPhone = '';
            let invoiceNotes = '';
            let saleDate = new Date().toISOString().split('T')[0];
            let paymentMethod = 'Cash';
            let firestoreInvoices = [];
            let firestoreReturns = [];
            let firestoreExpenses = [];
            let firestoreUnconfirmedInvoices = []; // New variable
            let firestoreInvoiceArchive = [];
            let unsubscribeFromInvoices = null;
            let unsubscribeFromReturns = null;
            let unsubscribeFromProducts = null;
            let unsubscribeFromExpenses = null;
            let unsubscribeFromArchive = null;
            let isOnlineMode = false;
            let editingInvoiceId = null; 
            let editingInvoiceInternalId = null; 
            let isReturnMode = false;
            let originalInvoiceForReturn = null;
            let isDeveloperMode = false;
            let autoLogoutTimer = null;
            let sessionExpiryTimestamp = null;
            let workerPassword = 'Skip';
            let authorizedUsers = []; 
            let workerPermissions = {
                cashiers: [], 
                shopName: 'Badrly',
                branchInfo: '63511 Saad Zaghloul',
                machineNumber: 'LPQ80-ESC',
                contactNumber: '01014175070',
                facebookLink: 'https://www.facebook.com/gedar.fayoum/',
                invoiceAddress: 'Address\nLast wall of the general hospital, in front of Abu Salah butchery and next to the American laundry',
                returnPolicy: 'Return and Exchange Policy: Returns or exchanges are accepted only if the product is in its original condition, not scratched or broken. If it was sealed, the packaging must be intact. Any product that violates this policy will not be accepted for return.'
            };
            let activeTimers = {};
            let loginForSettings = false; 
            let systemLockInterval = null;
            let isLockOverridden = false;
            let currentlyViewingUnconfirmedId = null;
            
            let db, auth, userId, app;

            const loginView = document.getElementById('login-view');
            const loginBtn = document.getElementById('login-btn');
            const ownerSettingsBtn = document.getElementById('owner-settings-btn');
            const loginStatusMessage = document.getElementById('login-status-message');
            const appContainer = document.getElementById('app-container');
            const userInfoDiv = document.getElementById('user-info');
            const posView = document.getElementById('pos-view');
            const invoicesView = document.getElementById('invoices-view');
            const returnsView = document.getElementById('returns-view');
            const invoiceDetailsView = document.getElementById('invoice-details-view');
            const expensesView = document.getElementById('expenses-view');
            const inventoryView = document.getElementById('inventory-view');
            const backToPosFromInventoryBtn = document.getElementById('back-to-pos-from-inventory-btn');
            const inventoryGrid = document.getElementById('inventory-grid');
            const inventorySearchInput = document.getElementById('inventory-search-input');
            const productsGrid = document.getElementById('products-grid');
            const searchInput = document.getElementById('search-input');
            const cartItemsTbody = document.getElementById('cart-items');
            const subtotalEl = document.getElementById('subtotal');
            const totalDiscountEl = document.getElementById('total-discount');
            const totalEl = document.getElementById('total');
            const tenderedInput = document.getElementById('tendered-input');
            const changeEl = document.getElementById('change');
            const changeContainer = document.getElementById('change-container');
            const clearSaleBtn = document.getElementById('clear-sale-btn');
            const printReceiptBtn = document.getElementById('print-receipt-btn');
            const previewReceiptBtn = document.getElementById('preview-receipt-btn');
            const customerNameInput = document.getElementById('customer-name-input');
            const customerPhoneInput = document.getElementById('customer-phone-input');
            const invoiceNotesInput = document.getElementById('invoice-notes-input');
            const footerLiveInfoDiv = document.getElementById('footer-live-info');
            const footerSessionInfoDiv = document.getElementById('footer-session-info');
            const customItemNameInput = document.getElementById('custom-item-name');
            const customItemPriceInput = document.getElementById('custom-item-price');
            const addCustomItemBtn = document.getElementById('add-custom-item-btn');
            const viewInvoicesBtn = document.getElementById('view-invoices-btn');
            const viewReturnsBtn = document.getElementById('view-returns-btn');
            const invoicesListTbody = document.getElementById('invoices-list');
            const returnsListTbody = document.getElementById('returns-list');
            const invoicesSummaryTfoot = document.getElementById('invoices-summary');
            const backToPosBtn = document.getElementById('back-to-pos-btn');
            const backToPosFromReturnsBtn = document.getElementById('back-to-pos-from-returns-btn');
            const backToInvoicesBtn = document.getElementById('back-to-invoices-btn');
            const paymentMethodSelect = document.getElementById('payment-method');
            const invoiceDetailsContent = document.getElementById('invoice-details-content');
            const invoiceDetailsActions = document.getElementById('invoice-details-actions');
            const productsSection = document.getElementById('products-section');
            const receiptPreviewArea = document.getElementById('receipt-preview-area');
            const addNewProductSection = document.getElementById('add-new-product-section');
            const newProductNameInput = document.getElementById('new-product-name');
            const newProductPriceInput = document.getElementById('new-product-price');
            const newProductQuantityInput = document.getElementById('new-product-quantity');
            const unlimitedStockCheckbox = document.getElementById('unlimited-stock-checkbox');
            const addNewProductBtn = document.getElementById('add-new-product-btn');
            const passwordModal = document.getElementById('password-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const passwordInput = document.getElementById('password-input');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const alertModal = document.getElementById('alert-modal');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');
            const reauthConfirmModal = document.getElementById('reauth-confirm-modal');
            const reauthConfirmBtn = document.getElementById('reauth-confirm-btn');
            const reauthCancelBtn = document.getElementById('reauth-cancel-btn');
            const editProductModal = document.getElementById('edit-product-modal');
            const editProductIdInput = document.getElementById('edit-product-id');
            const editProductNameInput = document.getElementById('edit-product-name');
            const editProductPriceInput = document.getElementById('edit-product-price');
            const editProductQuantityInput = document.getElementById('edit-product-quantity');
            const editUnlimitedStockCheckbox = document.getElementById('edit-unlimited-stock-checkbox');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            const modalEditCancelBtn = document.getElementById('modal-edit-cancel-btn');
            const modalDeleteProductBtn = document.getElementById('modal-delete-product-btn');
            const settingsModal = document.getElementById('settings-modal');
            const settingsCloseBtn = document.getElementById('settings-close-btn');
            const authorizedAccountsSelect = document.getElementById('authorized-accounts-select');
            const sessionControls = document.getElementById('session-controls');
            const accountLogoutDurationValueInput = document.getElementById('account-logout-duration-value');
            const accountLogoutDurationUnitSelect = document.getElementById('account-logout-duration-unit');
            const saveAccountSessionBtn = document.getElementById('save-account-session-btn');
            const cancelAccountSessionBtn = document.getElementById('cancel-account-session-btn');
            const sessionStatusMessage = document.getElementById('session-status-message');
            const workerPermissionsModal = document.getElementById('worker-permissions-modal');
            const permissionsCloseBtn = document.getElementById('permissions-close-btn');
            const workerPasswordInput = document.getElementById('worker-password-input');
            const saveWorkerPasswordBtn = document.getElementById('save-worker-password-btn');
            const cashierProfilesList = document.getElementById('cashier-profiles-list');
            const addCashierBtn = document.getElementById('add-cashier-btn');
            const newCashierNameInput = document.getElementById('new-cashier-name');
            const newCashierCodeInput = document.getElementById('new-cashier-code');
            const newCashierKeyInput = document.getElementById('new-cashier-key');
            const invoiceCustomizationModal = document.getElementById('invoice-customization-modal');
            const invoiceCustomizationCloseBtn = document.getElementById('invoice-customization-close-btn');
            const invoiceCustomizationSaveBtn = document.getElementById('invoice-customization-save-btn');
            const invoiceShopNameInput = document.getElementById('invoice-shop-name-input');
            const invoiceBranchInfoInput = document.getElementById('invoice-branch-info-input');
            const invoiceMachineNumberInput = document.getElementById('invoice-machine-number-input');
            const invoiceContactNumberInput = document.getElementById('invoice-contact-number-input');
            const invoiceAddressInput = document.getElementById('invoice-address-input');
            const returnPolicyInput = document.getElementById('return-policy-input');
            const invoiceTitleEl = document.getElementById('invoice-title');
            const helpModal = document.getElementById('help-modal');
            const helpCloseBtn = document.getElementById('help-close-btn');
            const sendComplaintBtn = document.getElementById('send-complaint-btn');
            const complaintEmailInput = document.getElementById('complaint-email');
            const complaintMessageTextarea = document.getElementById('complaint-message');
            const invoiceDiscountInput = document.getElementById('invoice-discount-input');
            const invoiceSearchInput = document.getElementById('invoice-search-input');
            const invoiceStartDateInput = document.getElementById('invoice-start-date');
            const invoiceEndDateInput = document.getElementById('invoice-end-date');
            const returnSearchInput = document.getElementById('return-search-input');
            const returnStartDateInput = document.getElementById('return-start-date');
            const returnEndDateInput = document.getElementById('return-end-date');
            const ownerDeleteAllInvoicesBtn = document.getElementById('owner-delete-all-invoices-btn');
            const ownerDeleteAllReturnsBtn = document.getElementById('owner-delete-all-returns-btn');
            const ownerDeleteArchiveBtn = document.getElementById('owner-delete-archive-btn');
            const loginHelpBtn = document.getElementById('login-help-btn');
            const maintenanceHelpBtn = document.getElementById('maintenance-help-btn');
            const dangerZoneModal = document.getElementById('danger-zone-modal');
            const dangerZoneCloseBtn = document.getElementById('danger-zone-close-btn');
            const openDangerZoneBtn = document.getElementById('open-danger-zone-btn');
            const cashierProfilesModal = document.getElementById('cashier-profiles-modal');
            const cashierProfilesCloseBtn = document.getElementById('cashier-profiles-close-btn');
            const openCashierProfilesBtn = document.getElementById('open-cashier-profiles-btn');
            const viewCustomersBtn = document.getElementById('view-customers-btn');
            const customersModal = document.getElementById('customers-modal');
            const customersCloseBtn = document.getElementById('customers-close-btn');
            const customersListTbody = document.getElementById('customers-list');
            const downloadCustomersBtn = document.getElementById('download-customers-btn');
            const customerSearchInput = document.getElementById('customer-search-input');
            const reportsModal = document.getElementById('reports-modal');
            const reportsCloseBtn = document.getElementById('reports-close-btn');
            const reportContent = document.getElementById('report-content');
            const printReportBtn = document.getElementById('print-report-btn');
            const reportTypeSelect = document.getElementById('report-type-select');
            const reportDatePicker = document.getElementById('report-date-picker');
            const reportDateInput = document.getElementById('report-date-input');
            const reportEndDateInput = document.getElementById('report-end-date-input');
            const reportStartDatePicker = document.getElementById('report-start-date-picker');
            const reportEndDatePicker = document.getElementById('report-end-date-picker');
            const reportStartDateLabel = document.getElementById('report-start-date-label');
            const generateReportBtn = document.getElementById('generate-report-btn');


            // Expense View Elements
            const backToPosFromExpensesBtn = document.getElementById('back-to-pos-from-expenses-btn');
            const printExpensesBtn = document.getElementById('print-expenses-btn');
            const expenseDescriptionInput = document.getElementById('expense-description');
            const expenseTypeInput = document.getElementById('expense-type');
            const expenseAmountInput = document.getElementById('expense-amount');
            const expenseNotesInput = document.getElementById('expense-notes');
            const addExpenseBtn = document.getElementById('add-expense-btn');
            const expensesGrid = document.getElementById('expenses-grid');
            const deleteAllExpensesBtn = document.getElementById('delete-all-expenses-btn');
            const developerInfoModal = document.getElementById('developer-info-modal');
            const developerInfoCloseBtn = document.getElementById('developer-info-close-btn');
            
            // New Modal Elements
            const unconfirmedInvoicesModal = document.getElementById('unconfirmed-invoices-modal');
            const showUnconfirmedBtn = document.getElementById('show-unconfirmed-btn');
            const unconfirmedCountBadge = document.getElementById('unconfirmed-count-badge');
            const unconfirmedIcon = document.getElementById('unconfirmed-icon');
            const unconfirmedInvoicesCloseBtn = document.getElementById('unconfirmed-invoices-close-btn');
            const unconfirmedInvoicesList = document.getElementById('unconfirmed-invoices-list');
            const unconfirmedInvoiceDetails = document.getElementById('unconfirmed-invoice-details');
            const invoiceArchiveModal = document.getElementById('invoice-archive-modal');
            const showArchiveBtn = document.getElementById('show-archive-btn');
            const invoiceArchiveCloseBtn = document.getElementById('invoice-archive-close-btn');
            const invoiceArchiveList = document.getElementById('invoice-archive-list');
            const archiveDetailsModal = document.getElementById('archive-details-modal');
            const archiveDetailsCloseBtn = document.getElementById('archive-details-close-btn');
            const archiveDetailsContent = document.getElementById('archive-details-content');

            const editExpenseModal = document.getElementById('edit-expense-modal');
            const editExpenseIdInput = document.getElementById('edit-expense-id');
            const editExpenseDescriptionInput = document.getElementById('edit-expense-description');
            const editExpenseTypeInput = document.getElementById('edit-expense-type');
            const editExpenseAmountInput = document.getElementById('edit-expense-amount');
            const editExpenseNotesTextarea = document.getElementById('edit-expense-notes');
            const modalSaveExpenseBtn = document.getElementById('modal-save-expense-btn');
            const modalEditExpenseCancelBtn = document.getElementById('modal-edit-expense-cancel-btn');

            const expenseTypeModal = document.getElementById('expense-type-modal');
            const expenseTypeList = document.getElementById('expense-type-list');
            const expenseTypeCloseBtn = document.getElementById('expense-type-close-btn');

            const productCodeModal = document.getElementById('product-code-modal');
            const productCodeModalTitle = document.getElementById('product-code-modal-title');
            const productCodesSelectionList = document.getElementById('product-codes-selection-list');
            const productCodeCloseBtn = document.getElementById('product-code-close-btn');
            const productCodeSkipBtn = document.getElementById('product-code-skip-btn');
            const newProductCodeInput = document.getElementById('new-product-code-input');
            const newProductCodeQuantity = document.getElementById('new-product-code-quantity');
            const addProductCodeBtn = document.getElementById('add-product-code-btn');
            const productCodesList = document.getElementById('product-codes-list');

            // Edit Product Code Modal elements
            const editProductCodeModal = document.getElementById('edit-product-code-modal');
            const modalSaveCodeBtn = document.getElementById('modal-save-code-btn');
            const modalEditCodeCancelBtn = document.getElementById('modal-edit-code-cancel-btn');

            // Maintenance Modal Elements
            const maintenanceModeToggle = document.getElementById('maintenance-mode-toggle');
            const maintenanceMessageControls = document.getElementById('maintenance-message-controls');
            const maintenanceMessageInput = document.getElementById('maintenance-message-input');
            const saveMaintenanceSettingsBtn = document.getElementById('save-maintenance-settings-btn');
            
            // New Cancellation Notes Modal
            const cancellationNotesModal = document.getElementById('cancellation-notes-modal');
            const cancellationNotesInput = document.getElementById('cancellation-notes-input');
            const modalConfirmNotesBtn = document.getElementById('modal-confirm-notes-btn');
            const modalCancelNotesBtn = document.getElementById('modal-cancel-notes-btn');

            const systemLockModal = document.getElementById('system-lock-modal');
            const systemLockMessage = document.getElementById('system-lock-message');
            const systemLockEnabledToggle = document.getElementById('system-lock-enabled-toggle');
            const systemLockTimesContainer = document.getElementById('system-lock-times-container');
            const systemLockTimeInput = document.getElementById('system-lock-time-input');
            const systemUnlockTimeInput = document.getElementById('system-unlock-time-input');
            const lockOverridePromptBtn = document.getElementById('lock-override-prompt-btn');

            const showAlert = (message) => {
                alertMessage.textContent = message;
                alertModal.classList.remove('hidden');
                return new Promise((resolve) => {
                    alertOkBtn.onclick = () => {
                        alertModal.classList.add('hidden');
                        resolve();
                    };
                });
            };

            const showPasswordModal = (title, message) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                passwordInput.value = '';
                passwordModal.classList.remove('hidden');
                passwordInput.focus();
                return new Promise((resolve) => {
                    modalConfirmBtn.onclick = () => {
                        passwordModal.classList.add('hidden');
                        resolve(passwordInput.value);
                    };
                    modalCancelBtn.onclick = () => {
                        passwordModal.classList.add('hidden');
                        resolve(null);
                    };
                });
            };

            const showCancellationNotesModal = () => {
                cancellationNotesInput.value = '';
                cancellationNotesModal.classList.remove('hidden');
                cancellationNotesInput.focus();
                return new Promise((resolve) => {
                    modalConfirmNotesBtn.onclick = () => {
                        cancellationNotesModal.classList.add('hidden');
                        resolve(cancellationNotesInput.value.trim() || 'No reason provided.'); // Resolve with notes or a default
                    };
                    modalCancelNotesBtn.onclick = () => {
                        cancellationNotesModal.classList.add('hidden');
                        resolve(null); // Resolve with null if cancelled
                    };
                });
            };

            const defaultExpenseTypes = []; // All types are now custom and stored in Firestore
            let customExpenseTypes = [];
            let allExpenseTypes = [];
            let currentExpenseTypeInput = null;

            const populateExpenseTypeModal = () => {
                const addSection = document.getElementById('add-expense-type-section');
                addSection.style.display = isDeveloperMode ? 'block' : 'none';

                expenseTypeList.innerHTML = '';
                allExpenseTypes.forEach(type => {
                    const typeButtonContainer = document.createElement('div');
                    typeButtonContainer.className = `p-3 rounded-lg font-semibold bg-slate-100 hover:bg-blue-100 transition-colors flex items-center justify-between cursor-pointer`;
                    
                    const typeText = document.createElement('span');
                    typeText.className = 'flex-grow';
                    typeText.textContent = type;
                    typeButtonContainer.appendChild(typeText);
                    
                    // All types are now custom and can be deleted in developer mode
                    if (isDeveloperMode) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'p-1 -mr-1 text-slate-400 hover:text-red-500 rounded-full flex-shrink-0';
                        deleteBtn.innerHTML = '<i data-lucide="x" class="w-4 h-4 pointer-events-none"></i>';
                        deleteBtn.onclick = async (e) => {
                            e.stopPropagation();
                            const confirmed = await confirmDangerousAction('Delete Expense Type', `Are you sure you want to permanently delete the type "${type}"?`);
                            if(confirmed) {
                                await deleteExpenseType(type);
                            }
                        };
                        typeButtonContainer.appendChild(deleteBtn);
                    }

                    typeButtonContainer.onclick = (e) => {
                        // Only trigger if not clicking the delete button itself
                        if (e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
                            if (currentExpenseTypeInput) {
                                currentExpenseTypeInput.value = type;
                            }
                            expenseTypeModal.classList.add('hidden');
                        }
                    };
                    
                    expenseTypeList.appendChild(typeButtonContainer);
                });
                lucide.createIcons();
            };

            const deleteExpenseType = async (typeToDelete) => {
                customExpenseTypes = customExpenseTypes.filter(t => t !== typeToDelete);
                allExpenseTypes = allExpenseTypes.filter(t => t !== typeToDelete);
                await saveCustomExpenseTypes(); // Save updated list to the cloud
                populateExpenseTypeModal(); // Refresh the modal view instantly
            };

            const clearAutoLogoutTimer = () => {
                if (autoLogoutTimer) {
                    clearInterval(autoLogoutTimer);
                    autoLogoutTimer = null;
                }
                footerSessionInfoDiv.textContent = '';
            };

            const updateLogoutTimer = async () => {
                if (!sessionExpiryTimestamp || sessionExpiryTimestamp <= 0) {
                    clearAutoLogoutTimer();
                    return;
                }

                const timeLeft = Math.round((sessionExpiryTimestamp - Date.now()) / 1000);

                if (timeLeft <= 0) {
                    clearAutoLogoutTimer();
                    await showAlert('Session has expired, you will be logged out now.');
                    signOut(auth);
                    return;
                }
                let displayString = "Logout in: ";
                const days = Math.floor(timeLeft / 86400);
                const hours = Math.floor((timeLeft % 86400) / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = Math.floor(timeLeft % 60);
                footerSessionInfoDiv.classList.remove('text-green-500', 'text-yellow-500', 'text-orange-500', 'text-red-500');
                if (days > 10) {
                    footerSessionInfoDiv.classList.add('text-green-500');
                } else if (days > 3) {
                    footerSessionInfoDiv.classList.add('text-yellow-500');
                } else if (days >= 1) {
                    footerSessionInfoDiv.classList.add('text-orange-500');
                } else {
                    footerSessionInfoDiv.classList.add('text-red-500');
                }
                if (days > 30) {
                    const months = Math.floor(days / 30);
                    const remainingDays = days % 30;
                    displayString += `${months} months & ${remainingDays} days`;
                } else if (days > 0) {
                    displayString += `${days} days & ${hours} hours`;
                } else if (hours > 0) {
                    displayString += `${hours} hours & ${minutes} minutes`;
                } else {
                    displayString += `${minutes} minutes & ${seconds} seconds`;
                }
                footerSessionInfoDiv.textContent = displayString;
            };

            const startAutoLogoutTimer = (newExpiryTimestamp) => {
                clearAutoLogoutTimer(); 
                
                sessionExpiryTimestamp = newExpiryTimestamp;

                if (!sessionExpiryTimestamp || sessionExpiryTimestamp <= 0) {
                    return; 
                }
                
                autoLogoutTimer = setInterval(updateLogoutTimer, 1000);
                updateLogoutTimer();
            };

            function initializeFirebase() {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    loginStatusMessage.textContent = `Connection failed: ${error.message}`;
                    loginStatusMessage.classList.add('text-red-600');
                }
            }
            
            function setupProductsListener() {
                if (!userId || !isOnlineMode) return;
                if (unsubscribeFromProducts) unsubscribeFromProducts();
                const productsCollectionPath = `users/${userId}/products`;
                const q = collection(db, productsCollectionPath);
                unsubscribeFromProducts = onSnapshot(q, (querySnapshot) => {
                    products = [];
                    querySnapshot.forEach((doc) => {
                        products.push({ id: doc.id, ...doc.data() });
                    });
                    products.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                    localStorage.setItem('localProductsCache', JSON.stringify(products));
                    renderProducts(products);
                }, (error) => {
                    console.error("Error listening to Products in Firestore:", error);
                    showAlert('An error occurred while loading the product list.');
                });
            }

            function loadProductsFromCache() {
                const cachedProducts = localStorage.getItem('localProductsCache');
                if (cachedProducts) {
                    products = JSON.parse(cachedProducts);
                    renderProducts(products);
                } else {
                     renderProducts([]);
                }
            }

            async function updateProduct(productId, newData) {
                if (isOnlineMode) {
                    try {
                        const productDocRef = doc(db, `users/${userId}/products`, productId);
                        await updateDoc(productDocRef, newData);
                        showAlert('Product updated in the cloud.');
                    } catch (error) {
                        console.error("Error updating product in Firestore:", error);
                        showAlert('Failed to update product in the cloud.');
                    }
                }
            }
            
            async function deleteProduct(productId) {
                if (isOnlineMode) {
                    try {
                        const docRef = doc(db, `users/${userId}/products`, productId);
                        await deleteDoc(docRef);
                        editProductModal.classList.add('hidden');
                        await showAlert('Product deleted successfully.');
                    } catch (error) {
                        console.error("Error deleting product:", error);
                        await showAlert('An error occurred while deleting the product.');
                    }
                }
            }

            async function syncLocalToCloudOnLogin() {
                const localInvoices = JSON.parse(localStorage.getItem('savedInvoices')) || [];
                if (localInvoices.length === 0) return;
                try {
                    const invoicesCollectionPath = `users/${userId}/invoices`;
                    const q = collection(db, invoicesCollectionPath);
                    const cloudSnapshot = await getDocs(q);
                    const cloudInvoiceIds = new Set(cloudSnapshot.docs.map(doc => doc.data().id));
                    const invoicesToUpload = localInvoices.filter(inv => !cloudInvoiceIds.has(inv.id));
                    if (invoicesToUpload.length === 0) return;
                    const batch = writeBatch(db);
                    invoicesToUpload.forEach(invoice => {
                        const docRef = doc(collection(db, invoicesCollectionPath));
                        batch.set(docRef, invoice);
                    });
                    await batch.commit();
                    await showAlert(`Uploaded ${invoicesToUpload.length} new local invoices to your cloud account.`);
                } catch (error) {
                    console.error("Error syncing local invoices to cloud:", error);
                    await showAlert('An error occurred while syncing local invoices.');
                }
            }

            function setupInvoicesListener() {
                if (!userId || !isOnlineMode) return;
                if (unsubscribeFromInvoices) unsubscribeFromInvoices();
                const invoicesCollectionPath = `users/${userId}/invoices`;
                const q = collection(db, invoicesCollectionPath);
                unsubscribeFromInvoices = onSnapshot(q, (querySnapshot) => {
                    const allInvoices = [];
                    querySnapshot.forEach((doc) => {
                        allInvoices.push({ firestoreId: doc.id, ...doc.data() });
                    });

                    // Filter invoices into confirmed and unconfirmed
                    firestoreInvoices = allInvoices.filter(inv => inv.status !== 'unconfirmed');
                    firestoreUnconfirmedInvoices = allInvoices.filter(inv => inv.status === 'unconfirmed');
                    
                    // Update UI components that depend on these lists
                    updateUnconfirmedCountBadge();
                    localStorage.setItem('savedInvoices', JSON.stringify(firestoreInvoices)); // Only save confirmed to local
                    
                    if (!invoicesView.classList.contains('hidden-view')) {
                        renderSavedInvoicesList();
                    }
                    if (!unconfirmedInvoicesModal.classList.contains('hidden')) {
                        renderUnconfirmedInvoicesList();
                    }

                }, (error) => {
                    console.error("Error listening to Invoices in Firestore:", error);
                    showAlert('An error occurred while loading invoice data.');
                });
            }
            
            function setupReturnsListener() {
                if (!userId || !isOnlineMode) return;
                if (unsubscribeFromReturns) unsubscribeFromReturns();
                const returnsCollectionPath = `users/${userId}/returns`;
                const q = collection(db, returnsCollectionPath);
                unsubscribeFromReturns = onSnapshot(q, (querySnapshot) => {
                    firestoreReturns = [];
                    querySnapshot.forEach((doc) => {
                        firestoreReturns.push({ firestoreId: doc.id, ...doc.data() });
                    });
                    localStorage.setItem('savedReturns', JSON.stringify(firestoreReturns));
                    if (!returnsView.classList.contains('hidden-view')) {
                        renderSavedReturnsList();
                    }
                }, (error) => {
                    console.error("Error listening to Returns in Firestore:", error);
                    showAlert('An error occurred while loading returns data.');
                });
            }

            function setupExpensesListener() {
                if (!userId || !isOnlineMode) return;
                if (unsubscribeFromExpenses) unsubscribeFromExpenses();
                const expensesCollectionPath = `users/${userId}/expenses`;
                const q = collection(db, expensesCollectionPath);
                unsubscribeFromExpenses = onSnapshot(q, (querySnapshot) => {
                    firestoreExpenses = [];
                    querySnapshot.forEach((doc) => {
                        firestoreExpenses.push({ firestoreId: doc.id, ...doc.data() });
                    });
                    localStorage.setItem('savedExpenses', JSON.stringify(firestoreExpenses));
                    if (!expensesView.classList.contains('hidden-view')) {
                        renderExpensesList();
                    }
                }, (error) => {
                    console.error("Error listening to Expenses in Firestore:", error);
                    showAlert('An error occurred while loading expenses data.');
                });
            }

            function setupArchiveListener() {
                if (!userId || !isOnlineMode) return;
                if (unsubscribeFromArchive) unsubscribeFromArchive();
                const archiveCollectionPath = `users/${userId}/invoice_archive`;
                const q = collection(db, archiveCollectionPath);
                unsubscribeFromArchive = onSnapshot(q, (querySnapshot) => {
                    firestoreInvoiceArchive = [];
                    querySnapshot.forEach((doc) => {
                        firestoreInvoiceArchive.push({ firestoreId: doc.id, ...doc.data() });
                    });
                    if (!invoiceArchiveModal.classList.contains('hidden')) {
                        renderInvoiceArchive();
                    }
                }, (error) => {
                    console.error("Error listening to Invoice Archive in Firestore:", error);
                    showAlert('An error occurred while loading the invoice archive.');
                });
            }

            const renderProducts = (filteredProducts) => {
                productsGrid.innerHTML = '';
                if (filteredProducts.length === 0) {
                     productsGrid.innerHTML = `<p class="col-span-full text-center text-[var(--text-secondary)] py-10">No products to display.</p>`;
                     return;
                }
                const canEdit = isDeveloperMode;
                filteredProducts.forEach((product, index) => {
                    const productCardDiv = document.createElement('div');
                    const isOutOfStock = product.quantity <= 0;
                    const isLowStock = product.quantity > 0 && product.quantity <= 5;

                    let cardClasses = 'product-card product-card-enter relative';
                    if (isOutOfStock) cardClasses += ' out-of-stock';
                    if (isLowStock) cardClasses += ' low-stock';

                    productCardDiv.className = cardClasses;
                    productCardDiv.style.animationDelay = `${index * 0.04}s`;

                    productCardDiv.dataset.id = product.id;
                    if (isOutOfStock) {
                        productCardDiv.disabled = true;
                    }

                    const hasCodes = product.codes && product.codes.length > 0;
                    const discount = product.discount || 0;
                    let priceHTML = '';

                    if (discount > 0) {
                        const discountedPrice = product.price * (1 - discount / 100);
                        priceHTML = `
                            <div class="flex items-baseline gap-2">
                                <p class="text-xl font-black text-red-600">${discountedPrice.toFixed(2)}</p>
                                <p class="text-sm font-bold text-slate-400 line-through">${product.price.toFixed(2)}</p>
                            </div>
                        `;
                    } else {
                        priceHTML = `<p class="text-xl font-black text-[var(--accent-color)]">${product.price > 0 ? `${product.price.toFixed(2)}` : '-'}</p>`;
                    }


                    productCardDiv.innerHTML = `
                        ${isOnlineMode && canEdit ? `
                        <button class="edit-product-btn absolute top-2 right-2 z-10 p-1.5 bg-white/80 backdrop-blur-sm rounded-full hover:bg-yellow-200 text-[var(--text-secondary)] hover:text-black transition-colors" data-id="${product.id}">
                            <i data-lucide="pencil" class="h-4 w-4"></i>
                        </button>
                        ` : ''}
                        ${hasCodes ? `<div class="absolute top-2 left-2 p-1 bg-purple-100/80 backdrop-blur-sm rounded-full" title="This product has multiple variations/codes"><i data-lucide="git-branch-plus" class="w-4 h-4 text-purple-600"></i></div>` : ''}
                        ${discount > 0 ? `<div class="absolute top-2 ${hasCodes ? 'left-10' : 'left-2'} px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded-full z-10">-${discount}%</div>` : ''}

                        <div class="flex-grow p-4 flex flex-col justify-between">
                            <div>
                                <div class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-lg mb-3">
                                    <i data-lucide="package" class="w-7 h-7 text-slate-500"></i>
                                </div>
                                <p class="font-bold text-sm text-slate-800 leading-tight">${product.name}</p>
                            </div>

                            <div class="mt-3">
                                ${priceHTML}
                                <div class="product-stock text-xs font-medium inline-block px-2 py-0.5 rounded-full mt-1 ${isLowStock && !isOutOfStock ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-600'}">
                                    ${isOutOfStock ? 'Out of Stock' : `${product.quantity} in stock`}
                                </div>
                            </div>
                        </div>
                    `;
                    productsGrid.appendChild(productCardDiv);
                });
                 lucide.createIcons();
            };

            const renderCart = () => {
                cartItemsTbody.innerHTML = '';
                if (cart.length === 0) {
                    cartItemsTbody.innerHTML = '<tr><td colspan="5" class="text-center text-[var(--text-secondary)] py-16"><i data-lucide="shopping-cart" class="mx-auto h-12 w-12"></i><p>Cart is empty</p></td></tr>';
                } else {
                    cart.forEach(item => {
                        const cartItemRow = document.createElement('tr');
                        cartItemRow.className = "border-b border-[var(--panel-border)]";
                        const itemTotal = (item.price * item.quantity) - (item.discount || 0);
                        cartItemRow.innerHTML = `
                            <td class="py-3 pl-2 font-semibold text-[var(--text-primary)]">
                                ${item.name}
                                <div class="text-xs text-[var(--text-secondary)]">${item.price.toFixed(2)} EGP</div>
                            </td>
                            <td class="py-3">
                                <div class="flex items-center justify-center gap-2">
                                    <button data-id="${item.cartId}" data-amount="-1" class="quantity-btn w-7 h-7 bg-slate-200/70 rounded-full text-lg font-bold flex items-center justify-center hover:bg-slate-300 transition-colors">-</button>
                                    <span class="w-8 text-center font-bold text-[var(--text-primary)]">${item.quantity}</span>
                                    <button data-id="${item.cartId}" data-amount="1" class="quantity-btn w-7 h-7 bg-slate-200/70 rounded-full text-lg font-bold flex items-center justify-center hover:bg-slate-300 transition-colors">+</button>
                                </div>
                            </td>
                            <td class="py-3 text-center">
                                <input type="number" value="${item.discount || 0}" data-id="${item.cartId}" class="item-discount-input w-20 p-1 input-field text-center font-bold text-red-600">
                            </td>
                            <td class="py-3 text-right font-semibold text-lg pr-2 text-[var(--accent-color)]">${itemTotal.toFixed(2)}</td>
                            <td class="py-3 text-center">
                                <button data-id="${item.cartId}" class="remove-btn text-slate-400 hover:text-red-500 transition-colors p-1">
                                    <i data-lucide="trash-2" class="h-5 w-5"></i>
                                </button>
                            </td>
                        `;
                        cartItemsTbody.appendChild(cartItemRow);
                    });
                }
                updateTotals();
                lucide.createIcons();
            };

            const updateTotals = () => {
                const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const itemsDiscount = cart.reduce((sum, item) => sum + (item.discount || 0), 0);
                const invoiceDiscount = parseFloat(invoiceDiscountInput.value) || 0;
                const total = subtotal - itemsDiscount - invoiceDiscount;
                const currentTendered = parseFloat(tenderedInput.value);
                const finalTendered = (isNaN(currentTendered) || tenderedInput.value.trim() === '') ? total : currentTendered;
                const change = finalTendered - total;
                subtotalEl.textContent = subtotal.toFixed(2);
                totalDiscountEl.textContent = itemsDiscount.toFixed(2);
                totalEl.textContent = total.toFixed(2);
                changeContainer.classList.remove('bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
                if (change < 0) {
                    changeEl.textContent = `${change.toFixed(2)}`
                    changeContainer.classList.add('bg-red-100', 'text-red-700');
                } else {
                    changeEl.textContent = Math.abs(change).toFixed(2);
                    changeContainer.classList.add('bg-green-100', 'text-green-700');
                }
                const cartIsEmpty = cart.length === 0;
                printReceiptBtn.disabled = cartIsEmpty;
                previewReceiptBtn.disabled = cartIsEmpty;
            };

            const generateInvoiceId = (prefix = 'INV') => {
                const now = new Date();
                const year = String(now.getFullYear()).slice(-2);
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                return `${prefix}-${year}${month}${day}-${hours}${minutes}${seconds}`;
            };

            const openProductCodeModal = (product) => {
                productCodeModalTitle.textContent = product.name;
                productCodesSelectionList.innerHTML = '';
                
                const handleAddToCart = (code, price) => {
                    addToCart(product, 1, code, price);
                    productCodeModal.classList.add('hidden');
                };

                (product.codes || []).forEach(codeObj => {
                    const button = document.createElement('button');
                    const inStock = codeObj.quantity > 0;
                    const lowStock = codeObj.quantity > 0 && codeObj.quantity <= 5;

                    let bgColor = 'bg-slate-100 hover:bg-blue-100';
                    if (lowStock) bgColor = 'bg-amber-100 hover:bg-amber-200';
                    if (!inStock) bgColor = 'bg-red-100 cursor-not-allowed';
                    
                    button.className = `w-full text-left p-3 rounded-lg font-semibold flex justify-between items-center ${bgColor}`;
                    button.disabled = !inStock;
                    const codePrice = codeObj.price || product.price;
                    const codeDiscount = codeObj.discount || 0;
                    let finalPrice = codePrice;
                    if (codeDiscount > 0) {
                        finalPrice = codePrice * (1 - codeDiscount / 100);
                    }

                    button.innerHTML = `
                        <span>${codeObj.code} ${codeDiscount > 0 ? `<span class="text-xs text-red-500 font-bold">(-${codeDiscount}%)</span>` : ''}</span>
                        <div class="text-right">
                            ${codeDiscount > 0 ? `<span class="text-sm font-bold text-slate-400 line-through">${codePrice.toFixed(2)}</span>` : ''}
                            <span class="font-bold text-slate-700 ml-2">${finalPrice.toFixed(2)} EGP</span>
                            <span class="text-sm font-medium ${lowStock ? 'text-amber-700' : ''} ${!inStock ? 'text-red-700' : 'text-slate-600'}">
                                ${inStock ? `${codeObj.quantity} in stock` : 'Out of Stock'}
                            </span>
                        </div>
                    `;
                    button.onclick = () => handleAddToCart(codeObj.code, finalPrice);
                    productCodesSelectionList.appendChild(button);
                });

                productCodeSkipBtn.onclick = () => {
                    // Also apply main product discount if no code is selected
                    const discount = product.discount || 0;
                    let finalPrice = product.price;
                    if (discount > 0) {
                        finalPrice = product.price * (1 - discount / 100);
                    }
                    handleAddToCart(null, finalPrice);
                };

                productCodeModal.classList.remove('hidden');
            };

            const addToCart = (product, quantityToAdd = 1, selectedCode = null, selectedPrice = null) => {
                if (!product || typeof product.id === 'undefined') {
                    return;
                }

                const cartItemName = selectedCode ? `${product.name} (${selectedCode})` : product.name;
                const cartItemId = selectedCode ? `${product.id}-${selectedCode}` : product.id;

                const existingItem = cart.find(item => item.cartId === cartItemId);
                
                let currentStock;
                let itemPrice;

                if (selectedPrice !== null) {
                    // Price is pre-calculated and passed in (for items with codes or base product)
                    itemPrice = selectedPrice;
                } else {
                    // This is a fallback, but the price should ideally be pre-calculated
                    const discount = product.discount || 0;
                    itemPrice = product.price;
                    if (discount > 0) {
                        itemPrice = product.price * (1 - discount / 100);
                    }
                }


                if (selectedCode) {
                    const codeObj = product.codes.find(c => c.code === selectedCode);
                    currentStock = codeObj ? codeObj.quantity : 0;
                } else {
                    currentStock = product.quantity;
                }

                const quantityInCart = existingItem ? existingItem.quantity : 0;

                if (quantityInCart + quantityToAdd > currentStock) {
                    showAlert(`Not enough stock for ${cartItemName}. Only ${currentStock - quantityInCart} more available.`);
                    return;
                }

                if (existingItem) {
                    existingItem.quantity += quantityToAdd;
                } else {
                    const newItem = { ...product, price: itemPrice, name: cartItemName, cartId: cartItemId, quantity: quantityToAdd, discount: 0, code: selectedCode };
                    delete newItem.codes;
                    cart.push(newItem);
                }
                renderCart();
            };

            const updateQuantity = (cartId, amount) => {
                const item = cart.find(item => String(item.cartId) === String(cartId));
                if (item) {
                    const originalProduct = products.find(p => p.id === item.id);
                    
                    let maxQuantity = Infinity;
                    if (isReturnMode) {
                        maxQuantity = (originalInvoiceForReturn.items.find(p => p.cartId === item.cartId)?.quantity || item.quantity) 
                    } else if (originalProduct) {
                         if (item.code) {
                            const codeObj = originalProduct.codes.find(c => c.code === item.code);
                            maxQuantity = codeObj ? codeObj.quantity : 0;
                        } else {
                            maxQuantity = originalProduct.quantity;
                        }
                    }

                    const newQuantity = item.quantity + amount;

                    if (newQuantity > 0 && newQuantity <= maxQuantity) {
                         item.quantity = newQuantity;
                    } else if (newQuantity > maxQuantity) {
                        showAlert(`Cannot add more than the available stock (${maxQuantity}) for ${item.name}.`);
                    } else if (newQuantity <= 0) {
                        removeFromCart(cartId);
                    }
                    renderCart();
                }
            };

            const updateItemDiscount = (cartId, newDiscount) => {
                const item = cart.find(item => String(item.cartId) === String(cartId));
                if (item) {
                    const maxDiscount = item.price * item.quantity;
                    if (newDiscount >= 0 && newDiscount <= maxDiscount) {
                        item.discount = newDiscount;
                    } else if (newDiscount > maxDiscount) {
                        item.discount = maxDiscount; 
                    } else {
                        item.discount = 0;
                    }
                }
                renderCart(); 
            };
            
            const removeFromCart = (cartId) => {
                cart = cart.filter(item => String(item.cartId) !== String(cartId));
                renderCart();
            };

            const clearSale = () => {
                const cashierSelect = document.getElementById('cashier-select');
                cart = [];
                tendered = 0;
                customerName = '';
                customerPhone = '';
                saleDate = new Date().toISOString().split('T')[0];
                editingInvoiceId = null;
                editingInvoiceInternalId = null;
                isReturnMode = false;
                originalInvoiceForReturn = null;
                invoiceTitleEl.textContent = "Invoice";
                tenderedInput.value = '';
                customerNameInput.value = '';
                customerPhoneInput.value = '';
                invoiceDiscountInput.value = '';
                paymentMethodSelect.value = 'Cash';
                cashierSelect.value = '';
                cashierSelect.classList.remove('border-red-500', 'border-2');
                invoiceNotesInput.value = '';
                invoiceNotes = '';
                renderCart();
            };
            
            const handleSaveAction = async () => {
                const cashierSelect = document.getElementById('cashier-select');
                const selectedCashierIndex = cashierSelect.value;

                if (selectedCashierIndex === '') {
                    showAlert('Please select a cashier.');
                    cashierSelect.classList.add('border-red-500', 'border-2');
                    cashierSelect.focus();
                    return;
                }
                
                cashierSelect.classList.remove('border-red-500', 'border-2');
                const selectedCashier = workerPermissions.cashiers[selectedCashierIndex];

                const enteredKey = await showPasswordModal(`Confirm Cashier: ${selectedCashier.name}`, 'Please enter the activation key.');

                if (enteredKey === null) return; 

                if (enteredKey !== selectedCashier.key) {
                    showAlert('Incorrect activation key.');
                    return;
                }
                
                const invoiceObject = await saveInvoice(selectedCashier);
                if (invoiceObject) {
                    if (!isReturnMode) {
                        const printType = invoiceObject.editedTimestamp ? 'copy' : 'fresh';
                        generateAndSavePDF(invoiceObject, printType);
                    } else {
                        showAlert('Return saved successfully.');
                    }
                    clearSale();
                }
            };
            
            const saveInvoice = async (cashier) => {
                if (isOnlineMode) {
                    return await saveInvoiceToFirestore(cashier);
                } else {
                    showAlert('You must be logged in to save invoices.');
                    return null;
                }
            };

            const saveInvoiceToFirestore = async (cashier) => {
                if (!userId) {
                    showAlert('Cannot save invoice. User is not logged in.');
                    return null;
                }
                const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const itemsDiscount = cart.reduce((sum, item) => sum + (item.discount || 0), 0);
                const invoiceDiscount = parseFloat(invoiceDiscountInput.value) || 0;
                const total = subtotal - itemsDiscount - invoiceDiscount;
                let finalTendered = parseFloat(tenderedInput.value);
                if (isNaN(finalTendered) || tenderedInput.value.trim() === '') {
                    finalTendered = isReturnMode ? -total : total;
                }
                
                let invoiceData;
                const cashierCode = cashier ? cashier.code : 'N/A';
                const sellerName = cashier ? cashier.name : 'N/A';
                
                if (isReturnMode) {
                    invoiceData = {
                        id: generateInvoiceId('RET'),
                        originalInvoiceId: originalInvoiceForReturn.id,
                        date: saleDate,
                        timestamp: Date.now(),
                        customerName: customerName || 'N/A',
                        customerPhone: customerPhone || 'N/A',
                        notes: invoiceNotes,
                        items: cart,
                        subtotal: subtotal,
                        discount: 0, 
                        total: -total, 
                        tendered: -total,
                        paymentMethod: paymentMethodSelect.value,
                        cashierCode,
                        sellerName
                    };
                } else if (editingInvoiceId) {
                    const originalDocRef = doc(db, `users/${userId}/invoices`, editingInvoiceId);
                    const originalDocSnap = await getDoc(originalDocRef);
                    const originalData = originalDocSnap.data();
                    invoiceData = {
                        ...originalData,
                        date: saleDate, customerName: customerName || 'N/A', customerPhone: customerPhone || 'N/A',
                        items: cart, subtotal: subtotal, discount: itemsDiscount, invoiceDiscount: invoiceDiscount, total: total, tendered: finalTendered,
                        paymentMethod: paymentMethodSelect.value, editedTimestamp: Date.now(),
                        originalInvoiceData: originalData.originalInvoiceData || originalData,
                        status: 'unconfirmed' // <-- ADD THIS
                    };
                } else {
                     invoiceData = {
                        id: generateInvoiceId(), date: saleDate, timestamp: Date.now(),
                        customerName: customerName || 'N/A', customerPhone: customerPhone || 'N/A',
                        items: cart, subtotal: subtotal, discount: itemsDiscount, invoiceDiscount: invoiceDiscount, total: total, tendered: finalTendered,
                        paymentMethod: paymentMethodSelect.value,
                        notes: invoiceNotes,
                        cashierCode,
                        sellerName,
                        status: 'unconfirmed' // <-- ADD THIS
                    };
                }

                try {
                    await runTransaction(db, async (transaction) => {
                        const productsToUpdate = [];
                        const productRefs = [];
                        
                        // Create a map of product IDs to their corresponding cart items
                        const productItemsMap = new Map();
                        for (const item of cart) {
                            if (!item.id.startsWith('custom-')) {
                                if (!productItemsMap.has(item.id)) {
                                    productItemsMap.set(item.id, []);
                                }
                                productItemsMap.get(item.id).push(item);
                                productRefs.push(doc(db, `users/${userId}/products`, item.id));
                            }
                        }
                        
                        // Get all unique product documents in one go
                        const uniqueProductRefs = [...new Set(productRefs)];
                        const productDocs = await Promise.all(uniqueProductRefs.map(ref => transaction.get(ref)));
                        
                        const productDocsMap = new Map(productDocs.map(doc => [doc.id, doc]));

                        for (const [productId, items] of productItemsMap.entries()) {
                            const productDoc = productDocsMap.get(productId);
                            if (!productDoc.exists()) {
                                throw `Product with ID ${productId} not found!`;
                            }
                            
                            const productData = productDoc.data();

                            // If it's a return and the product has unlimited stock, skip the logic that adds the quantity back.
                            if (isReturnMode && productData.quantity === Infinity) {
                                continue; // Skip to the next product
                            }
                            
                            let hasCodeUpdates = false;

                            items.forEach(item => {
                                if (item.code) { // Item has a specific code
                                    hasCodeUpdates = true;
                                    const codeIndex = productData.codes.findIndex(c => c.code === item.code);
                                    if (codeIndex === -1) {
                                        throw `Code ${item.code} not found for product ${item.name}!`;
                                    }
                                    
                                    const currentCodeQuantity = productData.codes[codeIndex].quantity;
                                    const newCodeQuantity = isReturnMode 
                                        ? currentCodeQuantity + item.quantity
                                        : currentCodeQuantity - item.quantity;
                                    
                                    productData.codes[codeIndex].quantity = newCodeQuantity;
                                }
                            });

                            if (hasCodeUpdates) {
                                // Recalculate main quantity from sum of codes
                                productData.quantity = productData.codes.reduce((sum, c) => sum + c.quantity, 0);
                            } else if (items.length > 0) {
                                // This handles products without codes
                                const totalQuantityChange = items.reduce((sum, item) => sum + item.quantity, 0);
                                const currentQuantity = productData.quantity || 0;
                                productData.quantity = isReturnMode
                                    ? currentQuantity + totalQuantityChange
                                    : currentQuantity - totalQuantityChange;
                            }
                             productsToUpdate.push({ ref: productDoc.ref, updatedData: productData });
                        }

                        const collectionPath = isReturnMode ? `users/${userId}/returns` : `users/${userId}/invoices`;
                        let docRef;
                        if (editingInvoiceId && !isReturnMode) {
                            docRef = doc(db, collectionPath, editingInvoiceId);
                            transaction.set(docRef, invoiceData);
                        } else {
                            docRef = doc(collection(db, collectionPath));
                            transaction.set(docRef, invoiceData);
                        }

                        for (const productUpdate of productsToUpdate) {
                            transaction.update(productUpdate.ref, productUpdate.updatedData);
                        }

                        // Add to archive
                        const archiveDocRef = doc(collection(db, `users/${userId}/invoice_archive`));
                        transaction.set(archiveDocRef, {
                            invoiceId: invoiceData.id,
                            status: isReturnMode ? 'confirmed' : 'created',
                            timestamp: invoiceData.timestamp,
                            customerName: invoiceData.customerName,
                            total: invoiceData.total,
                            invoiceData: invoiceData
                        });
                    });

                    editingInvoiceId = null;
                    editingInvoiceInternalId = null;
                    isReturnMode = false;
                    originalInvoiceForReturn = null;
                    return invoiceData;
                } catch (error) {
                    console.error("Error saving transaction:", error);
                    showAlert(`An error occurred while saving: ${error}`);
                    return null;
                }
            };
            
            const generateReceiptHTML = (invoiceData, printType = 'fresh', forPreview = false) => {
                const colors = forPreview 
                    ? { text: 'var(--text-primary)', heading: 'var(--text-primary)', faint: 'var(--panel-border)', border: 'var(--panel-border)' } 
                    : { text: '#000000', heading: '#000000', faint: '#000000', border: '#000000' };
                
                const { id, customerName, customerPhone, items, subtotal, total, tendered, paymentMethod, originalInvoiceId, cashierCode, sellerName, timestamp, editedTimestamp, discount, invoiceDiscount, notes } = invoiceData;
                const itemsDiscount = discount || 0;
                const change = tendered - total;
                const hasItemDiscounts = itemsDiscount > 0;
                const hasInvoiceDiscount = invoiceDiscount > 0;
                
                const getEnglishDateTime = (ts) => new Date(ts).toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }).replace(',', ' ');
                
                const isCopy = printType === 'copy';
                const isReturn = printType === 'return' || id.startsWith('RET');
                
                let headerLabel = '';
                let headerStyle = `font-size: 0.9rem; font-weight: 700;`; // Default style
                if (isReturn) {
                    headerLabel = 'Returned';
                    headerStyle = `font-size: 0.75rem; font-weight: bold;`; // Custom style for Returned
                } else if (isCopy) {
                    if (editedTimestamp) {
                        headerLabel = 'فاتورة معدلة';
                    } else {
                        headerLabel = 'Copy';
                        headerStyle = `font-size: 0.75rem; font-weight: bold;`; // Custom style for Copy
                    }
                }
                
                let headerHTML = forPreview ? `
                    <div class="flex justify-between items-center p-4 border-b" style="border-bottom-color: ${colors.border}; font-family: var(--font-sans);">
                        <h3 class="text-xl font-bold" style="color: ${colors.heading};">${isReturn ? "Return Receipt" : "Invoice Preview"}</h3>
                        <div class="flex items-center gap-2">
                            <button id="download-preview-jpg-btn" class="p-2 rounded-full hover:bg-gray-100" title="Download as JPG">
                                <i data-lucide="download" class="w-5 h-5" style="color: ${colors.text};"></i>
                            </button>
                            <button id="close-preview-btn" class="p-2 rounded-full hover:bg-gray-100">
                                <i data-lucide="x" class="w-6 h-6" style="color: ${colors.text};"></i>
                            </button>
                        </div>
                    </div>
                ` : '';

                let receiptBodyHTML = `
                <div style="font-family: 'Tajawal', sans-serif; color: ${colors.text}; direction: rtl; font-size: 0.9rem;">
                    ${headerLabel ? `<div style="text-align: center; color: ${colors.text}; margin-bottom: 4px; ${headerStyle}">${headerLabel}</div>` : ''}
                    
                    <div style="text-align: center; margin-bottom: 10px;">
                        ${workerPermissions.shopName ? `<h2 style="font-size: 1.8rem; font-weight: 700; margin: 5px 0 0 0; color: ${colors.heading};">${workerPermissions.shopName}</h2>` : ''}
                        ${workerPermissions.invoiceAddress ? `<p style="font-size: 0.85rem; font-weight: 500; margin: 4px 0 8px 0; line-height: 1.4;">${workerPermissions.invoiceAddress.replace(/\n/g, '<br>')}</p>` : ''}
                    </div>
                    
                    <div style="font-size: 0.85rem; margin: 10px 0; padding: 5px 0; line-height: 1.7;">
                        <div style="display: flex; justify-content: space-between;"><span>التاريخ / الوقت:</span><span style="font-family: monospace; direction: ltr;">${getEnglishDateTime(editedTimestamp || timestamp)}</span></div>
                        ${(sellerName && sellerName !== 'N/A') || (cashierCode && cashierCode !== 'N/A') ? `<div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 4px;"><span>اسم البائع: ${sellerName || 'N/A'}</span><span>كود الكاشير: ${cashierCode || 'N/A'}</span></div>` : ''}
                        ${workerPermissions.branchInfo || workerPermissions.machineNumber ? `<div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 2px;"><span>رقم الفرع: ${workerPermissions.branchInfo}</span><span>رقم الماكينة: ${workerPermissions.machineNumber}</span></div>` : ''}
                        ${workerPermissions.contactNumber ? `<div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 2px;"><span>رقم التواصل:</span><span style="direction: ltr;">${workerPermissions.contactNumber}</span></div>` : ''}
                        <hr style="border:none; border-top: 1px dashed ${colors.faint}; margin: 4px 0;"/>
                        ${customerPhone && customerPhone.trim() && customerPhone.trim() !== 'N/A' ? `<div style="display: flex; justify-content: space-between;"><span>رقم العميل:</span><span>${customerPhone}</span></div>` : ''}
                        ${customerName && customerName.trim() && customerName.trim() !== 'N/A' ? `<div style="display: flex; justify-content: space-between;"><span>اسم العميل:</span><span>${customerName}</span></div>` : ''}
                        ${notes && notes.trim() ? `<div style="margin-top: 4px;"><span style="font-weight: bold;">ملاحظات:</span><div style="font-size: 0.8rem; padding-right: 10px;">${notes.replace(/\n/g, '<br>')}</div></div>` : ''}
                    </div>

                    <div style="text-align: center; font-weight: 700; font-size: 1rem; margin: 8px 0;">الأصناف</div>

                    <table style="width: 100%; font-size: 0.9rem; border-collapse: collapse; text-align: right; margin-top: 5px;">
                        <thead>
                            <tr style="border-bottom: 1px solid ${colors.faint};">
                                <th style="padding: 4px; width: ${hasItemDiscounts ? '40%' : '60%'}; text-align: right; font-weight: 500;">الصنف</th>
                                <th style="padding: 4px; text-align: center; font-weight: bold;">الكمية</th>
                                <th style="padding: 4px; text-align: center; font-weight: bold;">السعر</th>
                                ${hasItemDiscounts ? `<th style="padding: 4px; text-align: center; font-weight: bold;">الخصم</th>` : ''}
                                <th style="padding: 4px; text-align: left; font-weight: bold;">الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr style="border-bottom: 1px dotted #555;">
                                    <td style="padding: 4px; text-align: right; font-weight: bold;">${item.name}</td>
                                    <td style="padding: 4px; text-align: center; font-weight: normal;">${item.quantity}</td>
                                    <td style="padding: 4px; text-align: center; font-weight: normal;">${item.price.toFixed(2)}</td>
                                    ${hasItemDiscounts ? `<td style="padding: 4px; text-align: center; font-weight: normal;">${(item.discount || 0).toFixed(2)}</td>` : ''}
                                    <td style="padding: 4px; text-align: left; font-family: monospace; font-weight: bold;">${((item.price * item.quantity) - (item.discount || 0)).toFixed(2)}</td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 10px; font-size: 14px; line-height: 1.8;">
                        <div style="display: flex; justify-content: space-between;"><span style="font-weight: bold;">الإجمالي الفرعي:</span><span style="font-weight: bold; font-family: monospace;">${subtotal.toFixed(2)}</span></div>
                        ${hasItemDiscounts ? `<div style="display: flex; justify-content: space-between;"><span style="font-weight: bold;">خصم الأصناف:</span><span style="font-weight: bold; font-family: monospace;">${itemsDiscount.toFixed(2)}</span></div>` : ''}
                        ${hasInvoiceDiscount ? `<div style="display: flex; justify-content: space-between;"><span style="font-weight: bold;">خصم الفاتورة:</span><span style="font-weight: bold; font-family: monospace;">${(invoiceDiscount || 0).toFixed(2)}</span></div>` : ''}
                        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem; margin-top: 6px; padding: 4px 0;">
                            <span>صافي القيمة:</span><span style="font-family: monospace;">${total.toFixed(2)}</span>
                        </div>
                        <hr style="border:none; border-top: 1px dotted #555; margin: 4px 0;"/>
                        <div style="display: flex; justify-content: space-between;"><span style="font-weight: bold;">وسيلة الدفع:</span><span style="font-weight: bold;">${paymentMethod}</span></div>
                        <div style="display: flex; justify-content: space-between;"><span style="font-weight: bold;">المدفوع:</span><span style="font-weight: bold; font-family: monospace;">${tendered.toFixed(2)}</span></div>
                        <div style="display: flex; justify-content: space-between; font-weight: 900; font-size: 1.1rem; color: ${colors.heading};">
                            <span>المتبقي:</span><span style="font-family: monospace;">${change.toFixed(2)}</span>
                        </div>
                    </div>
                    <div style="border-top: 1px dotted ${colors.faint}; margin: 8px 0 2px 0;"></div>
                    <div style="border-top: 1px dotted ${colors.faint}; margin: 2px 0 8px 0;"></div>
                        <div style="border-top: 1px dotted ${colors.faint}; margin: 8px 0 2px 0;"></div>
                        <div style="border-top: 1px dotted ${colors.faint}; margin: 2px 0 8px 0;"></div>
                        ${workerPermissions.returnPolicy ? `<div style="margin-top: 10px; font-size: 0.8rem; text-align: center;"><p style="margin: 2px 0; line-height: 1.5;">${workerPermissions.returnPolicy.replace(/\n/g, '<br>')}</p></div>` : ''}

                    <div style="text-align: center; margin-top: 15px;">
                        ${workerPermissions.facebookLink && workerPermissions.facebookLink.trim() !== '' ? `<div id="qrcode-placeholder"></div>` : ''}
                        <p style="font-family: monospace; font-size: 0.8rem; margin-top: 4px; font-weight: bold;">${id}${isReturn ? ` | ${originalInvoiceId}` : ''}</p>
                    </div>
                    
                    <div style="text-align: center; font-size: 0.6rem; color: #000000; margin-top: 15px; padding-top: 5px; border-top: 1px solid #eee;">
                        powered by Al-Badr<br>01069913150
                    </div>
                </div>
                `;
                
                return forPreview ? `${headerHTML}<div class="p-4 overflow-y-auto">${receiptBodyHTML}</div>` : receiptBodyHTML;
            };

            const printHTML = (content) => {
                const existingFrame = document.getElementById('print-frame');
                if (existingFrame) {
                    existingFrame.remove();
                }

                const iframe = document.createElement('iframe');
                iframe.id = 'print-frame';
                iframe.style.position = 'fixed';
                iframe.style.visibility = 'hidden';
                iframe.style.width = '0';
                iframe.style.height = '0';
                iframe.style.border = '0';
                document.body.appendChild(iframe);

                const printDoc = iframe.contentWindow.document;

                printDoc.open();
                printDoc.write(`
                    <html>
                    <head>
                        <title>Print</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <style>
                            body {
                                margin: 0;
                                font-family: Arial, sans-serif;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            @page {
                                margin: 5mm;
                                size: 80mm auto;
                            }
                        </style>
                    </head>
                    <body>
                        ${content}
                    </body>
                    </html>
                `);
                printDoc.close();

                // Delay print to ensure fonts are loaded, which helps with alignment
                setTimeout(() => {
                    try {
                        iframe.contentWindow.focus();
                        iframe.contentWindow.addEventListener('afterprint', () => {
                            if (document.body.contains(iframe)) {
                                document.body.removeChild(iframe);
                            }
                        });
                        iframe.contentWindow.print();
                    } catch (e) {
                        console.error("Printing failed:", e);
                        showAlert("Could not open print dialog. Please check your browser's settings.");
                        if (document.body.contains(iframe)) {
                            document.body.removeChild(iframe);
                        }
                    }
                }, 500);
            };

            const generateAndSavePDF = async (invoiceData, printType = 'fresh') => {
                 if (!invoiceData) {
                      showAlert("Invoice data is unavailable.");
                      return;
                 }
                
                let receiptHTML = generateReceiptHTML(invoiceData, printType, false);

                // If a link exists, generate QR and inject it. Otherwise, print directly.
                if (workerPermissions.facebookLink && workerPermissions.facebookLink.trim() !== '') {
                    const tempQrDiv = document.createElement('div');
                    tempQrDiv.id = 'temp-qr-code-container';
                    tempQrDiv.style.position = 'absolute';
                    tempQrDiv.style.top = '-9999px';
                    tempQrDiv.style.left = '-9999px';
                    document.body.appendChild(tempQrDiv);

                    new QRCode(tempQrDiv, {
                        text: workerPermissions.facebookLink,
                        width: 100,
                        height: 100,
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    setTimeout(() => {
                        const canvas = tempQrDiv.querySelector('canvas');
                        if (canvas) {
                            const qrCodeDataUrl = canvas.toDataURL();
                            const qrCodeImageHTML = `<img src="${qrCodeDataUrl}" alt="QR Code" style="width: 100px; height: 100px; display: block; margin-left: auto; margin-right: auto;">`;
                            receiptHTML = receiptHTML.replace('<div id="qrcode-placeholder"></div>', qrCodeImageHTML);
                        } else {
                            showAlert('Failed to generate QR code for printing.');
                            receiptHTML = receiptHTML.replace('<div id="qrcode-placeholder"></div>', '');
                        }
                        printHTML(receiptHTML);
                        document.body.removeChild(tempQrDiv);
                    }, 100);
                } else {
                    // No link, so just print the HTML which won't have the placeholder.
                    printHTML(receiptHTML);
                }
            };
            
            const generateAndDownloadImage = async (invoiceData, format = 'png') => {
                if (!invoiceData || typeof html2canvas === 'undefined') {
                    showAlert(`Invoice data is unavailable or required libraries are not ready.`);
                    return;
                }
                
                let receiptHTML = generateReceiptHTML(invoiceData, 'copy', false);

                const renderAndDownload = async (finalHTML) => {
                    const renderContainer = document.createElement('div');
                    renderContainer.style.position = 'absolute';
                    renderContainer.style.left = '-9999px';
                    renderContainer.style.width = '80mm'; 
                    renderContainer.style.background = 'white';
                    renderContainer.style.boxSizing = 'border-box';
                    renderContainer.style.padding = "5mm";
                    renderContainer.innerHTML = finalHTML;
                    document.body.appendChild(renderContainer);

                    try {
                        await new Promise(resolve => setTimeout(resolve, 300));

                        const canvas = await html2canvas(renderContainer, { 
                            scale: 3, 
                            useCORS: true,
                            backgroundColor: '#ffffff'
                        });
                        
                        const mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
                        const quality = format === 'jpg' ? 0.9 : 1.0;
                        const dataUrl = canvas.toDataURL(mimeType, quality);

                        const link = document.createElement('a');
                        link.download = `invoice-${invoiceData.id}.${format}`;
                        link.href = dataUrl;
                        link.click();

                    } catch (error) {
                        console.error(`Error generating ${format.toUpperCase()}:`, error);
                        showAlert(`An error occurred while generating the ${format.toUpperCase()} image.`);
                    } finally {
                        document.body.removeChild(renderContainer);
                    }
                };

                if (workerPermissions.facebookLink && workerPermissions.facebookLink.trim() !== '') {
                    const tempQrDiv = document.createElement('div');
                    tempQrDiv.style.position = 'absolute';
                    tempQrDiv.style.top = '-9999px';
                    document.body.appendChild(tempQrDiv);

                    new QRCode(tempQrDiv, {
                        text: workerPermissions.facebookLink,
                        width: 100,
                        height: 100,
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    setTimeout(async () => {
                        const canvasQR = tempQrDiv.querySelector('canvas');
                        if (canvasQR) {
                            const qrCodeDataUrl = canvasQR.toDataURL();
                            const qrCodeImageHTML = `<img src="${qrCodeDataUrl}" alt="QR Code" style="width: 100px; height: 100px; display: block; margin-left: auto; margin-right: auto;">`;
                            receiptHTML = receiptHTML.replace('<div id="qrcode-placeholder"></div>', qrCodeImageHTML);
                        } else {
                            showAlert('Failed to generate QR code for image.');
                            receiptHTML = receiptHTML.replace('<div id="qrcode-placeholder"></div>', '');
                        }
                        document.body.removeChild(tempQrDiv);
                        await renderAndDownload(receiptHTML);
                    }, 200);
                } else {
                    await renderAndDownload(receiptHTML);
                }
            };

            const generateAndDownloadJPG = async (invoiceData) => {
                await generateAndDownloadImage(invoiceData, 'jpg');
            };

            const generateAndDownloadPNG = async (invoiceData) => {
                await generateAndDownloadImage(invoiceData, 'png');
            };

            const displayReceiptPreview = () => {
                if (cart.length === 0) {
                    showAlert('Cart is empty, cannot preview invoice.');
                    return;
                }
                const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const itemsDiscount = cart.reduce((sum, item) => sum + (item.discount || 0), 0);
                const invoiceDiscount = parseFloat(invoiceDiscountInput.value) || 0;
                const total = subtotal - itemsDiscount - invoiceDiscount;
                let finalTendered = parseFloat(tenderedInput.value);
                if (isNaN(finalTendered) || tenderedInput.value.trim() === '') {
                    finalTendered = isReturnMode ? -total : total;
                }
                
                const cashierSelect = document.getElementById('cashier-select');
                const selectedCashierIndex = cashierSelect.value;
                const selectedCashier = selectedCashierIndex !== '' ? workerPermissions.cashiers[selectedCashierIndex] : null;

                const previewInvoiceObject = {
                    id: editingInvoiceInternalId || (isReturnMode ? generateInvoiceId('RET') : generateInvoiceId()),
                    date: saleDate,
                    customerName: customerNameInput.value,
                    customerPhone: customerPhoneInput.value,
                    items: cart,
                    subtotal, discount: itemsDiscount, invoiceDiscount, total, tendered: finalTendered,
                    paymentMethod: paymentMethodSelect.value,
                    originalInvoiceId: originalInvoiceForReturn ? originalInvoiceForReturn.id : null,
                    timestamp: Date.now(),
                    cashierCode: selectedCashier ? selectedCashier.code : 'N/A',
                    sellerName: selectedCashier ? selectedCashier.name : 'N/A',
                    notes: invoiceNotesInput.value
                };

                const previewHTML = generateReceiptHTML(previewInvoiceObject, isReturnMode ? 'return' : 'fresh', true);
                receiptPreviewArea.innerHTML = previewHTML;
                
                productsSection.classList.add('hidden');
                receiptPreviewArea.classList.remove('hidden');
                receiptPreviewArea.classList.add('flex');
                lucide.createIcons();
                document.getElementById('close-preview-btn').addEventListener('click', hideReceiptPreview);
                document.getElementById('download-preview-jpg-btn').addEventListener('click', () => generateAndDownloadJPG(previewInvoiceObject));
            };

            const hideReceiptPreview = () => {
                receiptPreviewArea.classList.add('hidden');
                receiptPreviewArea.classList.remove('flex');
                productsSection.classList.remove('hidden');
                receiptPreviewArea.innerHTML = '';
            };

            const checkSystemLock = () => {
                if (isLockOverridden) {
                    return;
                }

                const lockSettings = workerPermissions.systemLock;
                if (!lockSettings || !lockSettings.enabled) {
                    systemLockModal.classList.add('hidden');
                    return;
                }

                // Get current time in HH:MM format for Cairo
                const now = new Date();
                const currentTime = now.toLocaleTimeString('en-GB', { timeZone: 'Africa/Cairo', hour: '2-digit', minute: '2-digit' });
                
                const { lockTime, unlockTime } = lockSettings;

                let isLocked = false;
                // Handle overnight lock (e.g., lock at 23:00, unlock at 11:00)
                if (lockTime > unlockTime) {
                    if (currentTime >= lockTime || currentTime < unlockTime) {
                        isLocked = true;
                    }
                } 
                // Handle same-day lock (e.g., lock at 12:00, unlock at 17:00)
                else {
                    if (currentTime >= lockTime && currentTime < unlockTime) {
                        isLocked = true;
                    }
                }

                if (isLocked) {
                    systemLockMessage.textContent = `The system is currently locked. Access will be restored automatically at ${unlockTime}.`;
                    systemLockModal.classList.remove('hidden');
                    lucide.createIcons();
                } else {
                    systemLockModal.classList.add('hidden');
                    isLockOverridden = false; 
                }
            };

            const renderExpensesList = () => {
                let expensesToRender = firestoreExpenses;
                expensesToRender.sort((a, b) => b.timestamp - a.timestamp);
                expensesGrid.innerHTML = '';

                if (expensesToRender.length === 0) {
                    expensesGrid.innerHTML = `<div class="text-center text-slate-500 py-16"><i data-lucide="archive" class="mx-auto h-12 w-12"></i><p class="mt-2">No expenses recorded yet.</p></div>`;
                    lucide.createIcons();
                    return;
                }

                expensesToRender.forEach(expense => {
                    const dateObj = new Date(expense.timestamp);
                    const formattedDate = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    
                    const editButtonHTML = isDeveloperMode ? `
                        <button data-firestore-id="${expense.firestoreId}" class="edit-expense-btn flex items-center justify-center w-9 h-9 rounded-full bg-slate-100 hover:bg-yellow-100 text-slate-500 hover:text-yellow-600 transition-colors" title="Edit Expense">
                            <i data-lucide="pencil" class="h-5 w-5"></i>
                        </button>
                    ` : '';
                    
                    const deleteButtonHTML = isDeveloperMode ? `
                        <button data-firestore-id="${expense.firestoreId}" class="delete-expense-btn flex items-center justify-center w-9 h-9 rounded-full bg-slate-100 hover:bg-red-100 text-slate-500 hover:text-red-600 transition-colors" title="Delete Expense">
                            <i data-lucide="trash-2" class="h-5 w-5"></i>
                        </button>
                    ` : '';

                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden';
                    card.innerHTML = `
                        <div class="expense-card-header cursor-pointer p-4 grid grid-cols-12 gap-4 items-center hover:bg-slate-50 transition-colors">
                            <div class="col-span-12 sm:col-span-4 flex items-center gap-3">
                                <div class="w-10 h-10 flex-shrink-0 flex items-center justify-center bg-red-100 text-red-600 rounded-lg">
                                     <i data-lucide="trending-down" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-800">${expense.description}</p>
                                    <p class="text-sm text-slate-500">${expense.type}</p>
                                </div>
                            </div>
                            <div class="col-span-6 sm:col-span-3 text-slate-600 text-sm font-medium">${formattedDate}</div>
                            <div class="col-span-6 sm:col-span-3 text-lg font-bold text-red-600 text-right sm:text-left">${parseFloat(expense.amount).toFixed(2)} EGP</div>
                            <div class="col-span-12 sm:col-span-2 flex items-center justify-end gap-2">
                                 ${editButtonHTML}
                                 ${deleteButtonHTML}
                                <i data-lucide="chevron-down" class="chevron-icon transition-transform"></i>
                            </div>
                        </div>
                        <div class="expense-card-details hidden bg-slate-50/70 border-t border-slate-200 p-4">
                            <p class="text-sm text-slate-600"><span class="font-semibold">Notes:</span> ${expense.notes || 'No notes provided.'}</p>
                        </div>
                    `;
                    expensesGrid.appendChild(card);
                });
                lucide.createIcons();
            };

            const updateClock = () => {
                const now = new Date();
                const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
                const clockEl = document.getElementById('live-clock');
                if (clockEl) {
                    clockEl.textContent = now.toLocaleString('en-US', options);
                }
            };
            
            const renderInventoryList = () => {
                const searchTerm = inventorySearchInput.value.toLowerCase();
                let productsToRender = products.filter(p => {
                    const nameMatch = p.name.toLowerCase().includes(searchTerm);
                    const codeMatch = p.codes && p.codes.some(c => c.code.toLowerCase().includes(searchTerm));
                    return nameMatch || codeMatch;
                });
                productsToRender.sort((a, b) => a.name.localeCompare(b.name, 'ar'));

                inventoryGrid.innerHTML = '';
                if (productsToRender.length === 0) {
                    inventoryGrid.innerHTML = '<p class="col-span-full text-center text-[var(--text-secondary)] py-10">No products found.</p>';
                    return;
                }

                productsToRender.forEach(product => {
                    const card = document.createElement('div');
                    const isUnlimited = product.quantity === Infinity;
                    const isOutOfStock = !isUnlimited && product.quantity <= 0;
                    const isLowStock = !isUnlimited && product.quantity > 0 && product.quantity <= 5;

                    const hasCodes = product.codes && product.codes.length > 0;
                    const discount = product.discount || 0;

                    // Stock Progress Bar Logic
                    let stockPercentage = 0;
                    let stockColorClass = 'bg-red-500'; // Out of stock
                    if (isUnlimited) {
                        stockPercentage = 100;
                        stockColorClass = 'bg-sky-500';
                    } else if (!isOutOfStock) {
                        // Assuming "full" stock is 50 for visualization.
                        stockPercentage = Math.min((product.quantity / 50) * 100, 100);
                        if (stockPercentage > 20) {
                            stockColorClass = 'bg-green-500';
                        } else {
                            stockColorClass = 'bg-yellow-500';
                        }
                    }

                    let priceDisplayHTML = '';
                    if (discount > 0) {
                        const discountedPrice = product.price * (1 - discount / 100);
                        priceDisplayHTML = `
                            <p class="text-lg font-bold text-slate-400 line-through">${product.price.toFixed(2)}</p>
                            <p class="text-2xl font-black text-red-600">${discountedPrice.toFixed(2)}</p>
                        `;
                    } else {
                        priceDisplayHTML = `<p class="text-2xl font-black text-slate-900">${product.price.toFixed(2)}</p>`;
                    }

                    let detailsHTML = '';
                    if (hasCodes) {
                        const codesList = product.codes.map(code => {
                            const codePrice = code.price || product.price;
                            const codeDiscount = code.discount || 0;
                            let finalPrice = codePrice;
                            if (codeDiscount > 0) {
                                finalPrice = codePrice * (1 - codeDiscount / 100);
                            }
                            return `
                            <div class="flex justify-between items-center text-sm py-2 border-b border-slate-100 last:border-b-0">
                                <div>
                                    <span class="text-slate-700 font-semibold">${code.code} ${codeDiscount > 0 ? `<span class="text-xs text-red-500 font-bold">(-${codeDiscount}%)</span>` : ''}</span>
                                    <span class="ml-2 text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-full font-mono">${code.quantity} units</span>
                                </div>
                                <div class="text-right">
                                    ${codeDiscount > 0 ? `<span class="text-xs font-bold text-slate-400 line-through">${codePrice.toFixed(2)}</span>` : ''}
                                    <span class="font-mono font-bold text-slate-800 ml-1">${finalPrice.toFixed(2)} EGP</span>
                                </div>
                            </div>
                        `}).join('');

                        detailsHTML = `
                            <div class="inventory-card-details">
                                <div class="p-4 bg-slate-50/70 border-t border-slate-200/60">
                                    <h5 class="text-xs font-bold text-slate-500 uppercase mb-2">Variations & Stock</h5>
                                    <div class="space-y-1">${codesList}</div>
                                </div>
                            </div>
                        `;
                    }

                    card.className = 'inventory-card bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden flex flex-col transition-all hover:shadow-lg hover:border-blue-400/50 group relative';
                    card.innerHTML = `
                        <div class="p-4 flex-grow cursor-pointer inventory-card-header">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center bg-slate-100 rounded-lg">
                                    <i data-lucide="package" class="w-7 h-7 text-slate-500"></i>
                                </div>
                                <div class="flex-grow">
                                    <p class="font-bold text-slate-800 leading-tight">${product.name}</p>
                                    <div class="flex items-baseline mt-1 gap-2">
                                        ${priceDisplayHTML}
                                        <span class="text-sm font-semibold text-slate-500">EGP</span>
                                    </div>
                                </div>
                            </div>
                             ${discount > 0 ? `<div class="absolute top-2 right-2 px-2 py-1 bg-red-500 text-white text-xs font-bold rounded-full z-10">-${discount}%</div>` : ''}

                            <div class="mt-4">
                                <div class="flex justify-between items-center text-sm font-medium text-slate-500 mb-1">
                                    <span>Stock Level</span>
                                    <span class="font-bold font-mono ${isUnlimited ? 'text-sky-600' : (isLowStock ? 'text-yellow-600' : (isOutOfStock ? 'text-red-600' : 'text-green-600'))}">
                                        ${isUnlimited ? 'Unlimited' : product.quantity}
                                    </span>
                                </div>
                                <div class="stock-progress-bar">
                                    <div class="stock-progress-bar-inner ${stockColorClass}" style="width: ${stockPercentage}%;"></div>
                                </div>
                            </div>
                             ${hasCodes ? `
                                <div class="flex items-center gap-2 mt-3 text-purple-600 bg-purple-50 px-2 py-1 rounded-md text-xs font-bold">
                                    <i data-lucide="git-branch-plus" class="w-4 h-4"></i>
                                    <span>${product.codes.length} Variations</span>
                                    <i data-lucide="chevron-down" class="chevron-icon transition-transform ml-auto"></i>
                                </div>` 
                                : ''
                             }
                        </div>
                        ${detailsHTML}
                         <div class="border-t border-slate-200/80">
                             <button data-id="${product.id}" class="inventory-edit-btn w-full flex items-center justify-center gap-2 py-2.5 text-sm rounded-b-xl bg-slate-50 hover:bg-yellow-100 text-slate-600 hover:text-yellow-800 font-semibold transition-colors">
                                <i data-lucide="pencil" class="h-4 w-4 pointer-events-none"></i>
                                <span>Edit Product Details</span>
                            </button>
                        </div>
                    `;
                    inventoryGrid.appendChild(card);
                });
                lucide.createIcons();
            };

            const openEditProductModal = (productToEdit) => {
                if (productToEdit) {
                    editProductIdInput.value = productToEdit.id;
                    editProductNameInput.value = productToEdit.name;
                    document.getElementById('edit-product-purchase-price').value = productToEdit.purchasePrice || '';
                    document.getElementById('edit-product-profit-margin').value = productToEdit.profitMargin || '';
                    editProductPriceInput.value = productToEdit.price;
                    document.getElementById('edit-product-discount').value = productToEdit.discount || '';
                    
                    const isUnlimited = productToEdit.quantity === Infinity;
                    editUnlimitedStockCheckbox.checked = isUnlimited;

                    const hasCodes = productToEdit.codes && productToEdit.codes.length > 0;
                    
                    editProductQuantityInput.disabled = isUnlimited || hasCodes;

                    if (isUnlimited) {
                        editProductQuantityInput.value = '';
                        editProductQuantityInput.placeholder = 'Unlimited';
                    } else {
                        editProductQuantityInput.value = productToEdit.quantity || 0;
                        editProductQuantityInput.placeholder = hasCodes ? 'Auto-calculated' : '';
                    }

                    productCodesList.innerHTML = '';
                    (productToEdit.codes || []).forEach(codeObj => {
                        const codeEl = document.createElement('div');
                        codeEl.className = 'product-code-entry bg-white p-3 rounded-xl border border-slate-200 flex flex-col sm:flex-row items-start sm:items-center gap-4 hover:bg-slate-50 cursor-pointer transition-colors';
                        codeEl.dataset.code = codeObj.code;
                        codeEl.dataset.purchasePrice = codeObj.purchasePrice || 0;
                        codeEl.dataset.profitMargin = codeObj.profitMargin || 0;
                        codeEl.dataset.price = codeObj.price || 0;
                        codeEl.dataset.quantity = codeObj.quantity || 0;
                        codeEl.dataset.discount = codeObj.discount || 0;
                        
                        codeEl.innerHTML = `
                             <div class="w-full sm:w-1/4 pointer-events-none">
                                <div class="flex items-center justify-between">
                                    <span class="font-bold text-slate-800 code-name">${codeObj.code}</span>
                                </div>
                            </div>
                            <div class="flex-grow grid grid-cols-2 sm:grid-cols-5 gap-2 w-full pointer-events-none">
                                <div>
                                    <label class="block text-xs font-medium text-slate-500">Purchase</label>
                                    <span class="font-semibold text-sm">${(codeObj.purchasePrice || 0).toFixed(2)}</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500">Profit %</label>
                                    <span class="font-semibold text-sm">${codeObj.profitMargin || 0}%</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500">Selling</label>
                                    <span class="font-semibold text-sm">${(codeObj.price || 0).toFixed(2)}</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500">Qty</label>
                                    <span class="font-semibold text-sm">${codeObj.quantity || 0}</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500">Disc. %</label>
                                    <span class="font-semibold text-sm">${codeObj.discount || 0}%</span>
                                </div>
                            </div>
                            <button class="delete-product-code-btn text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100 z-10">
                                <i data-lucide="x-circle" class="w-5 h-5 pointer-events-none"></i>
                            </button>
                        `;
                        
                        codeEl.querySelector('.delete-product-code-btn').onclick = (e) => {
                            e.stopPropagation(); // prevent opening the edit modal
                            e.target.closest('.product-code-entry').remove();
                            updateTotalQuantityInModal();
                        };

                        codeEl.addEventListener('click', () => openEditCodeModal(codeEl));
                        
                        productCodesList.appendChild(codeEl);
                    });

                    editProductNameInput.disabled = false;
                    editProductPriceInput.disabled = false;
                    modalDeleteProductBtn.style.display = 'flex';
                    editProductModal.classList.remove('hidden');
                    lucide.createIcons();
                }
            };

            const renderSavedInvoicesList = () => {
                let invoicesToRender = isOnlineMode ? firestoreInvoices : JSON.parse(localStorage.getItem('savedInvoices')) || [];
                let returnsToCalc = isOnlineMode ? firestoreReturns : JSON.parse(localStorage.getItem('savedReturns')) || [];
                
                const searchTerm = invoiceSearchInput.value.toLowerCase();
                const startDate = invoiceStartDateInput.value ? new Date(invoiceStartDateInput.value).setHours(0, 0, 0, 0) : null;
                const endDate = invoiceEndDateInput.value ? new Date(invoiceEndDateInput.value).setHours(23, 59, 59, 999) : null;

                if (searchTerm || startDate || endDate) {
                    invoicesToRender = invoicesToRender.filter(invoice => {
                        const searchMatch = !searchTerm ||
                            invoice.id.toLowerCase().includes(searchTerm) ||
                            invoice.customerName.toLowerCase().includes(searchTerm) ||
                            (invoice.customerPhone && invoice.customerPhone.toLowerCase().includes(searchTerm));

                        const dateMatch = (!startDate || invoice.timestamp >= startDate) &&
                                          (!endDate || invoice.timestamp <= endDate);

                        return searchMatch && dateMatch;
                    });
                }

                invoicesToRender.sort((a, b) => b.timestamp - a.timestamp);
                invoicesListTbody.innerHTML = '';
                let totalCash = 0, totalVodafone = 0, totalInstaPay = 0, totalCredit = 0, grandTotal = 0;
                let totalReturns = returnsToCalc.reduce((sum, ret) => sum + ret.total, 0);

                if (invoicesToRender.length === 0) {
                    invoicesListTbody.innerHTML = '<tr><td colspan="8" class="text-center text-[var(--text-secondary)] py-10">No invoices match the search criteria.</td></tr>';
                } else {
                    invoicesToRender.forEach(invoice => {
                        const dateObj = new Date(invoice.timestamp);
                        const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
                        const timeString = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                        const remaining = invoice.total - invoice.tendered;
                        const row = document.createElement('tr');
                        
                        const canManage = isDeveloperMode;

                        let actionsHTML = `
                        <div class="flex items-center justify-end gap-2">
                            <button data-id="${invoice.id}" class="view-invoice-details-btn flex items-center justify-center w-9 h-9 rounded-full bg-slate-100 hover:bg-blue-100 text-slate-500 hover:text-blue-600 transition-colors" title="View Details"><i data-lucide="eye" class="h-5 w-5"></i></button>
                            <button data-id="${invoice.id}" class="print-saved-invoice-btn flex items-center justify-center w-9 h-9 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 hover:text-slate-800 transition-colors" title="Print Copy"><i data-lucide="printer" class="h-5 w-5"></i></button>
                            <button data-firestore-id="${invoice.firestoreId || ''}" data-id="${invoice.id}" class="return-invoice-btn flex items-center justify-center w-9 h-9 rounded-full bg-slate-100 hover:bg-yellow-100 text-slate-500 hover:text-yellow-600 transition-colors" title="Return Invoice"><i data-lucide="undo-2" class="h-5 w-5"></i></button>
                        `;

                        if (canManage) {
                            actionsHTML += `<button data-firestore-id="${invoice.firestoreId || ''}" data-id="${invoice.id}" class="edit-invoice-btn flex items-center justify-center w-9 h-9 rounded-full bg-slate-100 hover:bg-green-100 text-slate-500 hover:text-green-600 transition-colors" title="Edit Invoice"><i data-lucide="file-edit" class="h-5 w-5"></i></button>`;
                            actionsHTML += `<button data-id="${invoice.id}" data-firestore-id="${invoice.firestoreId || ''}" class="delete-invoice-btn flex items-center justify-center w-9 h-9 rounded-full bg-slate-100 hover:bg-red-100 text-slate-500 hover:text-red-600 transition-colors" title="Delete Invoice"><i data-lucide="trash-2" class="h-5 w-5"></i></button>`;
                        }
                        
                        actionsHTML += `</div>`;

                        let editedHTML = '';
                        if (invoice.editedTimestamp) {
                            const editedDate = new Date(invoice.editedTimestamp);
                            const editedTime = editedDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                            editedHTML = `<div class="text-xs text-[var(--text-secondary)] font-mono">Edited at ${editedTime}</div>`;
                        }
                        
                        const totalDiscount = (invoice.discount || 0) + (invoice.invoiceDiscount || 0);

                        row.innerHTML = `
                            <td class="p-3"><div class="font-mono">${invoice.id}</div>${editedHTML}</td>
                            <td class="p-3"><div>${invoice.date}</div><div class="text-xs text-[var(--text-secondary)]">${dayName} - ${timeString}</div></td>
                            <td class="p-3">${invoice.customerName}</td>
                            <td class="p-3 font-bold text-[var(--accent-color)]">${invoice.total.toFixed(2)}</td>
                            <td class="p-3 font-bold text-green-600">${invoice.tendered.toFixed(2)}</td>
                            <td class="p-3 font-bold text-orange-600">${totalDiscount.toFixed(2)}</td>
                            <td class="p-3 font-bold text-red-600">${remaining.toFixed(2)}</td>
                            <td class="p-3 text-right">${actionsHTML}</td>
                        `;
                        invoicesListTbody.appendChild(row);
                        grandTotal += invoice.tendered;
                        if (invoice.paymentMethod === 'Cash') totalCash += invoice.tendered;
                        else if (invoice.paymentMethod === 'Vodafone Cash') totalVodafone += invoice.tendered;
                        else if (invoice.paymentMethod === 'InstaPay') totalInstaPay += invoice.tendered;
                        else if (invoice.paymentMethod === 'Credit') totalCredit += invoice.tendered;
                    });
                }
                invoicesSummaryTfoot.innerHTML = `
                    <tr>
                        <td colspan="8" class="p-4 bg-slate-100/50">
                            <div class="max-w-6xl mx-auto">
                                <h3 class="text-xl font-bold text-center text-slate-700 mb-6">Payments Summary (Current Filter)</h3>
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                    <!-- Grand Total Payments Card -->
                                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200/80 flex items-start gap-5">
                                        <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-xl shadow-md shadow-green-500/30">
                                            <i data-lucide="wallet" class="w-7 h-7"></i>
                                        </div>
                                        <div>
                                            <p class="text-base font-semibold text-slate-500">Total Payments</p>
                                            <p class="text-3xl font-black text-slate-800 tracking-tight">${grandTotal.toFixed(2)} EGP</p>
                                        </div>
                                    </div>
                                    <!-- Total Returns Card -->
                                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200/80 flex items-start gap-5">
                                        <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center bg-gradient-to-br from-red-500 to-rose-600 text-white rounded-xl shadow-md shadow-red-500/30">
                                            <i data-lucide="arrow-down-circle" class="w-7 h-7"></i>
                                        </div>
                                        <div>
                                            <p class="text-base font-semibold text-slate-500">Total Returns</p>
                                            <p class="text-3xl font-black text-slate-800 tracking-tight">${totalReturns.toFixed(2)} EGP</p>
                                        </div>
                                    </div>
                                    <!-- Net Total Card -->
                                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200/80 flex items-start gap-5">
                                        <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center bg-gradient-to-br from-blue-500 to-cyan-500 text-white rounded-xl shadow-md shadow-blue-500/30">
                                            <i data-lucide="receipt" class="w-7 h-7"></i>
                                        </div>
                                        <div>
                                            <p class="text-base font-semibold text-slate-500">Net Total</p>
                                            <p class="text-3xl font-black text-slate-800 tracking-tight">${(grandTotal + totalReturns).toFixed(2)} EGP</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200/80">
                                    <h4 class="text-lg font-bold text-slate-600 mb-4 text-center">Payment Method Breakdown</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <!-- Cash -->
                                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200/80 text-center">
                                            <div class="w-10 h-10 mx-auto flex items-center justify-center bg-teal-100 text-teal-600 rounded-full mb-2"><i data-lucide="banknote" class="w-6 h-6"></i></div>
                                            <p class="text-sm text-slate-500 font-semibold">Cash</p>
                                            <p class="font-bold text-slate-800 text-xl">${totalCash.toFixed(2)}</p>
                                        </div>
                                        <!-- Vodafone -->
                                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200/80 text-center">
                                            <div class="w-10 h-10 mx-auto flex items-center justify-center bg-red-100 text-red-600 rounded-full mb-2"><i data-lucide="smartphone" class="w-6 h-6"></i></div>
                                            <p class="text-sm text-slate-500 font-semibold">Vodafone</p>
                                            <p class="font-bold text-slate-800 text-xl">${totalVodafone.toFixed(2)}</p>
                                        </div>
                                        <!-- InstaPay -->
                                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200/80 text-center">
                                            <div class="w-10 h-10 mx-auto flex items-center justify-center bg-sky-100 text-sky-600 rounded-full mb-2"><i data-lucide="scan" class="w-6 h-6"></i></div>
                                            <p class="text-sm text-slate-500 font-semibold">InstaPay</p>
                                            <p class="font-bold text-slate-800 text-xl">${totalInstaPay.toFixed(2)}</p>
                                        </div>
                                        <!-- Credit -->
                                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200/80 text-center">
                                            <div class="w-10 h-10 mx-auto flex items-center justify-center bg-indigo-100 text-indigo-600 rounded-full mb-2"><i data-lucide="credit-card" class="w-6 h-6"></i></div>
                                            <p class="text-sm text-slate-500 font-semibold">Credit</p>
                                            <p class="font-bold text-slate-800 text-xl">${totalCredit.toFixed(2)}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                 lucide.createIcons();
            }

            const renderSavedReturnsList = () => {
                let returnsToRender = isOnlineMode ? firestoreReturns : JSON.parse(localStorage.getItem('savedReturns')) || [];
                
                const searchTerm = returnSearchInput.value.toLowerCase();
                const startDate = returnStartDateInput.value ? new Date(returnStartDateInput.value).setHours(0, 0, 0, 0) : null;
                const endDate = returnEndDateInput.value ? new Date(returnEndDateInput.value).setHours(23, 59, 59, 999) : null;

                if (searchTerm || startDate || endDate) {
                    returnsToRender = returnsToRender.filter(ret => {
                        const searchMatch = !searchTerm ||
                            ret.id.toLowerCase().includes(searchTerm) ||
                            ret.customerName.toLowerCase().includes(searchTerm) ||
                            ret.originalInvoiceId.toLowerCase().includes(searchTerm);

                        const dateMatch = (!startDate || ret.timestamp >= startDate) &&
                                          (!endDate || ret.timestamp <= endDate);

                        return searchMatch && dateMatch;
                    });
                }

                returnsToRender.sort((a, b) => b.timestamp - a.timestamp);
                returnsListTbody.innerHTML = '';
                if (returnsToRender.length === 0) {
                    returnsListTbody.innerHTML = '<tr><td colspan="6" class="text-center text-[var(--text-secondary)] py-10">No returns match the search criteria.</td></tr>';
                } else {
                    returnsToRender.forEach(ret => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="p-3 font-mono">${ret.id}</td>
                            <td class="p-3">${ret.date}</td>
                            <td class="p-3">${ret.customerName}</td>
                            <td class="p-3 font-mono">${ret.originalInvoiceId}</td>
                            <td class="p-3 font-bold text-red-600">${ret.total.toFixed(2)}</td>
                            <td class="p-3 text-right">
                                <div class="flex items-center justify-end gap-2">
                                    <button data-id="${ret.id}" class="view-return-details-btn flex items-center justify-center w-9 h-9 rounded-full bg-slate-100 hover:bg-blue-100 text-slate-500 hover:text-blue-600 transition-colors" title="View Details"><i data-lucide="eye" class="h-5 w-5"></i></button>
                                    <button data-id="${ret.id}" class="print-saved-return-btn flex items-center justify-center w-9 h-9 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 hover:text-slate-800 transition-colors" title="Print Return"><i data-lucide="printer" class="h-5 w-5"></i></button>
                                </div>
                            </td>
                        `;
                        returnsListTbody.appendChild(row);
                    });
                }
                lucide.createIcons();
            }

            const showSavedInvoicesView = async () => {
                renderSavedInvoicesList();
                posView.classList.add('hidden-view');
                returnsView.classList.add('hidden-view');
                expensesView.classList.add('hidden-view');
                invoicesView.classList.remove('hidden-view');
                invoicesView.classList.add('flex');
                 lucide.createIcons();
            };
            
            const showReturnsView = async () => {
                renderSavedReturnsList();
                posView.classList.add('hidden-view');
                invoicesView.classList.add('hidden-view');
                expensesView.classList.add('hidden-view');
                returnsView.classList.remove('hidden-view');
                returnsView.classList.add('flex');
                lucide.createIcons();
            };

            const showPosView = async () => {
                Object.values(activeTimers).forEach(clearInterval);
                activeTimers = {};
                invoicesView.classList.add('hidden-view');
                returnsView.classList.add('hidden-view');
                invoiceDetailsView.classList.add('hidden-view');
                expensesView.classList.add('hidden-view');
                inventoryView.classList.add('hidden-view');
                posView.classList.remove('hidden-view');
                posView.classList.add('flex'); 
            }
            
            const showExpensesView = () => {
                renderExpensesList();
                posView.classList.add('hidden-view');
                invoicesView.classList.add('hidden-view');
                returnsView.classList.add('hidden-view');
                invoiceDetailsView.classList.add('hidden-view');
                expensesView.classList.remove('hidden-view');
                expensesView.classList.add('flex');
                deleteAllExpensesBtn.style.display = isDeveloperMode ? 'flex' : 'none';
                lucide.createIcons();
            };

            const showInventoryView = () => {
                renderInventoryList();
                posView.classList.add('hidden-view');
                invoicesView.classList.add('hidden-view');
                returnsView.classList.add('hidden-view');
                invoiceDetailsView.classList.add('hidden-view');
                expensesView.classList.add('hidden-view');
                inventoryView.classList.remove('hidden-view');
                inventoryView.classList.add('flex');
                lucide.createIcons();
            };

            const confirmAction = async (title, message) => {
                if (isDeveloperMode) {
                    return true;
                }

                if (isOnlineMode) {
                    const user = auth.currentUser;
                    if (!user) {
                        showAlert('You must be logged in to perform this action.');
                        return false;
                    }
                    reauthConfirmModal.classList.remove('hidden');
                    const userConfirmed = await new Promise(resolve => {
                        reauthConfirmBtn.onclick = () => resolve(true);
                        reauthCancelBtn.onclick = () => resolve(false);
                    });
                    reauthConfirmModal.classList.add('hidden');
                    if (!userConfirmed) return false;
                    const provider = new GoogleAuthProvider();
                    try {
                        await reauthenticateWithPopup(user, provider);
                        return true;
                    } catch (error) {
                        if (error.code === 'auth/popup-closed-by-user') {
                            showAlert('Identity confirmation was canceled.');
                        } else {
                            showAlert('Identity verification failed.');
                        }
                        return false;
                    }
                } else {
                    const password = await showPasswordModal(title, message);
                    if (password === "123") { 
                        return true;
                    } else if (password !== null) {
                        await showAlert('Incorrect password.');
                        return false;
                    }
                    return false;
                }
            };

            const confirmDangerousAction = async (title, message) => {
                const password = await showPasswordModal(title, `${message}\nPlease enter the manager password to proceed.`);
                if (password === workerPassword) {
                    return true;
                } else if (password !== null) {
                    await showAlert('Incorrect manager password. Action cancelled.');
                    return false;
                }
                return false; // User cancelled
            };

            const deleteInvoice = async (invoiceId, firestoreId) => {
                const confirmed = await confirmAction('Confirm Deletion', 'Are you sure you want to delete this invoice?');
                if (confirmed && isOnlineMode) {
                    try {
                        const docRef = doc(db, `users/${userId}/invoices`, firestoreId);
                        await deleteDoc(docRef);
                        await showAlert('Invoice deleted successfully.');
                    } catch (error) {
                        await showAlert('An error occurred while deleting the invoice.');
                    }
                }
            };
            
            const deleteAllInvoices = async () => {
                const confirmed = await confirmDangerousAction('Delete All Invoices', 'Are you absolutely sure? This action cannot be undone.');
                if (confirmed && isOnlineMode) {
                     try {
                        const invoicesCollectionPath = `users/${userId}/invoices`;
                        const querySnapshot = await getDocs(collection(db, invoicesCollectionPath));
                        const batch = writeBatch(db);
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        await showAlert('All invoices have been deleted successfully.');
                         } catch (error) {
                             await showAlert('An error occurred while deleting all invoices.');
                         }
                }
            };
            
            const deleteAllReturns = async () => {
                const confirmed = await confirmDangerousAction('Delete All Returns', 'Are you absolutely sure you want to delete all return records? This action cannot be undone.');
                if (confirmed && isOnlineMode) {
                    try {
                        const returnsCollectionPath = `users/${userId}/returns`;
                        const querySnapshot = await getDocs(collection(db, returnsCollectionPath));
                        const batch = writeBatch(db);
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        await showAlert('All returns have been deleted successfully.');
                    } catch (error) {
                        console.error("Error deleting all returns:", error);
                        await showAlert('An error occurred while deleting all returns.');
                    }
                }
            };

            const deleteAllArchiveData = async () => {
                const confirmed = await confirmDangerousAction('Delete All Archive Data', 'Are you absolutely sure you want to delete all invoice archive records? This action cannot be undone.');
                if (confirmed && isOnlineMode) {
                    try {
                        const archiveCollectionPath = `users/${userId}/invoice_archive`;
                        const querySnapshot = await getDocs(collection(db, archiveCollectionPath));
                        if (querySnapshot.empty) {
                            showAlert("There is no archive data to delete.");
                            return;
                        }
                        const batch = writeBatch(db);
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        await showAlert('All invoice archive data has been deleted successfully.');
                    } catch (error) {
                        console.error("Error deleting all archive data:", error);
                        await showAlert('An error occurred while deleting the archive data.');
                    }
                }
            };

            const showInvoiceDetails = async (invoiceId) => {
                let invoicesToSearch = isOnlineMode ? firestoreInvoices : JSON.parse(localStorage.getItem('savedInvoices')) || [];
                const invoice = invoicesToSearch.find(inv => inv.id === invoiceId);
                if (!invoice) return;

                let returnsForThisInvoice = [];
                if(isOnlineMode) {
                    const q = query(collection(db, `users/${userId}/returns`), where("originalInvoiceId", "==", invoiceId));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => {
                        returnsForThisInvoice.push(doc.data());
                    });
                } else {
                    const allReturns = JSON.parse(localStorage.getItem('savedReturns')) || [];
                    returnsForThisInvoice = allReturns.filter(r => r.originalInvoiceId === invoiceId);
                }

                const createDetailsBlock = (invoiceData, title, isReturn = false, isComparison = false) => {
                    let itemsHTML = '';
                    invoiceData.items.forEach(item => {
                        const itemTotal = (item.price * item.quantity) - (item.discount || 0);
                        itemsHTML += `
                            <tr class="border-b border-slate-100 last:border-b-0">
                                <td class="p-3 text-right">
                                    <p class="font-semibold text-slate-800">${item.name}</p>
                                    <p class="text-xs text-slate-500">${item.quantity} x ${item.price.toFixed(2)}</p>
                                </td>
                                <td class="p-3 text-center text-red-600 font-mono">${(item.discount || 0).toFixed(2)}</td>
                                <td class="p-3 text-left font-bold text-slate-800 font-mono">${itemTotal.toFixed(2)}</td>
                            </tr>`;
                    });
                    
                    const totalDiscount = (invoiceData.discount || 0) + (invoiceData.invoiceDiscount || 0);
                    const change = invoiceData.tendered - invoiceData.total;

                    return `
                        <div class="bg-white rounded-2xl shadow-lg border border-slate-200/80 overflow-hidden flex flex-col h-full">
                            <div class="p-5 ${isReturn ? 'bg-red-50' : (isComparison ? 'bg-blue-50' : 'bg-slate-50')} border-b border-slate-200">
                                <h4 class="text-xl font-bold ${isReturn ? 'text-red-700' : (isComparison ? 'text-blue-700' : 'text-slate-800')} flex items-center gap-3">
                                    <i data-lucide="${isReturn ? 'receipt' : (isComparison ? 'copy' : 'file-text')}" class="w-6 h-6"></i>
                                    <span>${title}</span>
                                </h4>
                                ${invoiceData.editedTimestamp ? `<p class="text-xs text-slate-500 font-mono mt-1 pl-9">Edited: ${new Date(invoiceData.editedTimestamp).toLocaleString('ar-EG-u-nu-latn')}</p>` : ''}
                            </div>

                            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                                <div class="flex items-start gap-3"><i data-lucide="hash" class="w-5 h-5 text-slate-400 mt-1 flex-shrink-0"></i><div><p class="text-slate-500">رقم الفاتورة</p><p class="font-bold text-slate-700 font-mono">${invoiceData.id}</p></div></div>
                                <div class="flex items-start gap-3"><i data-lucide="calendar" class="w-5 h-5 text-slate-400 mt-1 flex-shrink-0"></i><div><p class="text-slate-500">التاريخ</p><p class="font-bold text-slate-700">${new Date(invoiceData.timestamp).toLocaleDateString('ar-EG-u-nu-latn', { year: 'numeric', month: 'long', day: 'numeric', hour:'2-digit', minute:'2-digit' })}</p></div></div>
                                <div class="flex items-start gap-3"><i data-lucide="user" class="w-5 h-5 text-slate-400 mt-1 flex-shrink-0"></i><div><p class="text-slate-500">العميل</p><p class="font-bold text-slate-700">${invoiceData.customerName || 'N/A'}</p></div></div>
                                <div class="flex items-start gap-3"><i data-lucide="phone" class="w-5 h-5 text-slate-400 mt-1 flex-shrink-0"></i><div><p class="text-slate-500">الهاتف</p><p class="font-bold text-slate-700">${invoiceData.customerPhone || 'N/A'}</p></div></div>
                                ${!isReturn ? `
                                <div class="flex items-start gap-3"><i data-lucide="credit-card" class="w-5 h-5 text-slate-400 mt-1 flex-shrink-0"></i><div><p class="text-slate-500">وسيلة الدفع</p><p class="font-bold text-slate-700">${invoiceData.paymentMethod}</p></div></div>
                                <div class="flex items-start gap-3"><i data-lucide="user-check" class="w-5 h-5 text-slate-400 mt-1 flex-shrink-0"></i><div><p class="text-slate-500">البائع</p><p class="font-bold text-slate-700">${invoiceData.sellerName || 'N/A'} (${invoiceData.cashierCode || 'N/A'})</p></div></div>
                                ` : `
                                <div class="flex items-start gap-3"><i data-lucide="file-input" class="w-5 h-5 text-slate-400 mt-1 flex-shrink-0"></i><div><p class="text-slate-500">الفاتورة الأصلية</p><p class="font-bold text-slate-700 font-mono">${invoiceData.originalInvoiceId}</p></div></div>
                                `}
                            </div>

                            <div class="px-5 pb-5 flex-grow">
                                <h5 class="font-bold text-slate-600 mb-2">الأصناف</h5>
                                <div class="border rounded-lg overflow-hidden">
                                    <table class="w-full text-sm">
                                        <thead class="bg-slate-50">
                                            <tr>
                                                <th class="p-3 text-right font-semibold text-slate-500">الصنف</th>
                                                <th class="p-3 text-center font-semibold text-slate-500">الخصم</th>
                                                <th class="p-3 text-left font-semibold text-slate-500">الإجمالي</th>
                                            </tr>
                                        </thead>
                                        <tbody>${itemsHTML}</tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="p-5 bg-slate-50 border-t border-slate-200 mt-auto">
                                <div class="max-w-sm ml-auto space-y-2 text-right text-sm">
                                    <div class="flex justify-between items-center text-slate-600"><span>الإجمالي الفرعي:</span><span class="font-mono font-semibold">${invoiceData.subtotal.toFixed(2)}</span></div>
                                    ${!isReturn ? `<div class="flex justify-between items-center text-slate-600"><span>إجمالي الخصم:</span><span class="font-mono font-semibold text-red-600">${totalDiscount.toFixed(2)}</span></div>` : ''}
                                    <hr class="border-slate-200">
                                    <div class="flex justify-between items-center font-bold text-xl ${isReturn ? 'text-red-700' : 'text-slate-800'}"><span>الإجمالي:</span><span class="font-mono">${invoiceData.total.toFixed(2)}</span></div>
                                    ${!isReturn ? `
                                    <div class="flex justify-between items-center text-slate-600"><span>المدفوع:</span><span class="font-mono font-semibold">${invoiceData.tendered.toFixed(2)}</span></div>
                                    <div class="flex justify-between items-center font-bold text-lg ${change >= 0 ? 'text-green-600' : 'text-red-600'}"><span>المتبقي:</span><span class="font-mono">${change.toFixed(2)}</span></div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                };
                
                let detailsHTML = '';
                
                if (invoice.originalInvoiceData) {
                    detailsHTML = `
                        <div class="text-center mb-6">
                            <h4 class="text-2xl font-extrabold text-slate-800">${invoice.id}</h4>
                            <p class="text-slate-500 mt-1">مقارنة بين الفاتورة الأصلية والمعدلة</p>
                        </div>
                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                            ${createDetailsBlock(invoice.originalInvoiceData, 'الفاتورة الأصلية', false, true)}
                            ${createDetailsBlock(invoice, 'الفاتورة المعدلة')}
                        </div>
                    `;
                } else {
                     detailsHTML = `<div class="max-w-3xl mx-auto">${createDetailsBlock(invoice, `تفاصيل الفاتورة`)}</div>`;
                }
                
                if(returnsForThisInvoice.length > 0) {
                    detailsHTML += `<div class="max-w-3xl mx-auto mt-8 space-y-8">`;
                    returnsForThisInvoice.forEach(ret => {
                         detailsHTML += createDetailsBlock(ret, `تفاصيل المرتجع: ${ret.id}`, true);
                    });
                    detailsHTML += `</div>`;
                }

                invoiceDetailsContent.innerHTML = detailsHTML;

                invoiceDetailsActions.innerHTML = ''; 
                if (invoice.originalInvoiceData) {
                    const originalBtn = document.createElement('button');
                    originalBtn.className = 'flex items-center justify-center gap-2 btn-secondary py-2 px-4 rounded-lg';
                    originalBtn.innerHTML = `<i data-lucide="printer"></i><span>طباعة الأصلية (نسخة)</span>`;
                    originalBtn.dataset.id = invoice.originalInvoiceData.id;
                    originalBtn.dataset.printType = 'copy';
                    invoiceDetailsActions.appendChild(originalBtn);

                    const modifiedBtn = document.createElement('button');
                    modifiedBtn.className = 'flex items-center justify-center gap-2 btn-primary py-2 px-4 rounded-lg';
                    modifiedBtn.innerHTML = `<i data-lucide="printer"></i><span>طباعة المعدلة (نسخة)</span>`;
                    modifiedBtn.dataset.id = invoice.id;
                    modifiedBtn.dataset.printType = 'copy';
                    invoiceDetailsActions.appendChild(modifiedBtn);
                } else {
                    const originalBtn = document.createElement('button');
                    originalBtn.className = 'flex items-center justify-center gap-2 btn-primary py-2 px-4 rounded-lg';
                    originalBtn.innerHTML = `<i data-lucide="printer"></i><span>طباعة الفاتورة (نسخة)</span>`;
                    originalBtn.dataset.id = invoice.id;
                    originalBtn.dataset.printType = 'copy';
                    invoiceDetailsActions.appendChild(originalBtn);
                }

                returnsForThisInvoice.forEach(ret => {
                    const returnBtn = document.createElement('button');
                    returnBtn.className = 'flex items-center justify-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg';
                    returnBtn.innerHTML = `<i data-lucide="printer"></i><span>طباعة المرتجع ${ret.id.split('-')[2]}</span>`;
                    returnBtn.dataset.id = ret.id;
                    returnBtn.dataset.printType = 'return';
                    invoiceDetailsActions.appendChild(returnBtn);
                });
                lucide.createIcons();


                invoicesView.classList.add('hidden-view');
                returnsView.classList.add('hidden-view');
                invoiceDetailsView.classList.remove('hidden-view');
                invoiceDetailsView.classList.add('flex');
            };
            
            const toggleDeveloperMode = async () => {
                if (isDeveloperMode) {
                    isDeveloperMode = false;
                } else {
                    const password = await showPasswordModal('Enable Manager', 'Please enter the owner password to continue.');
                    if (password === workerPassword) {
                        isDeveloperMode = true;
                    } else if (password !== null) {
                        await showAlert('Incorrect password.');
                    }
                }
                updateUIMode();
            };
            
            function updateUIMode() {
                if (isOnlineMode) {
                    const user = auth.currentUser;
                    footerLiveInfoDiv.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><span class="font-bold text-green-600">Online</span><span id="live-clock" class="font-bold text-green-600"></span>`;
                    
                    let dropdownHTML = `
                        <a href="#" id="developer-mode-btn" class="flex items-center gap-2 p-2 rounded hover:bg-gray-100 text-[var(--text-primary)]">
                            <i data-lucide="code-2" class="w-5 h-5 text-cyan-500"></i>
                            <span>${isDeveloperMode ? 'Disable Manager' : 'Enable Manager'}</span>
                        </a>`;
                    
                    dropdownHTML += `<a href="#" id="view-expenses-btn" class="flex items-center gap-2 p-2 rounded hover:bg-gray-100 text-[var(--text-primary)]"><i data-lucide="dollar-sign" class="w-5 h-5 text-red-500"></i><span>Expenses</span></a>`;

                    if (isDeveloperMode) {
                         dropdownHTML += `
                            <a href="#" id="inventory-management-btn" class="flex items-center gap-2 p-2 rounded hover:bg-gray-100 text-[var(--text-primary)]"><i data-lucide="archive" class="w-5 h-5 text-purple-500"></i><span>Inventory</span></a>
                            <a href="#" id="worker-permissions-btn" class="flex items-center gap-2 p-2 rounded hover:bg-gray-100 text-[var(--text-primary)]"><i data-lucide="user-cog" class="w-5 h-5 text-teal-500"></i><span>Manager Settings</span></a>
                            <a href="#" id="invoice-customization-btn" class="flex items-center gap-2 p-2 rounded hover:bg-gray-100 text-[var(--text-primary)]"><i data-lucide="file-cog" class="w-5 h-5 text-blue-500"></i><span>Invoice Settings</span></a>
                            <a href="#" id="shift-report-btn" class="flex items-center gap-2 p-2 rounded hover:bg-gray-100 text-[var(--text-primary)]"><i data-lucide="file-clock" class="w-5 h-5 text-indigo-500"></i><span>Sales Reports</span></a>
                         `;
                    }

                    dropdownHTML += `<div class="border-t border-[var(--panel-border)] my-1"></div>`;
                    dropdownHTML += `<a href="#" id="developer-info-btn" class="flex items-center gap-2 p-2 rounded hover:bg-gray-100 text-[var(--text-primary)]"><i data-lucide="info" class="w-5 h-5 text-purple-500"></i><span>Developer Info</span></a>`;
                    
                    if (isDeveloperMode) {
                        dropdownHTML += `<a href="#" id="logout-btn" class="flex items-center gap-2 p-2 rounded hover:bg-red-100 text-red-600 font-medium"><i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span></a>`;
                    }

                    userInfoDiv.innerHTML = `<div class="flex items-center gap-2"><div class="text-sm text-[var(--text-secondary)]">Hi, ${user.displayName}</div><button id="settings-btn" class="p-1.5 bg-gray-100 rounded-full hover:bg-gray-200"><i data-lucide="menu" class="h-4 w-4 text-[var(--text-primary)]"></i></button></div><div id="settings-dropdown" class="absolute right-0 mt-2 w-64 rounded-xl shadow-2xl z-20 hidden overflow-hidden panel p-2 space-y-1">${dropdownHTML}</div><div id="developer-mode-status" class="text-xs font-mono mt-1 text-left text-cyan-500"></div>`;
                    
                    const settingsBtn = document.getElementById('settings-btn');
                    const settingsDropdown = document.getElementById('settings-dropdown');
                    
                    settingsBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        settingsDropdown.classList.toggle('hidden');
                        if (!settingsDropdown.classList.contains('hidden')) {
                             lucide.createIcons();
                        }
                    });
                    
                    document.getElementById('developer-mode-btn').addEventListener('click', () => {
                        toggleDeveloperMode();
                        settingsDropdown.classList.add('hidden');
                    });

                    document.getElementById('developer-info-btn').addEventListener('click', () => {
                        developerInfoModal.classList.remove('hidden');
                        lucide.createIcons();
                        settingsDropdown.classList.add('hidden');
                    });

                    document.getElementById('view-expenses-btn').addEventListener('click', () => {
                        showExpensesView();
                        settingsDropdown.classList.add('hidden');
                    });

                    if (isDeveloperMode) {
                        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                        document.getElementById('inventory-management-btn').addEventListener('click', () => {
                            showInventoryView();
                            settingsDropdown.classList.add('hidden');
                        });
                        document.getElementById('worker-permissions-btn').addEventListener('click', () => {
                            workerPermissionsModal.classList.remove('hidden');
                            renderCashierProfiles();
                            lucide.createIcons();
                            settingsDropdown.classList.add('hidden');
                        });
                         document.getElementById('invoice-customization-btn').addEventListener('click', () => {
                            invoiceCustomizationModal.classList.remove('hidden');
                            lucide.createIcons();
                            settingsDropdown.classList.add('hidden');
                        });
                        document.getElementById('shift-report-btn').addEventListener('click', () => {
                            openReportsModal();
                            settingsDropdown.classList.add('hidden');
                        });
                    }
                    
                    applyPermissions();
                } else {
                    footerLiveInfoDiv.innerHTML = `<span class="w-2 h-2 bg-red-500 rounded-full"></span><span class="font-bold text-red-600">Offline</span><span id="live-clock" class="font-bold text-red-600"></span>`;
                }
                updateClock();
                lucide.createIcons();
            }

            async function handleLoginAndSync() {
                loginStatusMessage.textContent = 'Opening login window...';
                loginStatusMessage.classList.remove('text-red-600', 'text-green-600');
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    let message = `An error occurred: ${error.code}`;
                    if (error.code === 'auth/popup-closed-by-user') {
                        message = 'Login process was canceled.';
                    }
                    loginStatusMessage.textContent = message;
                    loginStatusMessage.classList.add('text-red-600');
                    loginForSettings = false; 
                }
            }
            
            const loadInvoiceForEditing = async (firestoreId, internalId) => {
                let invoicesToSearch = isOnlineMode ? firestoreInvoices : JSON.parse(localStorage.getItem('savedInvoices')) || [];
                const invoice = invoicesToSearch.find(inv => (isOnlineMode ? inv.firestoreId === firestoreId : inv.id === internalId));
                if (!invoice) {
                    showAlert('The selected invoice was not found.');
                    return;
                }
                
                editingInvoiceId = firestoreId;
                editingInvoiceInternalId = invoice.id;
                cart = JSON.parse(JSON.stringify(invoice.items));
                cart.forEach(item => {
                    if (typeof item.discount === 'undefined') {
                        item.discount = 0;
                    }
                });
                customerNameInput.value = invoice.customerName;
                customerPhoneInput.value = invoice.customerPhone;
                saleDate = invoice.date;
                tenderedInput.value = invoice.tendered;
                invoiceDiscountInput.value = invoice.invoiceDiscount || '';
                paymentMethodSelect.value = invoice.paymentMethod;
                invoiceNotesInput.value = invoice.notes || '';
                invoiceNotes = invoice.notes || '';
                renderCart();
                showAlert(`Invoice ${invoice.id} has been loaded for editing.`).then(() => {
                    showPosView();
                });
            };

            const loadInvoiceForReturn = async (firestoreId, internalId) => {
                let invoicesToSearch = isOnlineMode ? firestoreInvoices : JSON.parse(localStorage.getItem('savedInvoices')) || [];
                const invoice = invoicesToSearch.find(inv => (isOnlineMode ? inv.firestoreId === firestoreId : inv.id === internalId));
                if (!invoice) {
                    showAlert('The original invoice was not found.');
                    return;
                }
                clearSale();
                isReturnMode = true;
                originalInvoiceForReturn = invoice;
                invoiceTitleEl.textContent = "Return Invoice";
                cart = JSON.parse(JSON.stringify(invoice.items));
                cart.forEach(item => {
                    if (typeof item.discount === 'undefined') {
                        item.discount = 0;
                    }
                });
                
                customerNameInput.value = invoice.customerName;
                customerPhoneInput.value = invoice.customerPhone;
                customerName = invoice.customerName;
                customerPhone = invoice.customerPhone;
                
                saleDate = new Date().toISOString().split('T')[0];
                renderCart();
                showAlert(`Invoice ${invoice.id} has been loaded to create a return.`).then(() => {
                    showPosView();
                });
            };

            const addNewProductToFirestore = async () => {
                if (!isDeveloperMode) {
                    showAlert('You do not have permission to add new products.');
                    return;
                }
                const name = newProductNameInput.value.trim();
                const purchasePrice = parseFloat(document.getElementById('new-product-purchase-price').value) || 0;
                const profitMargin = parseFloat(document.getElementById('new-product-profit-margin').value) || 0;
                const price = parseFloat(newProductPriceInput.value);
                const isUnlimited = unlimitedStockCheckbox.checked;
                const quantity = isUnlimited ? Infinity : parseInt(newProductQuantityInput.value, 10);

                if (!name || isNaN(price) || price < 0) {
                    showAlert('Please enter a valid name and price.');
                    return;
                }

                if (!isUnlimited && (isNaN(quantity) || quantity < 0)) {
                    showAlert('Please enter a valid on-hand quantity.');
                    return;
                }

                if (!isOnlineMode || !userId) {
                    showAlert('You must be in online mode to add new products.');
                    return;
                }

                try {
                    const productsCollectionPath = `users/${userId}/products`;
                    await addDoc(collection(db, productsCollectionPath), { name, price, quantity, purchasePrice, profitMargin });
                    showAlert(`Product "${name}" was successfully added to the list.`);
                    newProductNameInput.value = '';
                    newProductPriceInput.value = '';
                    document.getElementById('new-product-purchase-price').value = '';
                    document.getElementById('new-product-profit-margin').value = '';
                    newProductQuantityInput.value = '';
                    unlimitedStockCheckbox.checked = false;
                    newProductQuantityInput.disabled = false;
                    newProductQuantityInput.placeholder = '';
                } catch (error) {
                    showAlert('An error occurred while adding the new product.');
                }
            };

            const addExpenseToFirestore = async () => {
                const description = expenseDescriptionInput.value.trim();
                const type = expenseTypeInput.value.trim();
                const amount = parseFloat(expenseAmountInput.value);
                const notes = expenseNotesInput.value.trim();

                if (!description || !type || isNaN(amount) || amount <= 0) {
                    showAlert('Please enter a valid description, type, and amount.');
                    return;
                }

                if (!isOnlineMode || !userId) {
                    showAlert('You must be in online mode to add expenses.');
                    return;
                }

                try {
                    const expensesCollectionPath = `users/${userId}/expenses`;
                    await addDoc(collection(db, expensesCollectionPath), {
                        description,
                        type,
                        amount,
                        notes,
                        date: new Date().toISOString().split('T')[0],
                        timestamp: Date.now()
                    });
                    showAlert('Expense added successfully.');
                    expenseDescriptionInput.value = '';
                    expenseTypeInput.value = '';
                    expenseAmountInput.value = '';
                    expenseNotesInput.value = '';
                } catch (error) {
                    console.error("Error adding expense:", error);
                    showAlert('An error occurred while adding the expense.');
                }
            };

            const updateExpenseInFirestore = async (expenseId, newData) => {
                if (isOnlineMode) {
                    try {
                        const expenseDocRef = doc(db, `users/${userId}/expenses`, expenseId);
                        await updateDoc(expenseDocRef, newData);
                        showAlert('Expense updated successfully.');
                    } catch (error) {
                        console.error("Error updating expense in Firestore:", error);
                        showAlert('Failed to update expense in the cloud.');
                    }
                }
            };

            const deleteExpense = async (firestoreId) => {
                const confirmed = await confirmDangerousAction('Confirm Deletion', 'Are you sure you want to delete this expense record?');
                if (confirmed && isOnlineMode) {
                    try {
                        const docRef = doc(db, `users/${userId}/expenses`, firestoreId);
                        await deleteDoc(docRef);
                        showAlert('Expense record deleted successfully.');
                    } catch (error) {
                        console.error("Error deleting expense:", error);
                        showAlert('An error occurred while deleting the expense.');
                    }
                }
            };

             const deleteAllExpenses = async () => {
                const confirmed = await confirmDangerousAction('Delete All Expenses', 'Are you absolutely sure? This will permanently delete all expense records and cannot be undone.');
                if (confirmed && isOnlineMode) {
                    try {
                        const expensesCollectionPath = `users/${userId}/expenses`;
                        const querySnapshot = await getDocs(collection(db, expensesCollectionPath));
                        if (querySnapshot.empty) {
                            showAlert("There are no expenses to delete.");
                            return;
                        }
                        const batch = writeBatch(db);
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        showAlert('All expenses have been deleted successfully.');
                    } catch (error) {
                        console.error("Error deleting all expenses:", error);
                        showAlert('An error occurred while deleting all expenses.');
                    }
                }
            };

            const loadAppSettings = async (uid) => {
                try {
                    const configDocRef = doc(db, 'configuration', 'settings');
                    const configDocSnap = await getDoc(configDocRef);

                    if (configDocSnap.exists() && configDocSnap.data().authorizedUsers) {
                        const authorizedUserList = configDocSnap.data().authorizedUsers;
                        const currentUserConfig = authorizedUserList.find(user => user.uid === uid);

                        if (currentUserConfig && currentUserConfig.sessionExpiryTimestamp && currentUserConfig.sessionExpiryTimestamp > 0) {
                            const expiry = currentUserConfig.sessionExpiryTimestamp;
                            const isValid = Date.now() <= expiry;
                            return { isValid: isValid, expiryTimestamp: expiry };
                        }
                    }
                    return { isValid: true, expiryTimestamp: null };
                } catch (error) {
                    console.error("Error loading app settings:", error);
                    return { isValid: true, expiryTimestamp: null };
                }
            };

            const renderInvoiceArchive = () => {
                invoiceArchiveList.innerHTML = '';
                if (firestoreInvoiceArchive.length === 0) {
                    invoiceArchiveList.innerHTML = '<p class="text-center text-[var(--text-secondary)] py-10">No archive records found.</p>';
                    return;
                }

                const sortedArchive = [...firestoreInvoiceArchive].sort((a, b) => b.timestamp - a.timestamp);

                sortedArchive.forEach(log => {
                    const logDiv = document.createElement('div');
                    const date = new Date(log.timestamp);
                    const dateString = date.toLocaleDateString('en-GB');
                    const timeString = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const dayString = date.toLocaleDateString('en-US', { weekday: 'long' });

                    let statusHTML = '';
                    const isReturn = log.invoiceId.startsWith('RET');
                    const notesIcon = log.cancellationNotes ? `<i data-lucide="message-square-text" class="w-4 h-4 text-slate-500" title="Has Cancellation Notes"></i>` : '';

                    switch(log.status) {
                        case 'confirmed':
                            if (isReturn) {
                                statusHTML = `<span class="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded-full">Returned</span>`;
                            } else {
                                statusHTML = `<span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full">Confirmed</span>`;
                            }
                            break;
                        case 'cancelled':
                            statusHTML = `<span class="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded-full">Cancelled</span>`;
                            break;
                        case 'created':
                            statusHTML = `<span class="bg-yellow-100 text-yellow-700 text-xs font-bold px-2 py-1 rounded-full">Pending</span>`;
                            break;
                        default:
                            statusHTML = `<span class="bg-gray-100 text-gray-700 text-xs font-bold px-2 py-1 rounded-full">Unknown</span>`;
                    }

                    logDiv.className = 'archive-log-item flex items-center justify-between p-3 bg-white rounded-lg shadow-sm cursor-pointer hover:bg-slate-50 transition-all';
                    logDiv.dataset.invoiceId = log.invoiceId;
                    logDiv.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div>
                                <p class="font-bold text-gray-800">${log.invoiceId}</p>
                                <p class="text-sm text-gray-500 flex items-center gap-2">${log.customerName || 'N/A Customer'} - ${log.total.toFixed(2)} EGP ${notesIcon}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-sm">${dateString} - ${dayString}</div>
                            <div class="text-xs text-gray-500">${timeString}</div>
                        </div>
                        <div class="w-24 text-center">${statusHTML}</div>
                    `;
                    invoiceArchiveList.appendChild(logDiv);
                });
            };

            const showArchiveInvoiceDetails = (archiveEntry) => {
                const receiptHTML = generateReceiptHTML(archiveEntry.invoiceData, 'copy', false); // Reuse existing function
                
                let notesHTML = '';
                if (archiveEntry.cancellationNotes) {
                    notesHTML = `
                        <div class="p-4 bg-red-50 border-t border-red-200">
                            <h4 class="font-bold text-red-700 flex items-center gap-2"><i data-lucide="file-x-2" class="w-5 h-5"></i> Cancellation Notes</h4>
                            <p class="text-red-800 mt-2 pl-7">${archiveEntry.cancellationNotes}</p>
                        </div>
                    `;
                }
                
                archiveDetailsContent.innerHTML = `<div class="p-4 bg-white">${receiptHTML}</div>${notesHTML}`;
                archiveDetailsModal.classList.remove('hidden');
                lucide.createIcons();
                
                const qrPlaceholder = archiveDetailsModal.querySelector('#qrcode-placeholder');
                if (qrPlaceholder && workerPermissions.facebookLink) {
                    qrPlaceholder.innerHTML = ''; // Clear previous QR
                    new QRCode(qrPlaceholder, {
                        text: workerPermissions.facebookLink,
                        width: 100,
                        height: 100,
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            };

            const displayUnconfirmedInvoiceDetails = (invoice) => {
                currentlyViewingUnconfirmedId = invoice ? invoice.firestoreId : null;

                if (!invoice) {
                    unconfirmedInvoiceDetails.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400"><p>Select an invoice to view details.</p></div>';
                    return;
                }

                const itemsHTML = invoice.items.map(item => `
                    <tr class="border-b border-slate-100">
                        <td class="p-2">${item.name}</td>
                        <td class="p-2 text-center">${item.quantity}</td>
                        <td class="p-2 text-right font-mono">${item.price.toFixed(2)}</td>
                        <td class="p-2 text-right font-mono font-semibold">${((item.price * item.quantity) - (item.discount || 0)).toFixed(2)}</td>
                    </tr>
                `).join('');

                unconfirmedInvoiceDetails.innerHTML = `
                    <h4 class="font-bold text-lg text-slate-800 mb-2 pb-2 border-b">Details for ${invoice.id}</h4>
                    <div class="space-y-1 text-sm text-slate-600 mb-4">
                        <p><strong>Customer:</strong> ${invoice.customerName}</p>
                        <p><strong>Cashier:</strong> ${invoice.sellerName || 'N/A'}</p>
                        <p><strong>Date:</strong> ${new Date(invoice.timestamp).toLocaleString()}</p>
                    </div>
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="p-2 text-left font-semibold text-slate-500">Item</th>
                                <th class="p-2 text-center font-semibold text-slate-500">Qty</th>
                                <th class="p-2 text-right font-semibold text-slate-500">Price</th>
                                <th class="p-2 text-right font-semibold text-slate-500">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    <div class="mt-4 pt-4 border-t space-y-2 text-right">
                        <p class="font-medium">Subtotal: <span class="font-bold font-mono">${invoice.subtotal.toFixed(2)}</span></p>
                        <p class="font-medium">Discount: <span class="font-bold font-mono">${((invoice.discount || 0) + (invoice.invoiceDiscount || 0)).toFixed(2)}</span></p>
                        <p class="font-bold text-xl">Total: <span class="font-mono">${invoice.total.toFixed(2)}</span></p>
                    </div>
                `;
            };

            const updateUnconfirmedCountBadge = () => {
                const count = firestoreUnconfirmedInvoices.length;
                if (count > 0) {
                    unconfirmedCountBadge.textContent = count;
                    unconfirmedCountBadge.classList.remove('hidden');
                    unconfirmedIcon.classList.add('vibrating-bell');
                } else {
                    unconfirmedCountBadge.classList.add('hidden');
                    unconfirmedIcon.classList.remove('vibrating-bell');
                }
            };

            const renderUnconfirmedInvoicesList = () => {
                unconfirmedInvoicesList.innerHTML = '';
                if (firestoreUnconfirmedInvoices.length === 0) {
                    unconfirmedInvoicesList.innerHTML = '<p class="text-center text-[var(--text-secondary)] py-10">No unconfirmed invoices.</p>';
                    displayUnconfirmedInvoiceDetails(null);
                    return;
                }

                firestoreUnconfirmedInvoices.sort((a, b) => b.timestamp - a.timestamp).forEach(invoice => {
                    const invoiceDiv = document.createElement('div');
                    invoiceDiv.className = 'unconfirmed-invoice-item p-3 bg-white rounded-lg shadow-sm cursor-pointer hover:bg-blue-50 hover:ring-2 hover:ring-blue-300 transition-all';
                    invoiceDiv.dataset.firestoreId = invoice.firestoreId;
                    invoiceDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="bg-yellow-100 text-yellow-600 rounded-full h-10 w-10 flex-shrink-0 flex items-center justify-center">
                                    <i data-lucide="file-clock" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-base text-gray-800">${invoice.customerName} - ${invoice.total.toFixed(2)} EGP</p>
                                    <p class="text-xs text-gray-500 font-mono">${invoice.id}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button data-firestore-id="${invoice.firestoreId}" class="cancel-invoice-btn flex items-center justify-center gap-1 px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-semibold transition-colors">
                                    <i data-lucide="x" class="w-4 h-4"></i><span>Cancel</span>
                                </button>
                                <button data-firestore-id="${invoice.firestoreId}" class="confirm-invoice-btn flex items-center justify-center gap-1 px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 font-semibold transition-colors">
                                    <i data-lucide="check" class="w-4 h-4"></i><span>Confirm</span>
                                </button>
                            </div>
                        </div>
                    `;
                    unconfirmedInvoicesList.appendChild(invoiceDiv);
                });
                lucide.createIcons();
            };

            const confirmInvoice = async (firestoreId) => {
                if (!isOnlineMode || !userId) return;
                try {
                    const invoiceDocRef = doc(db, `users/${userId}/invoices`, firestoreId);
                    
                    // Find the archive entry associated with this invoice first.
                    const invoiceSnapshot = await getDoc(invoiceDocRef);
                    if (!invoiceSnapshot.exists()) throw "Invoice to confirm not found.";
                    const invoiceData = invoiceSnapshot.data();

                    const archiveQuery = query(collection(db, `users/${userId}/invoice_archive`), where("invoiceId", "==", invoiceData.id));
                    const archiveSnapshot = await getDocs(archiveQuery);
                    
                    let archiveDocRef = null;
                    if (!archiveSnapshot.empty) {
                        archiveDocRef = archiveSnapshot.docs[0].ref;
                    }

                    // Now run the transaction to update both documents.
                    await runTransaction(db, async (transaction) => {
                        // Update invoice status in the main collection
                        transaction.update(invoiceDocRef, { status: 'confirmed' });

                        // Update status in the archive collection
                        if (archiveDocRef) {
                            transaction.update(archiveDocRef, {
                                status: 'confirmed',
                                timestamp: Date.now(),
                                invoiceData: invoiceData
                            });
                        } else {
                            // This is a fallback if the archive entry was missed during creation.
                            const newArchiveDocRef = doc(collection(db, `users/${userId}/invoice_archive`));
                            transaction.set(newArchiveDocRef, {
                                invoiceId: invoiceData.id,
                                status: 'confirmed',
                                timestamp: Date.now(),
                                customerName: invoiceData.customerName,
                                total: invoiceData.total,
                                invoiceData: invoiceData
                            });
                        }
                    });

                    if (firestoreId === currentlyViewingUnconfirmedId) {
                        displayUnconfirmedInvoiceDetails(null);
                    }
                    showAlert('Invoice confirmed.');
                } catch (error) {
                    console.error("Error confirming invoice:", error);
                    showAlert(`Failed to confirm invoice: ${error}`);
                }
            };

            const cancelInvoice = async (firestoreId) => {
                if (!isOnlineMode || !userId) return;

                const cancellationNotes = await showCancellationNotesModal();
                if (cancellationNotes === null) {
                    // User cancelled the notes modal
                    return;
                }

                try {
                    // Find the archive entry associated with this invoice first.
                    const invoiceDocForRead = doc(db, `users/${userId}/invoices`, firestoreId);
                    const invoiceSnapshot = await getDoc(invoiceDocForRead);
                    if (!invoiceSnapshot.exists()) throw "Invoice to cancel not found.";
                    const invoiceDataForQuery = invoiceSnapshot.data();
                    
                    const archiveQuery = query(collection(db, `users/${userId}/invoice_archive`), where("invoiceId", "==", invoiceDataForQuery.id));
                    const archiveSnapshot = await getDocs(archiveQuery);
                    
                    let archiveDocRef = null;
                    if (!archiveSnapshot.empty) {
                        archiveDocRef = archiveSnapshot.docs[0].ref;
                    }

                    await runTransaction(db, async (transaction) => {
                        // --- STAGE 1: ALL READS ---
                        const invoiceDocRef = doc(db, `users/${userId}/invoices`, firestoreId);
                        const invoiceDoc = await transaction.get(invoiceDocRef);

                        if (!invoiceDoc.exists()) {
                            throw "Invoice not found, it may have already been cancelled.";
                        }
                        const invoiceData = invoiceDoc.data();

                        // Get all product references from the invoice
                        const productRefs = invoiceData.items
                            .filter(item => !item.id.startsWith('custom-'))
                            .map(item => doc(db, `users/${userId}/products`, item.id));
                        
                        // Read all product documents at once
                        const productDocsSnapshots = productRefs.length > 0 ? await Promise.all(productRefs.map(ref => transaction.get(ref))) : [];
                        
                        // --- STAGE 2: ALL WRITES ---

                        // 1. Update archive status
                        const archiveUpdateData = {
                            status: 'cancelled',
                            timestamp: Date.now(),
                            invoiceData: invoiceData,
                            cancellationNotes: cancellationNotes // <-- ADD THE NOTES HERE
                        };

                        if (archiveDocRef) {
                             transaction.update(archiveDocRef, archiveUpdateData);
                        } else {
                            // Fallback
                            const newArchiveDocRef = doc(collection(db, `users/${userId}/invoice_archive`));
                             transaction.set(newArchiveDocRef, {
                                invoiceId: invoiceData.id,
                                customerName: invoiceData.customerName,
                                total: invoiceData.total,
                                ...archiveUpdateData
                            });
                        }
                       
                        // 2. Update product stock
                        let productDocIndex = 0;
                        for (const item of invoiceData.items) {
                            if (item.id.startsWith('custom-')) continue;
                            
                            const productDocSnapshot = productDocsSnapshots[productDocIndex];
                            productDocIndex++;

                            if (productDocSnapshot && productDocSnapshot.exists()) {
                                const productData = productDocSnapshot.data();
                                
                                if (item.code) {
                                    const codeIndex = (productData.codes || []).findIndex(c => c.code === item.code);
                                    if(codeIndex > -1) {
                                        productData.codes[codeIndex].quantity += item.quantity;
                                        productData.quantity = productData.codes.reduce((sum, c) => sum + c.quantity, 0);
                                    }
                                } else if (productData.quantity !== Infinity){
                                    productData.quantity += item.quantity;
                                }
                                
                                // Construct a safe update payload to avoid 'undefined' errors
                                const updatePayload = {
                                    quantity: productData.quantity,
                                };
                                // Only include the 'codes' field if it's an array on the product data.
                                if (Array.isArray(productData.codes)) {
                                    updatePayload.codes = productData.codes;
                                }
                                
                                transaction.update(productDocSnapshot.ref, updatePayload);
                            }
                        }
                        
                        // 3. Delete invoice
                        transaction.delete(invoiceDocRef);
                    });
                    
                    if (firestoreId === currentlyViewingUnconfirmedId) {
                        displayUnconfirmedInvoiceDetails(null);
                    }
                    showAlert('Invoice cancelled and stock restored.');
                } catch (error) {
                    console.error("Error cancelling invoice:", error);
                    showAlert(`Failed to cancel invoice: ${error}`);
                }
            };

            const saveAccountSession = async () => {
                const selectedUserUid = authorizedAccountsSelect.value;
                if (!selectedUserUid) return showAlert('Please select an account first.');

                const value = parseInt(accountLogoutDurationValueInput.value, 10);
                const unit = accountLogoutDurationUnitSelect.value;

                if (isNaN(value) || value <= 0) return showAlert('Please enter a valid positive duration.');

                let durationInMs = 0;
                switch (unit) {
                    case 'hours': durationInMs = value * 3600000; break;
                    case 'days': durationInMs = value * 86400000; break;
                    case 'months': durationInMs = value * 2592000000; break;
                    default: durationInMs = value * 60000; break; 
                }
                const newExpiryTimestamp = Date.now() + durationInMs;

                try {
                    const configDocRef = doc(db, 'configuration', 'settings');
                    const configDocSnap = await getDoc(configDocRef);

                    if (!configDocSnap.exists()) throw new Error("Configuration document not found.");

                    let authorizedUserList = configDocSnap.data().authorizedUsers;
                    const userIndex = authorizedUserList.findIndex(user => user.uid === selectedUserUid);

                    if (userIndex === -1) throw new Error("Selected user not found in the configuration list.");

                    authorizedUserList[userIndex].sessionExpiryTimestamp = newExpiryTimestamp;

                    await updateDoc(configDocRef, { authorizedUsers: authorizedUserList });

                    const selectedEmail = authorizedAccountsSelect.options[authorizedAccountsSelect.selectedIndex].text;
                    sessionStatusMessage.textContent = `Session for ${selectedEmail} updated.`;
                    sessionStatusMessage.classList.add('text-green-600');
                    setTimeout(() => sessionStatusMessage.textContent = '', 3000);

                    if (selectedUserUid === userId) {
                        startAutoLogoutTimer(newExpiryTimestamp);
                    }

                } catch (error) {
                    console.error("Error saving session settings:", error);
                    showAlert('Failed to save session settings. Check console for details.');
                }
            };
            
            const cancelAccountSession = async () => {
                const selectedUserUid = authorizedAccountsSelect.value;
                if (!selectedUserUid) return showAlert('Please select an account first.');
                
                const confirmed = await confirmAction('Expire Session', 'Are you sure you want to expire this session? The user will be logged out.');
                if (!confirmed) return;

                try {
                    const configDocRef = doc(db, 'configuration', 'settings');
                    const configDocSnap = await getDoc(configDocRef);

                    if (!configDocSnap.exists()) throw new Error("Configuration document not found.");

                    let authorizedUserList = configDocSnap.data().authorizedUsers;
                    const userIndex = authorizedUserList.findIndex(user => user.uid === selectedUserUid);

                    if (userIndex === -1) throw new Error("Selected user not found.");
                    
                    authorizedUserList[userIndex].sessionExpiryTimestamp = 0;

                    await updateDoc(configDocRef, { authorizedUsers: authorizedUserList });

                    const selectedEmail = authorizedAccountsSelect.options[authorizedAccountsSelect.selectedIndex].text;
                    sessionStatusMessage.textContent = `Session for ${selectedEmail} has been expired.`;
                    sessionStatusMessage.classList.add('text-red-600');
                    setTimeout(() => sessionStatusMessage.textContent = '', 3000);

                    if (selectedUserUid === userId) {
                        startAutoLogoutTimer(null);
                    }
                } catch (error) {
                     console.error("Error canceling session:", error);
                     showAlert('Failed to cancel session.');
                }
            };
            
            const openSettingsModal = async () => {
                settingsModal.classList.remove('hidden');
                lucide.createIcons();
                await fetchAndDisplayAuthorizedUsers();
                await loadMaintenanceSettingsForModal();
            };

            const fetchAndDisplayAuthorizedUsers = async () => {
                try {
                    const configDocRef = doc(db, 'configuration', 'settings');
                    const configDocSnap = await getDoc(configDocRef);
                    if (!configDocSnap.exists() || !configDocSnap.data().authorizedUsers) {
                        showAlert('Authorization configuration not found or is in the wrong format.');
                        return;
                    }

                    authorizedUsers = configDocSnap.data().authorizedUsers; 
                    
                    authorizedAccountsSelect.innerHTML = '<option value="">-- Select an account --</option>'; 
                    authorizedUsers.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.uid;
                        option.textContent = user.email; 
                        authorizedAccountsSelect.appendChild(option);
                    });

                } catch (error) {
                    console.error("Error fetching authorized users:", error);
                    showAlert('Could not load authorized user list.');
                }
            };
            
            const loadMaintenanceSettingsForModal = async () => {
                try {
                    const docRef = doc(db, 'configuration', 'maintenance');
                    const docSnap = await getDoc(docRef);
                    let currentSettings = { enabled: false, message: 'Our system is currently down for scheduled maintenance. We should be back online shortly. Thank you for your patience.'};
                    if (docSnap.exists()) {
                        currentSettings = { ...currentSettings, ...docSnap.data() };
                    }
                    maintenanceModeToggle.checked = currentSettings.enabled;
                    maintenanceMessageInput.value = currentSettings.message;
                    maintenanceMessageControls.style.display = currentSettings.enabled ? 'block' : 'none';
                } catch (error) {
                    console.error("Error loading maintenance settings for modal:", error);
                    showAlert('Could not load maintenance settings.');
                }
            };

            const populateCashierDropdown = () => {
                const select = document.getElementById('cashier-select');
                select.innerHTML = '<option value="">-- Select Cashier --</option>';
                workerPermissions.cashiers.forEach((cashier, index) => {
                    const option = document.createElement('option');
                    option.value = index; 
                    option.textContent = `${cashier.name} (${cashier.code})`;
                    select.appendChild(option);
                });
            };

        const saveWorkerPermissions = async () => {
            if (!isOnlineMode || !userId) return;
            const permissionsDocRef = doc(db, `users/${userId}/settings`, 'permissions');
            try {
                await setDoc(permissionsDocRef, {
                    ...workerPermissions,
                    workerPassword
                });
            } catch (error) {
                showAlert("Failed to save worker permissions.");
            }
        };

        const loadWorkerPermissions = async () => {
            if (!isOnlineMode || !userId) return;
            const defaultPermissions = {
                cashiers: [{ name: 'Badr Ibrahim', code: '001', key: '0000' }],
                shopName: 'Badrly',
                branchInfo: '63511 Saad Zaghloul',
                machineNumber: 'LPQ80-ESC',
                contactNumber: '01014175070',
                facebookLink: 'https://www.facebook.com/gedar.fayoum/',
                invoiceAddress: 'Address\nLast wall of the general hospital, in front of Abu Salah butchery and next to the American laundry',
                returnPolicy: 'Return and Exchange Policy: Returns or exchanges are accepted only if the product is in its original condition, not scratched or broken. If it was sealed, the packaging must be intact. Any product that violates this policy will not be accepted for return.',
                systemLock: {
                    enabled: false,
                    lockTime: '23:00',
                    unlockTime: '11:00'
                }
            };
            const permissionsDocRef = doc(db, `users/${userId}/settings`, 'permissions');
            try {
                const docSnap = await getDoc(permissionsDocRef);
                if (docSnap.exists()) {
                    const permsData = docSnap.data();
                    workerPermissions = { ...defaultPermissions, ...permsData };
                    if (!workerPermissions.systemLock) { // Ensure systemLock object exists
                        workerPermissions.systemLock = defaultPermissions.systemLock;
                    }
                    workerPassword = permsData.workerPassword || '123';
                } else {
                    workerPermissions = defaultPermissions;
                    workerPassword = '123';
                    await saveWorkerPermissions();
                }
            } catch (error) {
                 console.error("Error loading worker permissions:", error);
            }
            applyPermissions();
        };

        const applyPermissions = () => {
                workerPasswordInput.value = workerPassword;
                invoiceAddressInput.value = workerPermissions.invoiceAddress;
                returnPolicyInput.value = workerPermissions.returnPolicy;
                invoiceShopNameInput.value = workerPermissions.shopName;
                invoiceBranchInfoInput.value = workerPermissions.branchInfo;
                invoiceMachineNumberInput.value = workerPermissions.machineNumber;
                invoiceContactNumberInput.value = workerPermissions.contactNumber;
                document.getElementById('invoice-facebook-link-input').value = workerPermissions.facebookLink;
                
                const lockSettings = workerPermissions.systemLock || { enabled: false, lockTime: '23:00', unlockTime: '11:00' };
                systemLockEnabledToggle.checked = lockSettings.enabled;
                systemLockTimeInput.value = lockSettings.lockTime;
                systemUnlockTimeInput.value = lockSettings.unlockTime;
                systemLockTimesContainer.style.display = lockSettings.enabled ? 'grid' : 'none';

                const devModeStatus = document.getElementById('developer-mode-status');
                if (devModeStatus) {
                    devModeStatus.innerHTML = isDeveloperMode ? `<i data-lucide="code-2" class="inline-block h-3 w-3"></i> Manager Enabled` : '';
                }
                
                const canManageAdvanced = isDeveloperMode;
                viewReturnsBtn.style.display = canManageAdvanced ? 'flex' : 'none';
                addNewProductSection.classList.toggle('hidden', !canManageAdvanced);
                
                populateCashierDropdown();
                renderProducts(products);
                if (!invoicesView.classList.contains('hidden-view')) {
                    renderSavedInvoicesList();
                }
            };

            const renderCashierProfiles = () => {
                cashierProfilesList.innerHTML = '';
                if (workerPermissions.cashiers.length === 0) {
                    cashierProfilesList.innerHTML = '<p class="text-center text-gray-500 p-4">No cashiers added yet.</p>';
                    return;
                }
                workerPermissions.cashiers.forEach((cashier, index) => {
                    const profileDiv = document.createElement('div');
                    profileDiv.className = 'flex items-center justify-between p-3 bg-white rounded-lg shadow-sm';
                    profileDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-100 text-blue-600 rounded-full h-10 w-10 flex items-center justify-center">
                                <i data-lucide="user-circle-2" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <p class="font-bold text-base text-gray-800">${cashier.name}</p>
                                <p class="text-xs text-gray-500">Code: ${cashier.code}</p>
                            </div>
                        </div>
                        <button data-index="${index}" class="delete-cashier-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    `;
                    cashierProfilesList.appendChild(profileDiv);
                });
                lucide.createIcons();
            };
            
            const renderCustomersList = (searchTerm = '') => {
                const customerMap = new Map();
                firestoreInvoices.forEach(invoice => {
                    if (invoice.customerPhone && invoice.customerPhone.trim() !== 'N/A' && invoice.customerPhone.trim() !== '') {
                        if (!customerMap.has(invoice.customerPhone)) {
                            customerMap.set(invoice.customerPhone, invoice.customerName);
                        }
                    }
                });

                let sortedCustomers = [...customerMap.entries()].sort((a, b) => a[1].localeCompare(b[1]));

                if (searchTerm) {
                    sortedCustomers = sortedCustomers.filter(([phone, name]) => 
                        name.toLowerCase().includes(searchTerm) || phone.includes(searchTerm)
                    );
                }

                customersListTbody.innerHTML = '';
                if (sortedCustomers.length === 0) {
                    customersListTbody.innerHTML = '<p class="text-center text-[var(--text-secondary)] py-10">No customers match the search.</p>';
                } else {
                    sortedCustomers.forEach(([phone, name]) => {
                        const customerDiv = document.createElement('div');
                        customerDiv.className = 'add-customer-to-invoice-btn flex items-center justify-between p-3 bg-white rounded-lg shadow-sm hover:bg-blue-50 hover:border-blue-300 border border-transparent transition-all cursor-pointer';
                        customerDiv.dataset.name = name;
                        customerDiv.dataset.phone = phone;

                        customerDiv.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-100 text-blue-600 rounded-full h-10 w-10 flex-shrink-0 flex items-center justify-center">
                                    <i data-lucide="user" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-base text-gray-800">${name}</p>
                                    <p class="text-sm text-gray-500 font-mono">${phone}</p>
                                </div>
                            </div>
                            <div class="text-green-500">
                                 <i data-lucide="plus-circle" class="h-6 w-6"></i>
                            </div>
                        `;
                        customersListTbody.appendChild(customerDiv);
                    });
                }
                lucide.createIcons();
            };

            const openCustomersModal = () => {
                document.getElementById('customer-search-input').value = '';
                renderCustomersList();
                customersModal.classList.remove('hidden');
                lucide.createIcons();
            };

            const downloadCustomersAsExcel = () => {
                const customerMap = new Map();
                firestoreInvoices.forEach(invoice => {
                    if (invoice.customerPhone && invoice.customerPhone.trim() !== 'N/A' && invoice.customerPhone.trim() !== '') {
                        if (!customerMap.has(invoice.customerPhone)) {
                            customerMap.set(invoice.customerPhone, invoice.customerName);
                        }
                    }
                });

                if (customerMap.size === 0) {
                    showAlert('No customer data to download.');
                    return;
                }

                const dataForExcel = [['Customer Name', 'Phone Number']];
                const sortedCustomers = [...customerMap.entries()].sort((a, b) => a[1].localeCompare(b[1]));
                sortedCustomers.forEach(([phone, name]) => {
                    dataForExcel.push([name, phone]);
                });
                
                const worksheet = XLSX.utils.aoa_to_sheet(dataForExcel);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Customers');
                XLSX.writeFile(workbook, 'Customer_Database.xlsx');
            };

            const openReportsModal = () => {
                const todayStr = new Date().toISOString().split('T')[0];
                reportDateInput.value = todayStr;
                reportEndDateInput.value = todayStr;
                reportContent.innerHTML = `<div class="flex items-center justify-center h-full text-slate-500"><p>Select a report type and date range to generate a report.</p></div>`;
                printReportBtn.disabled = true;
                reportsModal.classList.remove('hidden');
                reportTypeSelect.dispatchEvent(new Event('change')); // Trigger change to set initial UI
                lucide.createIcons();
            };
            
            const generateAndDisplayReport = () => {
                const reportType = reportTypeSelect.value;
                let startDate, endDate;
                let title = '';
                const today = new Date();
                today.setHours(0,0,0,0);

                switch(reportType) {
                    case 'daily':
                        const selectedDateStr = reportDateInput.value;
                        if (!selectedDateStr) {
                            showAlert('Please select a date for the daily report.');
                            return;
                        }
                        const selectedDate = new Date(selectedDateStr);
                        const timezoneOffset = selectedDate.getTimezoneOffset() * 60000;
                        startDate = new Date(new Date(selectedDate.getTime() + timezoneOffset).setHours(0, 0, 0, 0));
                        endDate = new Date(new Date(selectedDate.getTime() + timezoneOffset).setHours(23, 59, 59, 999));
                        title = `تقرير يومي: ${startDate.toLocaleDateString('ar-EG-u-nu-latn', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
                        break;
                    case 'weekly':
                        const chosenDateForWeek = reportDateInput.value ? new Date(reportDateInput.value) : today;
                        const firstDayOfWeek = chosenDateForWeek.getDate() - chosenDateForWeek.getDay() + (chosenDateForWeek.getDay() === 0 ? -6 : 1); // Adjust to make Monday the first day
                        startDate = new Date(chosenDateForWeek.setDate(firstDayOfWeek));
                        startDate.setHours(0, 0, 0, 0);

                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 6);
                        endDate.setHours(23, 59, 59, 999);
                        title = `تقرير أسبوعي: من ${startDate.toLocaleDateString('ar-EG')} إلى ${endDate.toLocaleDateString('ar-EG')}`;
                        break;
                    case 'monthly':
                        const chosenDateForMonth = reportDateInput.value ? new Date(reportDateInput.value) : today;
                        startDate = new Date(chosenDateForMonth.getFullYear(), chosenDateForMonth.getMonth(), 1);
                        endDate = new Date(chosenDateForMonth.getFullYear(), chosenDateForMonth.getMonth() + 1, 0);
                        endDate.setHours(23, 59, 59, 999);
                        title = `تقرير شهري: ${startDate.toLocaleDateString('ar-EG-u-nu-latn', { year: 'numeric', month: 'long' })}`;
                        break;
                    case 'custom':
                        if (!reportDateInput.value || !reportEndDateInput.value) {
                            showAlert('Please select a start and end date for the custom range.');
                            return;
                        }
                        startDate = new Date(reportDateInput.value);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = new Date(reportEndDateInput.value);
                        endDate.setHours(23, 59, 59, 999);

                        if (startDate > endDate) {
                            showAlert('Start date cannot be after the end date.');
                            return;
                        }
                        title = `تقرير مخصص: من ${startDate.toLocaleDateString('ar-EG')} إلى ${endDate.toLocaleDateString('ar-EG')}`;
                        break;
                }

                const filteredInvoices = firestoreInvoices.filter(inv => inv.timestamp >= startDate.getTime() && inv.timestamp <= endDate.getTime());
                const filteredReturns = firestoreReturns.filter(ret => ret.timestamp >= startDate.getTime() && ret.timestamp <= endDate.getTime());
                
                // --- Calculations ---
                const totalSales = filteredInvoices.reduce((sum, inv) => sum + inv.total, 0);
                const totalReturnValue = filteredReturns.reduce((sum, ret) => sum + ret.total, 0); // Returns are negative
                const netSales = totalSales + totalReturnValue;
                const transactionCount = filteredInvoices.length;

                const paymentMethodTotals = filteredInvoices.reduce((acc, inv) => {
                    acc[inv.paymentMethod] = (acc[inv.paymentMethod] || 0) + inv.total;
                    return acc;
                }, {});

                const cashierTotals = filteredInvoices.reduce((acc, inv) => {
                    const cashier = inv.sellerName || 'Unknown';
                    acc[cashier] = (acc[cashier] || 0) + inv.total;
                    return acc;
                }, {});
                
                const productSales = filteredInvoices.reduce((acc, inv) => {
                    inv.items.forEach(item => {
                        if (item.id.startsWith('custom-')) return;
                        
                        const originalProduct = products.find(p => p.id === item.id);
                        if (!originalProduct) return;

                        const key = item.name;

                        if (!acc[key]) {
                            acc[key] = {
                                quantity: 0,
                                totalSalesValue: 0,
                                totalDiscount: 0,
                                totalPurchaseValue: 0,
                                purchasePrice: originalProduct.purchasePrice || 0,
                                profitMargin: originalProduct.profitMargin || 0,
                                sellingPrice: item.price
                            };
                            
                            if (item.code) {
                                const codeData = originalProduct.codes?.find(c => c.code === item.code);
                                if (codeData) {
                                    acc[key].purchasePrice = codeData.purchasePrice || originalProduct.purchasePrice || 0;
                                    acc[key].profitMargin = codeData.profitMargin || originalProduct.profitMargin || 0;
                                }
                            }
                        }

                        acc[key].quantity += item.quantity;
                        acc[key].totalSalesValue += (item.price * item.quantity) - (item.discount || 0);
                        acc[key].totalDiscount += (item.discount || 0);
                        acc[key].totalPurchaseValue += acc[key].purchasePrice * item.quantity;
                    });
                    return acc;
                }, {});

                const topSellingProducts = Object.entries(productSales)
                    .sort(([,a],[,b]) => b.quantity - a.quantity)
                    .slice(0, 10);

                // --- Calculations for Overall Product Profit ---
                const allProductsSold = Object.values(productSales);
                const totalPurchaseValueOfAllProducts = allProductsSold.reduce((sum, product) => sum + product.totalPurchaseValue, 0);
                const totalSalesValueOfAllProducts = allProductsSold.reduce((sum, product) => sum + product.totalSalesValue, 0);
                const totalNetProfitOfAllProducts = totalSalesValueOfAllProducts - totalPurchaseValueOfAllProducts;


                // --- HTML Generation ---
                const createStatCard = (label, value, icon, colorClass) => `
                    <div class="bg-slate-100 p-4 rounded-lg flex items-center gap-4">
                        <div class="w-10 h-10 flex-shrink-0 flex items-center justify-center ${colorClass} text-white rounded-lg">
                            <i data-lucide="${icon}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500 font-medium">${label}</p>
                            <p class="text-xl font-bold text-slate-800">${value}</p>
                        </div>
                    </div>
                `;

                const createTable = (title, headers, rows) => {
                    if (rows.length === 0) return '';
                    return `
                    <div class="mt-6">
                        <h4 class="text-lg font-bold mb-3 text-slate-700 text-center">${title}</h4>
                        <table class="w-full text-sm text-right">
                            <thead class="bg-slate-100">
                                <tr>
                                    ${headers.map(h => `<th class="p-2 font-semibold text-slate-600 ${h.align === 'left' ? 'text-left' : 'text-right'}">${h.label}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${rows.map(row => `<tr class="border-b border-slate-200">${row.map((cell, index) => `<td class="p-2 ${headers[index].align === 'left' ? 'text-left' : 'text-right'} ${headers[index].isBold ? 'font-bold' : ''}">${cell}</td>`).join('')}</tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `};

                const paymentRows = Object.entries(paymentMethodTotals).map(([method, total]) => [method, total.toFixed(2) + ' ج.م']);
                const cashierRows = Object.entries(cashierTotals).map(([name, total]) => [name, total.toFixed(2) + ' ج.م']);
                const productRows = topSellingProducts.map(([name, data]) => {
                    const netProfit = data.totalSalesValue - data.totalPurchaseValue;
                    return [
                        name, 
                        data.quantity,
                        data.purchasePrice.toFixed(2),
                        `${data.profitMargin}%`,
                        data.sellingPrice.toFixed(2),
                        data.totalDiscount.toFixed(2),
                        data.totalPurchaseValue.toFixed(2),
                        data.totalSalesValue.toFixed(2) + ' ج.م',
                        netProfit.toFixed(2) + ' ج.م'
                    ];
                });

                reportContent.innerHTML = `
                    <div dir="rtl" class="text-right">
                        <div class="text-center mb-6 pb-4 border-b-2 border-slate-300">
                            <h3 class="text-2xl font-bold text-slate-800">${workerPermissions.shopName} - تقرير المبيعات</h3>
                            <p class="text-base text-slate-600">${title}</p>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${createStatCard('صافي المبيعات', netSales.toFixed(2) + ' ج.م', 'wallet', 'bg-green-500')}
                            ${createStatCard('إجمالي المبيعات', totalSales.toFixed(2) + ' ج.م', 'trending-up', 'bg-blue-500')}
                            ${createStatCard('إجمالي المرتجعات', Math.abs(totalReturnValue).toFixed(2) + ' ج.م', 'trending-down', 'bg-red-500')}
                            ${createStatCard('عدد الفواتير', transactionCount, 'file-text', 'bg-indigo-500')}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${createTable('المبيعات حسب وسيلة الدفع', [{label: 'الوسيلة', align: 'right'}, {label: 'المجموع', align: 'left', isBold: true}], paymentRows)}
                            ${createTable('المبيعات حسب البائع', [{label: 'البائع', align: 'right'}, {label: 'المجموع', align: 'left', isBold: true}], cashierRows)}
                        </div>
                        
                        ${createTable('المنتجات الأكثر مبيعًا', 
                            [
                                {label: 'المنتج', align: 'right'}, 
                                {label: 'الكمية', align: 'right'}, 
                                {label: 'سعر الشراء', align: 'right'},
                                {label: 'هامش الربح', align: 'right'},
                                {label: 'سعر البيع', align: 'right'},
                                {label: 'الخصم', align: 'right'},
                                {label: 'قيمة الشراء', align: 'right'},
                                {label: 'قيمة المبيعات', align: 'right'},
                                {label: 'صافي الربح', align: 'left', isBold: true}
                            ], 
                            productRows
                        )}

                        <div class="mt-8 pt-6 border-t-2 border-slate-300">
                             <h4 class="text-xl font-bold mb-4 text-slate-700 text-center">ملخص أرباح المنتجات</h4>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                 <!-- Card 1: Purchase Value -->
                                 <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200/80 flex items-start gap-5">
                                     <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center bg-gradient-to-br from-red-500 to-orange-500 text-white rounded-xl shadow-md shadow-red-500/30">
                                         <i data-lucide="arrow-down-circle" class="w-7 h-7"></i>
                                     </div>
                                     <div>
                                         <p class="text-base font-semibold text-slate-500">إجمالي قيمة الشراء</p>
                                         <p class="text-3xl font-black text-slate-800 tracking-tight">${totalPurchaseValueOfAllProducts.toFixed(2)} ج.م</p>
                                     </div>
                                 </div>
                                 <!-- Card 2: Sales Value -->
                                 <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200/80 flex items-start gap-5">
                                     <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center bg-gradient-to-br from-blue-500 to-cyan-500 text-white rounded-xl shadow-md shadow-blue-500/30">
                                         <i data-lucide="trending-up" class="w-7 h-7"></i>
                                     </div>
                                     <div>
                                         <p class="text-base font-semibold text-slate-500">إجمالي قيمة المبيعات</p>
                                         <p class="text-3xl font-black text-slate-800 tracking-tight">${totalSalesValueOfAllProducts.toFixed(2)} ج.م</p>
                                     </div>
                                 </div>
                                 <!-- Card 3: Net Profit -->
                                 <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200/80 flex items-start gap-5">
                                     <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-xl shadow-md shadow-green-500/30">
                                         <i data-lucide="bar-chart-2" class="w-7 h-7"></i>
                                     </div>
                                     <div>
                                         <p class="text-base font-semibold text-slate-500">صافي الربح</p>
                                         <p class="text-3xl font-black text-slate-800 tracking-tight">${totalNetProfitOfAllProducts.toFixed(2)} ج.م</p>
                                     </div>
                                 </div>
                             </div>
                         </div>
                    </div>
                `;

                lucide.createIcons();
                printReportBtn.disabled = false;
            };


            const printReport = async () => {
                if (!reportContent.innerHTML.includes("تقرير")) {
                    showAlert("Please generate a report first.");
                    return;
                }
                
                // Re-calculate ranges and filter data for printing
                const reportType = reportTypeSelect.value;
                let startDate, endDate;
                let title = '';
                const today = new Date();
                today.setHours(0,0,0,0);

                switch(reportType) {
                    case 'daily':
                        const selectedDateStr = reportDateInput.value;
                        const selectedDate = new Date(selectedDateStr);
                        const timezoneOffset = selectedDate.getTimezoneOffset() * 60000;
                        startDate = new Date(new Date(selectedDate.getTime() + timezoneOffset).setHours(0, 0, 0, 0));
                        endDate = new Date(new Date(selectedDate.getTime() + timezoneOffset).setHours(23, 59, 59, 999));
                        title = `تقرير يومي: ${startDate.toLocaleDateString('ar-EG-u-nu-latn', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
                        break;
                    case 'weekly':
                        const chosenDateForWeek = reportDateInput.value ? new Date(reportDateInput.value) : today;
                        const firstDayOfWeek = chosenDateForWeek.getDate() - chosenDateForWeek.getDay() + (chosenDateForWeek.getDay() === 0 ? -6 : 1);
                        startDate = new Date(chosenDateForWeek.setDate(firstDayOfWeek));
                        startDate.setHours(0, 0, 0, 0);
                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 6);
                        endDate.setHours(23, 59, 59, 999);
                        title = `تقرير أسبوعي: من ${startDate.toLocaleDateString('ar-EG')} إلى ${endDate.toLocaleDateString('ar-EG')}`;
                        break;
                    case 'monthly':
                         const chosenDateForMonth = reportDateInput.value ? new Date(reportDateInput.value) : today;
                        startDate = new Date(chosenDateForMonth.getFullYear(), chosenDateForMonth.getMonth(), 1);
                        endDate = new Date(chosenDateForMonth.getFullYear(), chosenDateForMonth.getMonth() + 1, 0);
                        endDate.setHours(23, 59, 59, 999);
                        title = `تقرير شهري: ${startDate.toLocaleDateString('ar-EG-u-nu-latn', { year: 'numeric', month: 'long' })}`;
                        break;
                    case 'custom':
                        startDate = new Date(reportDateInput.value);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = new Date(reportEndDateInput.value);
                        endDate.setHours(23, 59, 59, 999);
                        title = `تقرير مخصص: من ${startDate.toLocaleDateString('ar-EG')} إلى ${endDate.toLocaleDateString('ar-EG')}`;
                        break;
                }

                const filteredInvoices = firestoreInvoices.filter(inv => inv.timestamp >= startDate.getTime() && inv.timestamp <= endDate.getTime());
                const filteredReturns = firestoreReturns.filter(ret => ret.timestamp >= startDate.getTime() && ret.timestamp <= endDate.getTime());

                const createPrintSection = (title, items, isReturn = false) => {
                    let rows = items.map(item => `
                        <tr class="border-b">
                            <td class="p-2 text-right">
                                <div class="font-bold font-mono">${item.id}</div>
                                <div class="text-sm text-slate-500">${isReturn ? `مرتجع من: ${item.originalInvoiceId}` : (item.customerName || 'عميل نقدي')}</div>
                            </td>
                            <td class="p-2 text-left align-middle font-mono font-bold">${item.total.toFixed(2)}</td>
                        </tr>
                    `).join('');

                    if (items.length === 0) {
                        rows = '<tr><td colspan="2" class="p-3 text-center text-gray-500">لا يوجد</td></tr>';
                    }

                    return `
                        <div class="mb-6">
                            <h4 class="text-xl font-bold text-center mb-3 pb-2 border-b-2 ${isReturn ? 'text-red-600 border-red-400' : 'text-slate-800 border-slate-400'}">${title}</h4>
                            <table class="w-full text-sm">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="p-2 text-right font-semibold text-slate-600">الفاتورة / العميل</th>
                                        <th class="p-2 text-left font-semibold text-slate-600">المبلغ</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>
                    `;
                };

                const totalSales = filteredInvoices.reduce((sum, inv) => sum + inv.total, 0);
                const totalReturnValue = filteredReturns.reduce((sum, ret) => sum + ret.total, 0);
                const netSales = totalSales + totalReturnValue;

                const printLayoutHTML = `
                    <div class="p-4" dir="rtl">
                        <div class="text-center mb-6 pb-4 border-b">
                            <h3 class="text-3xl font-bold">${workerPermissions.shopName}</h3>
                            <p class="text-lg text-slate-600">${title}</p>
                        </div>

                        ${createPrintSection('ملخص المبيعات', filteredInvoices, false)}
                        ${createPrintSection('ملخص المرتجعات', filteredReturns, true)}

                        <div class="mt-6 pt-4 border-t-2 border-slate-300">
                            <div class="space-y-2 text-lg w-full max-w-sm ml-auto">
                                <div class="flex justify-between font-semibold">
                                    <span class="text-slate-600">إجمالي المبيعات:</span>
                                    <span class="font-mono">${totalSales.toFixed(2)} ج.م</span>
                                </div>
                                <div class="flex justify-between font-semibold">
                                    <span class="text-slate-600">إجمالي المرتجعات:</span>
                                    <span class="font-mono text-red-500">${Math.abs(totalReturnValue).toFixed(2)} ج.م</span>
                                </div>
                                <div class="flex justify-between font-bold text-2xl mt-2 pt-2 border-t border-slate-300">
                                    <span class="text-slate-800">صافي الإجمالي:</span>
                                    <span class="font-mono">${netSales.toFixed(2)} ج.م</span>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; font-size: 0.75rem; color: #555; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                            powered by Al-Badr<br>01069913150
                        </div>
                    </div>
                `;
                
                printHTML(printLayoutHTML);
            };

            const printExpenses = () => {
                if (firestoreExpenses.length === 0) {
                    showAlert('No expenses to print.');
                    return;
                }

                let totalAmount = 0;
                const expensesRows = firestoreExpenses.map(expense => {
                    totalAmount += parseFloat(expense.amount);
                    const expenseDate = expense.date ? new Date(expense.date).toLocaleDateString('ar-EG-u-nu-latn') : 'N/A';
                    return `
                        <tr class="border-b border-slate-200">
                            <td class="p-2">${expense.description}</td>
                            <td class="p-2">${expense.type}</td>
                            <td class="p-2">${expenseDate}</td>
                            <td class="p-2 text-left font-mono">${parseFloat(expense.amount).toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                const printContent = `
                    <div dir="rtl" class="text-right p-4 bg-white">
                        <div class="text-center mb-6 pb-4 border-b-2 border-slate-300">
                            <h3 class="text-2xl font-bold text-slate-800">${workerPermissions.shopName} - تقرير المصروفات</h3>
                            <p class="text-base text-slate-600">تاريخ الطباعة: ${new Date().toLocaleString('ar-EG-u-nu-latn')}</p>
                        </div>

                        <div class="grid grid-cols-1 gap-4 mb-6">
                             <div class="bg-red-100 p-4 rounded-lg flex items-center gap-4">
                                 <div class="w-10 h-10 flex-shrink-0 flex items-center justify-center bg-red-500 text-white rounded-lg">
                                     <!-- Icon placeholder for print -->
                                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2h4z"/></svg>
                                 </div>
                                 <div>
                                     <p class="text-sm text-slate-500 font-medium">إجمالي المصروفات</p>
                                     <p class="text-xl font-bold text-slate-800">${totalAmount.toFixed(2)} ج.م</p>
                                 </div>
                             </div>
                         </div>

                        <div>
                            <h4 class="text-lg font-bold mb-3 text-slate-700 text-center">تفاصيل المصروفات</h4>
                            <table class="w-full text-sm text-right">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="p-2 font-semibold text-slate-600 text-right">البيان</th>
                                        <th class="p-2 font-semibold text-slate-600 text-right">النوع</th>
                                        <th class="p-2 font-semibold text-slate-600 text-right">التاريخ</th>
                                        <th class="p-2 font-semibold text-slate-600 text-left">المبلغ (ج.م)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${expensesRows}
                                </tbody>
                            </table>
                        </div>
                        <div style="text-align: center; font-size: 0.75rem; color: #555; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                            powered by Al-Badr<br>01069913150
                        </div>
                    </div>
                `;

                printHTML(printContent);
            };

            loginBtn.addEventListener('click', handleLoginAndSync);
            ownerSettingsBtn.addEventListener('click', () => {
                loginForSettings = true;
                handleLoginAndSync();
            });
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredProducts = products.filter(p => {
                    const nameMatch = p.name.toLowerCase().includes(searchTerm);
                    const codeMatch = p.codes && p.codes.some(c => c.code.toLowerCase().includes(searchTerm));
                    return nameMatch || codeMatch;
                });
                renderProducts(filteredProducts);
            });
            productsGrid.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-product-btn');
                const productCard = e.target.closest('.product-card');

                if (editBtn) {
                    e.stopPropagation();
                    if (!isDeveloperMode) {
                        showAlert('You do not have permission to edit products.');
                        return;
                    }
                    const productId = editBtn.dataset.id;
                    const productToEdit = products.find(p => p.id === productId);
                    openEditProductModal(productToEdit);
                } else if (productCard && !productCard.disabled) {
                    const productToAdd = products.find(p => p.id === productCard.dataset.id);
                    if(productToAdd) {
                        if (productToAdd.codes && productToAdd.codes.length > 0) {
                            openProductCodeModal(productToAdd);
                        } else {
                            addToCart(productToAdd);
                        }
                    }
                }
            });

            inventoryGrid.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.inventory-edit-btn');
                const card = e.target.closest('.inventory-card');
                const header = e.target.closest('.inventory-card-header');

                if (editBtn) {
                    e.stopPropagation(); 
                    const productId = editBtn.dataset.id;
                    const productToEdit = products.find(p => p.id === productId);
                    openEditProductModal(productToEdit);
                } else if (header && card) {
                    const details = card.querySelector('.inventory-card-details');
                    if (details) {
                        // Close other expanded cards
                        const allCards = inventoryGrid.querySelectorAll('.inventory-card.expanded');
                        allCards.forEach(otherCard => {
                            if(otherCard !== card) {
                                otherCard.classList.remove('expanded');
                            }
                        });
                        // Toggle the clicked card
                        card.classList.toggle('expanded');
                    }
                }
            });

            modalSaveBtn.addEventListener('click', async () => {
                const productId = editProductIdInput.value;
                const isUnlimited = editUnlimitedStockCheckbox.checked;
                
                const codeElements = productCodesList.querySelectorAll('.product-code-entry');
                const codes = Array.from(codeElements).map(div => {
                    const hasInputs = div.querySelector('input.product-code-quantity-input');

                    if (hasInputs) {
                        // This is a newly added variation with input fields
                        return {
                            code: div.querySelector('.code-name').textContent.trim(),
                            purchasePrice: parseFloat(div.querySelector('.product-code-purchase-price-input').value) || 0,
                            profitMargin: parseFloat(div.querySelector('.product-code-profit-margin-input').value) || 0,
                            price: parseFloat(div.querySelector('.product-code-price-input').value) || 0,
                            quantity: parseInt(div.querySelector('.product-code-quantity-input').value, 10) || 0,
                            discount: parseInt(div.querySelector('.product-code-discount-input').value, 10) || 0,
                        };
                    } else {
                        // This is an existing variation, read from dataset
                        return {
                            code: div.dataset.code,
                            purchasePrice: parseFloat(div.dataset.purchasePrice) || 0,
                            profitMargin: parseFloat(div.dataset.profitMargin) || 0,
                            price: parseFloat(div.dataset.price) || 0,
                            quantity: parseInt(div.dataset.quantity, 10) || 0,
                            discount: parseInt(div.dataset.discount, 10) || 0
                        };
                    }
                });

                const totalQuantityFromCodes = codes.reduce((sum, item) => sum + item.quantity, 0);
                const hasCodes = codes.length > 0;
                
                const newData = {
                    name: editProductNameInput.value,
                    purchasePrice: parseFloat(document.getElementById('edit-product-purchase-price').value) || 0,
                    profitMargin: parseFloat(document.getElementById('edit-product-profit-margin').value) || 0,
                    price: parseFloat(editProductPriceInput.value) || 0,
                    discount: parseInt(document.getElementById('edit-product-discount').value, 10) || 0,
                    quantity: isUnlimited ? Infinity : (hasCodes ? totalQuantityFromCodes : (parseInt(editProductQuantityInput.value, 10) || 0)),
                    codes: codes
                };
                
                await updateProduct(productId, newData);
                editProductModal.classList.add('hidden');
            });
            modalDeleteProductBtn.addEventListener('click', async () => {
                const confirmed = await showPasswordModal('Confirm Product Deletion', 'To delete this product, please enter the owner password.');
                if (confirmed === workerPassword) await deleteProduct(editProductIdInput.value);
                else if (confirmed !== null) await showAlert('Incorrect password.');
            });
            modalEditCancelBtn.addEventListener('click', () => editProductModal.classList.add('hidden'));
            tenderedInput.addEventListener('input', updateTotals);
            invoiceDiscountInput.addEventListener('input', updateTotals);
            customerNameInput.addEventListener('input', (e) => customerName = e.target.value);
            customerPhoneInput.addEventListener('input', (e) => customerPhone = e.target.value);
            invoiceNotesInput.addEventListener('input', (e) => invoiceNotes = e.target.value);
            cartItemsTbody.addEventListener('input', (e) => {
                const target = e.target;
                if (target.classList.contains('item-discount-input')) {
                    const id = target.dataset.id;
                    const discountValue = parseFloat(target.value) || 0;
                    updateItemDiscount(id, discountValue);
                }
            });
            cartItemsTbody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                if (target.classList.contains('quantity-btn')) updateQuantity(id, Number(target.dataset.amount));
                else if (target.classList.contains('remove-btn')) removeFromCart(id);
            });
            addCustomItemBtn.addEventListener('click', () => {
                const name = customItemNameInput.value.trim();
                const price = parseFloat(customItemPriceInput.value) || 0;
                if (!name || price <= 0) { showAlert('Please enter a correct name and price for the product.'); return; }
                addToCart({ id: 'custom-' + Date.now(), name, price, quantity: Infinity }, 1); 
                customItemNameInput.value = '';
                customItemPriceInput.value = '';
            });
            addNewProductBtn.addEventListener('click', addNewProductToFirestore);

            unlimitedStockCheckbox.addEventListener('change', () => {
                const isChecked = unlimitedStockCheckbox.checked;
                newProductQuantityInput.disabled = isChecked;
                if (isChecked) {
                    newProductQuantityInput.value = ''; 
                    newProductQuantityInput.placeholder = 'Unlimited';
                } else {
                    newProductQuantityInput.placeholder = '';
                }
            });

            editUnlimitedStockCheckbox.addEventListener('change', () => {
                const isChecked = editUnlimitedStockCheckbox.checked;
                editProductQuantityInput.disabled = isChecked;
                if (isChecked) {
                    editProductQuantityInput.value = ''; 
                    editProductQuantityInput.placeholder = 'Unlimited';
                } else {
                    editProductQuantityInput.placeholder = '';
                }
            });

            clearSaleBtn.addEventListener('click', clearSale);
            printReceiptBtn.addEventListener('click', handleSaveAction);
            previewReceiptBtn.addEventListener('click', displayReceiptPreview);
            viewInvoicesBtn.addEventListener('click', showSavedInvoicesView);
            viewReturnsBtn.addEventListener('click', showReturnsView);
            backToPosBtn.addEventListener('click', showPosView);
            backToPosFromReturnsBtn.addEventListener('click', showPosView);
            backToPosFromExpensesBtn.addEventListener('click', showPosView);
            backToPosFromInventoryBtn.addEventListener('click', showPosView);
            backToInvoicesBtn.addEventListener('click', () => {
                invoiceDetailsView.classList.add('hidden-view');
                invoicesView.classList.remove('hidden-view');
            });
            
            invoiceSearchInput.addEventListener('input', renderSavedInvoicesList);
            invoiceStartDateInput.addEventListener('change', renderSavedInvoicesList);
            invoiceEndDateInput.addEventListener('change', renderSavedInvoicesList);
            returnSearchInput.addEventListener('input', renderSavedReturnsList);
            returnStartDateInput.addEventListener('change', renderSavedReturnsList);
            returnEndDateInput.addEventListener('change', renderSavedReturnsList);
            inventorySearchInput.addEventListener('input', renderInventoryList);
            viewCustomersBtn.addEventListener('click', openCustomersModal);
            customersCloseBtn.addEventListener('click', () => customersModal.classList.add('hidden'));
            downloadCustomersBtn.addEventListener('click', downloadCustomersAsExcel);
            customerSearchInput.addEventListener('input', (e) => {
                renderCustomersList(e.target.value.toLowerCase());
            });
            
            customersListTbody.addEventListener('click', (e) => {
                const addButton = e.target.closest('.add-customer-to-invoice-btn');
                if (addButton) {
                    const name = addButton.dataset.name;
                    const phone = addButton.dataset.phone;

                    customerNameInput.value = name;
                    customerPhoneInput.value = phone;
                    
                    customerName = name;
                    customerPhone = phone;

                    customersModal.classList.add('hidden');
                }
            });

            // New Report Modal Listeners
            reportsCloseBtn.addEventListener('click', () => reportsModal.classList.add('hidden'));
            printReportBtn.addEventListener('click', printReport);
            generateReportBtn.addEventListener('click', generateAndDisplayReport);
            reportTypeSelect.addEventListener('change', (e) => {
                const type = e.target.value;
                reportEndDatePicker.classList.toggle('hidden', type !== 'custom');
                
                switch(type) {
                    case 'daily':
                        reportStartDateLabel.textContent = 'Select Date';
                        break;
                    case 'weekly':
                        reportStartDateLabel.textContent = 'Select Day in Week';
                        break;
                    case 'monthly':
                        reportStartDateLabel.textContent = 'Select Day in Month';
                        break;
                    case 'custom':
                        reportStartDateLabel.textContent = 'Start Date';
                        break;
                }
            });
            addExpenseBtn.addEventListener('click', addExpenseToFirestore);
            printExpensesBtn.addEventListener('click', printExpenses);
            
            deleteAllExpensesBtn.addEventListener('click', deleteAllExpenses);
            expensesGrid.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-expense-btn');
                const editButton = e.target.closest('.edit-expense-btn');
                const header = e.target.closest('.expense-card-header');

                if (deleteButton) {
                    e.stopPropagation(); // Prevent the card from toggling
                    const firestoreId = deleteButton.dataset.firestoreId;
                    deleteExpense(firestoreId);
                } else if (editButton) {
                    e.stopPropagation();
                    const firestoreId = editButton.dataset.firestoreId;
                    const expenseToEdit = firestoreExpenses.find(ex => ex.firestoreId === firestoreId);
                    if (expenseToEdit) {
                        editExpenseIdInput.value = firestoreId;
                        editExpenseDescriptionInput.value = expenseToEdit.description;
                        editExpenseTypeInput.value = expenseToEdit.type;
                        editExpenseAmountInput.value = expenseToEdit.amount;
                        editExpenseNotesTextarea.value = expenseToEdit.notes || '';
                        editExpenseModal.classList.remove('hidden');
                        lucide.createIcons();
                    }
                } else if (header) {
                    const details = header.nextElementSibling;
                    const chevron = header.querySelector('.chevron-icon');
                    details.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-180');
                }
            });

            developerInfoCloseBtn.addEventListener('click', () => {
                developerInfoModal.classList.add('hidden');
            });

            modalSaveExpenseBtn.addEventListener('click', async () => {
                const expenseId = editExpenseIdInput.value;
                const newData = {
                    description: editExpenseDescriptionInput.value.trim(),
                    type: editExpenseTypeInput.value.trim(),
                    amount: parseFloat(editExpenseAmountInput.value),
                    notes: editExpenseNotesTextarea.value.trim(),
                    editedTimestamp: Date.now()
                };

                if (!newData.description || !newData.type || isNaN(newData.amount) || newData.amount <= 0) {
                    showAlert('Please enter a valid description, type, and amount.');
                    return;
                }
                
                await updateExpenseInFirestore(expenseId, newData);
                editExpenseModal.classList.add('hidden');
            });
            
            modalEditExpenseCancelBtn.addEventListener('click', () => {
                editExpenseModal.classList.add('hidden');
            });

            expenseTypeInput.addEventListener('click', () => {
                currentExpenseTypeInput = expenseTypeInput;
                populateExpenseTypeModal();
                expenseTypeModal.classList.remove('hidden');
                lucide.createIcons();
            });

            editExpenseTypeInput.addEventListener('click', () => {
                currentExpenseTypeInput = editExpenseTypeInput;
                populateExpenseTypeModal();
                expenseTypeModal.classList.remove('hidden');
                lucide.createIcons();
            });

            expenseTypeCloseBtn.addEventListener('click', () => {
                expenseTypeModal.classList.add('hidden');
            });

            const updateTotalQuantityInModal = () => {
                if (editProductModal.classList.contains('hidden')) return;

                const codeElements = productCodesList.querySelectorAll('.grid');
                if (codeElements.length > 0) {
                    const totalQuantityFromCodes = Array.from(codeElements).reduce((sum, div) => {
                        const quantityInput = div.querySelector('.product-code-quantity-input');
                        return sum + (parseInt(quantityInput.value, 10) || 0);
                    }, 0);
                    
                    editProductQuantityInput.value = totalQuantityFromCodes;
                    editProductQuantityInput.disabled = true;
                    editProductQuantityInput.placeholder = 'Auto-calculated';
                } else {
                     editProductQuantityInput.disabled = editUnlimitedStockCheckbox.checked;
                     editProductQuantityInput.placeholder = editUnlimitedStockCheckbox.checked ? 'Unlimited' : '';
                }
            };

            systemLockEnabledToggle.addEventListener('change', () => {
                workerPermissions.systemLock.enabled = systemLockEnabledToggle.checked;
                systemLockTimesContainer.style.display = systemLockEnabledToggle.checked ? 'grid' : 'none';
                saveWorkerPermissions();
                checkSystemLock(); // Immediately check status on change
            });

            systemLockTimeInput.addEventListener('change', () => {
                workerPermissions.systemLock.lockTime = systemLockTimeInput.value;
                saveWorkerPermissions();
            });

            systemUnlockTimeInput.addEventListener('change', () => {
                workerPermissions.systemLock.unlockTime = systemUnlockTimeInput.value;
                saveWorkerPermissions();
            });

            lockOverridePromptBtn.addEventListener('click', async () => {
                const password = await showPasswordModal('Manager Override', 'Please enter the manager password to unlock the system.');
                if (password === workerPassword) {
                    isLockOverridden = true;
                    systemLockModal.classList.add('hidden');
                    await showAlert('System unlocked temporarily.');
                } else if (password !== null) {
                    await showAlert('Incorrect manager password.');
                }
            });

            addProductCodeBtn.addEventListener('click', () => {
                const newCode = newProductCodeInput.value.trim();
                const newPurchasePrice = parseFloat(document.getElementById('new-product-code-purchase-price').value) || 0;
                const newProfitMargin = parseFloat(document.getElementById('new-product-code-profit-margin').value) || 0;
                const newPrice = parseFloat(document.getElementById('new-product-code-price').value) || 0;
                const newQuantity = parseInt(document.getElementById('new-product-code-quantity').value, 10) || 0;
                const newDiscount = parseInt(document.getElementById('new-product-code-discount').value, 10) || 0;

                if (newCode) {
                    const codeEl = document.createElement('div');
                    codeEl.className = 'product-code-entry bg-white p-3 rounded-xl border border-slate-200 flex flex-col sm:flex-row items-start sm:items-center gap-4';
                    codeEl.innerHTML = `
                         <div class="w-full sm:w-1/4">
                            <div class="flex items-center justify-between">
                                <span class="font-bold text-slate-800 code-name">${newCode}</span>
                                <button class="delete-product-code-btn sm:hidden text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100">
                                    <i data-lucide="x-circle" class="w-5 h-5 pointer-events-none"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex-grow grid grid-cols-2 sm:grid-cols-5 gap-2 w-full">
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">Purchase</label>
                                <input type="number" value="${newPurchasePrice || ''}" class="product-code-purchase-price-input p-1.5 input-field text-center text-sm rounded-md w-full">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">Profit %</label>
                                <input type="number" value="${newProfitMargin || ''}" class="product-code-profit-margin-input p-1.5 input-field text-center text-sm rounded-md w-full">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">Selling</label>
                                <input type="number" value="${newPrice || ''}" class="product-code-price-input p-1.5 input-field text-center text-sm rounded-md font-bold bg-slate-100 w-full">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">Qty</label>
                                <input type="number" value="${newQuantity}" class="product-code-quantity-input p-1.5 input-field text-center text-sm rounded-md w-full">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1">Disc. %</label>
                                <input type="number" value="${newDiscount || ''}" class="product-code-discount-input p-1.5 input-field text-center text-sm rounded-md w-full">
                            </div>
                        </div>
                        <button class="delete-product-code-btn hidden sm:block text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100">
                            <i data-lucide="x-circle" class="w-5 h-5 pointer-events-none"></i>
                        </button>
                    `;
                    
                    const purchaseInput = codeEl.querySelector('.product-code-purchase-price-input');
                    const profitInput = codeEl.querySelector('.product-code-profit-margin-input');
                    const sellingInput = codeEl.querySelector('.product-code-price-input');

                    purchaseInput.addEventListener('input', () => calculateSellingPrice(purchaseInput, profitInput, sellingInput));
                    profitInput.addEventListener('input', () => calculateSellingPrice(purchaseInput, profitInput, sellingInput));

                    codeEl.querySelector('.delete-product-code-btn').onclick = (e) => {
                        e.target.closest('.product-code-entry').remove();
                        updateTotalQuantityInModal();
                    };
                    codeEl.querySelector('.product-code-quantity-input').oninput = updateTotalQuantityInModal;
                    productCodesList.appendChild(codeEl);
                    
                    // Clear input fields for adding a new variation
                    newProductCodeInput.value = '';
                    document.getElementById('new-product-code-purchase-price').value = '';
                    document.getElementById('new-product-code-profit-margin').value = '';
                    document.getElementById('new-product-code-price').value = '';
                    document.getElementById('new-product-code-quantity').value = '';
                    document.getElementById('new-product-code-discount').value = '';

                    lucide.createIcons();
                    updateTotalQuantityInModal();
                }
            });

            productCodeCloseBtn.addEventListener('click', () => {
                productCodeModal.classList.add('hidden');
            });

            modalEditCodeCancelBtn.addEventListener('click', () => editProductCodeModal.classList.add('hidden'));

            const openEditCodeModal = (codeCardElement) => {
                const code = codeCardElement.dataset.code;
                
                document.getElementById('edit-product-code-original-code').value = code;
                document.getElementById('edit-code-name-input').value = code;
                document.getElementById('edit-code-purchase-price').value = codeCardElement.dataset.purchasePrice;
                document.getElementById('edit-code-profit-margin').value = codeCardElement.dataset.profitMargin;
                document.getElementById('edit-code-price').value = codeCardElement.dataset.price;
                document.getElementById('edit-code-quantity').value = codeCardElement.dataset.quantity;
                document.getElementById('edit-code-discount').value = codeCardElement.dataset.discount;

                editProductCodeModal.classList.remove('hidden');
                lucide.createIcons();
            };

            const saveProductCodeChanges = () => {
                const originalCode = document.getElementById('edit-product-code-original-code').value;
                const codeCardElement = productCodesList.querySelector(`.product-code-entry[data-code="${originalCode}"]`);

                if (!codeCardElement) {
                    showAlert('Could not find the variation to update.');
                    return;
                }

                // Read new values from modal
                const newCode = document.getElementById('edit-code-name-input').value.trim();
                const newPurchasePrice = parseFloat(document.getElementById('edit-code-purchase-price').value) || 0;
                const newProfitMargin = parseFloat(document.getElementById('edit-code-profit-margin').value) || 0;
                const newPrice = parseFloat(document.getElementById('edit-code-price').value) || 0;
                const newQuantity = parseInt(document.getElementById('edit-code-quantity').value, 10) || 0;
                const newDiscount = parseInt(document.getElementById('edit-code-discount').value, 10) || 0;

                if (!newCode) {
                    showAlert('Variation name/code cannot be empty.');
                    return;
                }

                // Update the dataset attributes on the card in the main modal
                codeCardElement.dataset.code = newCode;
                codeCardElement.dataset.purchasePrice = newPurchasePrice;
                codeCardElement.dataset.profitMargin = newProfitMargin;
                codeCardElement.dataset.price = newPrice;
                codeCardElement.dataset.quantity = newQuantity;
                codeCardElement.dataset.discount = newDiscount;

                // Update the display HTML of the card
                codeCardElement.innerHTML = `
                     <div class="w-full sm:w-1/4 pointer-events-none">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-slate-800 code-name">${newCode}</span>
                        </div>
                    </div>
                    <div class="flex-grow grid grid-cols-2 sm:grid-cols-5 gap-2 w-full pointer-events-none">
                        <div>
                            <label class="block text-xs font-medium text-slate-500">Purchase</label>
                            <span class="font-semibold text-sm">${newPurchasePrice.toFixed(2)}</span>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500">Profit %</label>
                            <span class="font-semibold text-sm">${newProfitMargin}%</span>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500">Selling</label>
                            <span class="font-semibold text-sm">${newPrice.toFixed(2)}</span>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500">Qty</label>
                            <span class="font-semibold text-sm">${newQuantity}</span>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500">Disc. %</label>
                            <span class="font-semibold text-sm">${newDiscount}%</span>
                        </div>
                    </div>
                    <button class="delete-product-code-btn text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100 z-10">
                        <i data-lucide="x-circle" class="w-5 h-5 pointer-events-none"></i>
                    </button>
                `;
                
                // Re-attach delete listener
                codeCardElement.querySelector('.delete-product-code-btn').onclick = (e) => {
                    e.stopPropagation();
                    e.target.closest('.product-code-entry').remove();
                    updateTotalQuantityInModal();
                };

                lucide.createIcons({ parentElement: codeCardElement });
                editProductCodeModal.classList.add('hidden');
                updateTotalQuantityInModal();
            };


            invoicesListTbody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const invoiceId = target.dataset.id;
                const firestoreId = target.dataset.firestoreId;
                if (target.classList.contains('delete-invoice-btn')) deleteInvoice(invoiceId, firestoreId);
                else if (target.classList.contains('view-invoice-details-btn')) showInvoiceDetails(invoiceId);
                else if (target.classList.contains('return-invoice-btn')) loadInvoiceForReturn(firestoreId, invoiceId);
                else if (target.classList.contains('print-saved-invoice-btn')) {
                    const invoices = isOnlineMode ? firestoreInvoices : JSON.parse(localStorage.getItem('savedInvoices')) || [];
                    const invoice = invoices.find(inv => inv.id === invoiceId);
                    if (invoice) generateAndSavePDF(invoice, 'copy');
                } else if (target.classList.contains('download-invoice-png-btn')) {
                    const invoices = isOnlineMode ? firestoreInvoices : JSON.parse(localStorage.getItem('savedInvoices')) || [];
                    const invoice = invoices.find(inv => inv.id === invoiceId);
                    if (invoice) generateAndDownloadPNG(invoice);
                } else if (target.classList.contains('edit-invoice-btn')) loadInvoiceForEditing(firestoreId, invoiceId);
            });
            returnsListTbody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const returnId = target.dataset.id;
                if (target.classList.contains('view-return-details-btn')) {
                    const returns = isOnlineMode ? firestoreReturns : JSON.parse(localStorage.getItem('savedReturns')) || [];
                    const returnInvoice = returns.find(r => r.id === returnId);
                    if(returnInvoice) showInvoiceDetails(returnInvoice.originalInvoiceId);
                } else if (target.classList.contains('print-saved-return-btn')) {
                    const returns = isOnlineMode ? firestoreReturns : JSON.parse(localStorage.getItem('savedReturns')) || [];
                    const returnToPrint = returns.find(r => r.id === returnId);
                    if (returnToPrint) {
                        generateAndSavePDF(returnToPrint, 'return');
                    }
                } else if (target.classList.contains('download-invoice-png-btn')) {
                    const returns = isOnlineMode ? firestoreReturns : JSON.parse(localStorage.getItem('savedReturns')) || [];
                    const returnToDownload = returns.find(r => r.id === returnId);
                    if (returnToDownload) {
                        generateAndDownloadPNG(returnToDownload);
                    }
                }
            });
            invoiceDetailsActions.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const id = button.dataset.id;
                const printType = button.dataset.printType;
                let objectToPrint = null;

                if (printType === 'return') {
                    const allReturns = isOnlineMode ? firestoreReturns : JSON.parse(localStorage.getItem('savedReturns')) || [];
                    objectToPrint = allReturns.find(r => r.id === id);
                } else { 
                    const allInvoices = isOnlineMode ? firestoreInvoices : JSON.parse(localStorage.getItem('savedInvoices')) || [];
                    const mainInvoice = allInvoices.find(inv => inv.id === id);
                    if (mainInvoice) {
                        objectToPrint = mainInvoice;
                    } else {
                        for (const inv of allInvoices) {
                            if (inv.originalInvoiceData && inv.originalInvoiceData.id === id) {
                                objectToPrint = inv.originalInvoiceData;
                                break;
                            }

                        }
                    }
                }

                if (objectToPrint) {
                    generateAndSavePDF(objectToPrint, printType);
                } else {
                    showAlert('Could not find invoice data to print.');
                }
            });
            settingsCloseBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
                if (appContainer.classList.contains('hidden')) {
                    signOut(auth);
                }
            });

            authorizedAccountsSelect.addEventListener('change', () => {
                if (authorizedAccountsSelect.value) {
                    sessionControls.classList.remove('hidden');
                } else {
                    sessionControls.classList.add('hidden');
                }
                 sessionStatusMessage.textContent = ''; 
            });
            saveAccountSessionBtn.addEventListener('click', saveAccountSession);
            cancelAccountSessionBtn.addEventListener('click', cancelAccountSession);
            
            permissionsCloseBtn.addEventListener('click', () => workerPermissionsModal.classList.add('hidden'));

            maintenanceModeToggle.addEventListener('change', () => {
                maintenanceMessageControls.style.display = maintenanceModeToggle.checked ? 'block' : 'none';
            });

            saveMaintenanceSettingsBtn.addEventListener('click', async () => {
                const settings = {
                    enabled: maintenanceModeToggle.checked,
                    message: maintenanceMessageInput.value.trim()
                };
                try {
                    const docRef = doc(db, 'configuration', 'maintenance');
                    await setDoc(docRef, settings);
                    showAlert('Maintenance settings saved successfully.');
                } catch (error) {
                    console.error("Error saving maintenance settings:", error);
                    showAlert('Failed to save maintenance settings.');
                }
            });
            
            document.addEventListener('click', (e) => {
                const settingsDropdown = document.getElementById('settings-dropdown');
                const settingsBtn = document.getElementById('settings-btn');
                if (settingsDropdown && settingsBtn && !settingsBtn.contains(e.target) && !settingsDropdown.contains(e.target)) {
                    settingsDropdown.classList.add('hidden');
                }
            });
            
            saveWorkerPasswordBtn.addEventListener('click', async () => {
                const newPassword = workerPasswordInput.value.trim();
                if (newPassword) {
                    workerPassword = newPassword;
                    await saveWorkerPermissions();
                    showAlert('Owner password saved successfully.');
                } else {
                    showAlert('Please enter a valid password.');
                }
            });

            addCashierBtn.addEventListener('click', () => {
                const name = newCashierNameInput.value.trim();
                const code = newCashierCodeInput.value.trim();
                const key = newCashierKeyInput.value.trim();
                if (!name || !code || !key) {
                    showAlert('Please fill all cashier fields.');
                    return;
                }
                workerPermissions.cashiers.push({ name, code, key });
                saveWorkerPermissions();
                renderCashierProfiles();
                populateCashierDropdown();
                newCashierNameInput.value = '';
                newCashierCodeInput.value = '';
                newCashierKeyInput.value = '';
            });

            cashierProfilesList.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-cashier-btn');
                if (deleteButton) {
                    const index = parseInt(deleteButton.dataset.index, 10);
                    workerPermissions.cashiers.splice(index, 1);
                    saveWorkerPermissions();
                    renderCashierProfiles();
                    populateCashierDropdown();
                }
            });
            
            invoiceCustomizationCloseBtn.addEventListener('click', () => invoiceCustomizationModal.classList.add('hidden'));
            invoiceCustomizationSaveBtn.addEventListener('click', () => {
                workerPermissions.shopName = invoiceShopNameInput.value;
                workerPermissions.branchInfo = invoiceBranchInfoInput.value;
                workerPermissions.machineNumber = invoiceMachineNumberInput.value;
                workerPermissions.invoiceAddress = invoiceAddressInput.value;
                workerPermissions.contactNumber = invoiceContactNumberInput.value;
                workerPermissions.returnPolicy = returnPolicyInput.value;
                workerPermissions.facebookLink = document.getElementById('invoice-facebook-link-input').value;
                saveWorkerPermissions();
                showAlert('Invoice settings saved.');
                invoiceCustomizationModal.classList.add('hidden');
            });

            loginHelpBtn.addEventListener('click', () => {
                complaintEmailInput.value = ''; 
                complaintMessageTextarea.value = '';
                helpModal.classList.remove('hidden');
                lucide.createIcons();
            });

            helpCloseBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
            sendComplaintBtn.addEventListener('click', () => {
                const email = complaintEmailInput.value.trim();
                const message = complaintMessageTextarea.value.trim();

                if (!email || !message) {
                    showAlert('Please enter your email and message.');
                    return;
                }

                sendComplaintBtn.disabled = true;
                sendComplaintBtn.innerHTML = '<span>Sending...</span>';

                const senderName = auth.currentUser ? auth.currentUser.displayName : "Guest User";

                const templateParams = {
                    sender_name: senderName,
                    sender_email: email,
                    message: message,
                    to_email: 'bdr.e.mohameed@gmail.com'
                };

                emailjs.send('POS', 'template_a5fyfk3', templateParams)
                    .then((response) => {
                       console.log('SUCCESS!', response.status, response.text);
                       showAlert('Your message has been sent successfully. Thank you!');
                       complaintMessageTextarea.value = '';
                       helpModal.classList.add('hidden');
                    }, (error) => {
                       console.log('FAILED...', error);
                       showAlert('An error occurred while sending the message. Please check your EmailJS account settings.');
                    })
                    .finally(() => {
                        sendComplaintBtn.disabled = false;
                        sendComplaintBtn.innerHTML = '<i data-lucide="send"></i><span>Send</span>';
                        lucide.createIcons();
                    });
            });
            
            ownerDeleteAllInvoicesBtn.addEventListener('click', deleteAllInvoices);
            ownerDeleteAllReturnsBtn.addEventListener('click', deleteAllReturns);
            ownerDeleteArchiveBtn.addEventListener('click', deleteAllArchiveData);

            loginHelpBtn.addEventListener('click', () => {
                complaintEmailInput.value = ''; 
                complaintMessageTextarea.value = '';
                helpModal.classList.remove('hidden');
                lucide.createIcons();
            });

            maintenanceHelpBtn.addEventListener('click', () => {
                complaintEmailInput.value = ''; 
                complaintMessageTextarea.value = '';
                helpModal.classList.remove('hidden');
                lucide.createIcons();
            });

            openDangerZoneBtn.addEventListener('click', () => {
                dangerZoneModal.classList.remove('hidden');
                lucide.createIcons();
            });

            dangerZoneCloseBtn.addEventListener('click', () => {
                dangerZoneModal.classList.add('hidden');
            });

            openCashierProfilesBtn.addEventListener('click', () => {
                cashierProfilesModal.classList.remove('hidden');
                lucide.createIcons();
            });

            cashierProfilesCloseBtn.addEventListener('click', () => {
                cashierProfilesModal.classList.add('hidden');
            });

            showUnconfirmedBtn.addEventListener('click', () => {
                renderUnconfirmedInvoicesList();
                unconfirmedInvoicesModal.classList.remove('hidden');
            });

            unconfirmedInvoicesCloseBtn.addEventListener('click', () => {
                unconfirmedInvoicesModal.classList.add('hidden');
                displayUnconfirmedInvoiceDetails(null); // Clear details on close
            });

            showArchiveBtn.addEventListener('click', () => {
                renderInvoiceArchive();
                invoiceArchiveModal.classList.remove('hidden');
            });

            invoiceArchiveCloseBtn.addEventListener('click', () => {
                invoiceArchiveModal.classList.add('hidden');
            });

            archiveDetailsCloseBtn.addEventListener('click', () => {
                archiveDetailsModal.classList.add('hidden');
            });

            invoiceArchiveList.addEventListener('click', (e) => {
                const logItem = e.target.closest('.archive-log-item');
                if (logItem) {
                    const invoiceId = logItem.dataset.invoiceId;
                    const archiveEntry = firestoreInvoiceArchive.find(log => log.invoiceId === invoiceId);
                    if (archiveEntry && archiveEntry.invoiceData) {
                        showArchiveInvoiceDetails(archiveEntry);
                    } else {
                        showAlert('Could not find detailed data for this archive entry.');
                    }
                }
            });

            unconfirmedInvoicesList.addEventListener('click', (e) => {
                const item = e.target.closest('.unconfirmed-invoice-item');
                if (!item) return;

                // Check if a button was clicked inside the item
                const confirmBtn = e.target.closest('.confirm-invoice-btn');
                const cancelBtn = e.target.closest('.cancel-invoice-btn');

                if (confirmBtn || cancelBtn) {
                    // Button clicks are handled here, stopping propagation to the item click
                    e.stopPropagation(); 
                    const firestoreId = (confirmBtn || cancelBtn).dataset.firestoreId;
                    if (confirmBtn) {
                        confirmInvoice(firestoreId);
                    } else {
                        cancelInvoice(firestoreId);
                    }
                    return;
                }
                
                // Handle click on the item itself for details view
                const firestoreId = item.dataset.firestoreId;
                const invoice = firestoreUnconfirmedInvoices.find(inv => inv.firestoreId === firestoreId);

                // Highlight selected
                document.querySelectorAll('.unconfirmed-invoice-item').forEach(el => el.classList.remove('bg-blue-100', 'ring-2', 'ring-blue-300'));
                item.classList.add('bg-blue-100', 'ring-2', 'ring-blue-300');

                displayUnconfirmedInvoiceDetails(invoice);
            });

            renderCart();
            lucide.createIcons();
            setInterval(updateClock, 1000);
            initializeFirebase();

            if (auth) {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        await initializeUserSession(user);
                    } else {
                        tearDownUserSession();
                    }
                });
            }

            function tearDownUserSession() {
                loginView.classList.remove('hidden');
                appContainer.classList.add('hidden');
                isOnlineMode = false;
                userId = null;
                sessionExpiryTimestamp = null; 
                clearAutoLogoutTimer();
                if (systemLockInterval) clearInterval(systemLockInterval);
                if (unsubscribeFromInvoices) unsubscribeFromInvoices();
                if (unsubscribeFromProducts) unsubscribeFromProducts();
                if (unsubscribeFromReturns) unsubscribeFromReturns();
                if (unsubscribeFromExpenses) unsubscribeFromExpenses();
                if (unsubscribeFromArchive) unsubscribeFromArchive();
            }

            async function initializeUserSession(user) {
                if (loginForSettings) {
                    // Dedicated flow for "Owner Access"
                    try {
                        const configDocRef = doc(db, 'configuration', 'settings');
                        const configDocSnap = await getDoc(configDocRef);
                        const ownerEmail = configDocSnap.exists() ? configDocSnap.data().ownerEmail : null;

                        if (!ownerEmail || user.email.toLowerCase() !== ownerEmail.toLowerCase()) {
                            await showAlert(`Access denied. The account ${user.email} is not registered as the owner.`);
                            loginForSettings = false; // Reset flag on failure
                            return await signOut(auth);
                        }
                        
                        // Owner is verified.
                        userId = user.uid; // Set userId to load permissions
                        isOnlineMode = true;
                        
                        // Keep the login view visible in the background.
                        // Do NOT show the main app container.
                        appContainer.classList.add('hidden'); 

                        await loadWorkerPermissions(); // Load permissions data for the modal
                        await openSettingsModal();     // Open the settings modal on top of the login screen.
                        
                        loginForSettings = false; // Reset the flag
                        
                        // The closing of the settings modal will handle the sign-out.
                        return; // Stop further execution.

                    } catch (error) {
                        console.error("Error verifying owner status:", error);
                        await showAlert('Could not verify owner status due to an error. Access denied.');
                        loginForSettings = false; // Reset flag on error
                        return await signOut(auth);
                    }
                }

                // This is the normal flow for regular user login
                try {
                    const configDocRef = doc(db, 'configuration', 'settings');
                    const configDocSnap = await getDoc(configDocRef);
                    if (configDocSnap.exists() && configDocSnap.data().authorizedUsers) {
                        const isAuthorized = configDocSnap.data().authorizedUsers.some(
                            authorizedUser => authorizedUser.email.toLowerCase() === user.email.toLowerCase()
                        );
                        if (!isAuthorized) {
                            await showAlert(`Access denied for this account: ${user.email}. This account is not authorized.`);
                            return await signOut(auth);
                        }
                    } else {
                        await showAlert('User authorization list not found. Access denied.');
                        return await signOut(auth);
                    }
                } catch (error) {
                    console.error("Error fetching user authorization list:", error);
                    await showAlert('Could not verify user authorization. Access denied.');
                    return await signOut(auth);
                }

                const sessionInfo = await loadAppSettings(user.uid);
                if (!sessionInfo.isValid) {
                    await showAlert('Your login session has expired. Please contact the owner to renew it.');
                    return await signOut(auth);
                }
                
                startAutoLogoutTimer(sessionInfo.expiryTimestamp);

                userId = user.uid;
                isOnlineMode = true;
                isDeveloperMode = false;
                isLockOverridden = false;
                loginStatusMessage.textContent = 'Verified. Syncing...';
                loginStatusMessage.classList.add('text-green-400');

                await loadWorkerPermissions();
                await loadCustomExpenseTypes();
                await syncLocalToCloudOnLogin();
                setupProductsListener();
                setupInvoicesListener();
                setupReturnsListener();
                setupExpensesListener();
                setupArchiveListener();
                setupInAppMaintenanceListener(); // Call the maintenance listener after login

                if (systemLockInterval) clearInterval(systemLockInterval);
                checkSystemLock(); // Initial check on login
                systemLockInterval = setInterval(checkSystemLock, 60000); // Check every minute

                updateUIMode();
                renderProducts(products);
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                posView.classList.remove('hidden-view');
                posView.classList.add('flex');
            }

            const loadCustomExpenseTypes = async () => {
                if (!isOnlineMode || !userId) {
                    customExpenseTypes = [];
                    allExpenseTypes = []; // Start with an empty list when offline
                    return;
                }
                try {
                    const docRef = doc(db, `users/${userId}/settings`, 'expenseTypes');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists() && docSnap.data().types) {
                        customExpenseTypes = docSnap.data().types;
                    } else {
                        // If it doesn't exist, start with an empty list in the cloud.
                        customExpenseTypes = []; 
                        await saveCustomExpenseTypes();
                    }
                } catch (error) {
                    console.error("Error loading custom expense types:", error);
                    customExpenseTypes = [];
                }
                allExpenseTypes = [...customExpenseTypes].sort(); // Only use custom types
            };

            const saveCustomExpenseTypes = async () => {
                if (!isOnlineMode || !userId) return;
                try {
                    const docRef = doc(db, `users/${userId}/settings`, 'expenseTypes');
                    await setDoc(docRef, { types: customExpenseTypes });
                } catch (error) {
                    console.error("Error saving custom expense types:", error);
                    showAlert('Failed to save the new expense type.');
                }
            };

            const newExpenseTypeInput = document.getElementById('new-expense-type-input');
            const addNewExpenseTypeBtn = document.getElementById('add-new-expense-type-btn');

            addNewExpenseTypeBtn.addEventListener('click', async () => {
                const newType = newExpenseTypeInput.value.trim();
                if (!newType) {
                    return showAlert('Please enter a type name.');
                }

                const lowerCaseCustomTypes = customExpenseTypes.map(t => t.toLowerCase());
                if (lowerCaseCustomTypes.includes(newType.toLowerCase())) {
                    return showAlert(`The type "${newType}" already exists.`);
                }
                
                // Add the new type
                customExpenseTypes.push(newType);
                await saveCustomExpenseTypes();
                await loadCustomExpenseTypes(); // Reload and sort
                populateExpenseTypeModal(); // Refresh the modal view

                // Optionally select the newly added type
                if (currentExpenseTypeInput) {
                    currentExpenseTypeInput.value = newType;
                    expenseTypeModal.classList.add('hidden');
                }
                newExpenseTypeInput.value = '';
            });

            const newProductPurchasePriceInput = document.getElementById('new-product-purchase-price');
            const newProductProfitMarginInput = document.getElementById('new-product-profit-margin');
            
            const editProductPurchasePriceInput = document.getElementById('edit-product-purchase-price');
            const editProductProfitMarginInput = document.getElementById('edit-product-profit-margin');

            const newProductCodePurchasePriceInput = document.getElementById('new-product-code-purchase-price');
            const newProductCodeProfitMarginInput = document.getElementById('new-product-code-profit-margin');
            const newProductCodePriceInput = document.getElementById('new-product-code-price');

            const editCodePurchasePriceInput = document.getElementById('edit-code-purchase-price');
            const editCodeProfitMarginInput = document.getElementById('edit-code-profit-margin');
            const editCodePriceInput = document.getElementById('edit-code-price');
            
            const calculateSellingPrice = (purchasePriceInput, profitMarginInput, sellingPriceInput) => {
                const purchasePrice = parseFloat(purchasePriceInput.value) || 0;
                const profitMargin = parseFloat(profitMarginInput.value) || 0;
                if (purchasePrice > 0) {
                    const sellingPrice = purchasePrice * (1 + profitMargin / 100);
                    sellingPriceInput.value = sellingPrice.toFixed(2);
                } else {
                    sellingPriceInput.value = '';
                }
            };

            newProductPurchasePriceInput.addEventListener('input', () => calculateSellingPrice(newProductPurchasePriceInput, newProductProfitMarginInput, newProductPriceInput));
            newProductProfitMarginInput.addEventListener('input', () => calculateSellingPrice(newProductPurchasePriceInput, newProductProfitMarginInput, newProductPriceInput));

            editProductPurchasePriceInput.addEventListener('input', () => calculateSellingPrice(editProductPurchasePriceInput, editProductProfitMarginInput, editProductPriceInput));
            editProductProfitMarginInput.addEventListener('input', () => calculateSellingPrice(editProductPurchasePriceInput, editProductProfitMarginInput, editProductPriceInput));

            newProductCodePurchasePriceInput.addEventListener('input', () => calculateSellingPrice(newProductCodePurchasePriceInput, newProductCodeProfitMarginInput, newProductCodePriceInput));
            newProductCodeProfitMarginInput.addEventListener('input', () => calculateSellingPrice(newProductCodePurchasePriceInput, newProductCodeProfitMarginInput, newProductCodePriceInput));

            editCodePurchasePriceInput.addEventListener('input', () => calculateSellingPrice(editCodePurchasePriceInput, editCodeProfitMarginInput, editCodePriceInput));
            editCodeProfitMarginInput.addEventListener('input', () => calculateSellingPrice(editCodePurchasePriceInput, editCodeProfitMarginInput, editCodePriceInput));

            modalSaveCodeBtn.addEventListener('click', saveProductCodeChanges);

            function setupInAppMaintenanceListener() {
                if (!isOnlineMode || !userId) return;
                const maintenanceView = document.getElementById('in-app-maintenance-view');
                const maintenanceMessageEl = document.getElementById('in-app-maintenance-message');
                
                const docRef = doc(db, 'configuration', 'maintenance');
                onSnapshot(docRef, (docSnap) => {
                    let settings = { enabled: false, message: 'The system is currently down for scheduled maintenance. Please check back later.' };
                    if (docSnap.exists()) {
                        settings = { ...settings, ...docSnap.data() };
                    }
                    
                    if (settings.enabled) {
                        maintenanceMessageEl.textContent = settings.message;
                        maintenanceView.classList.remove('hidden');
                        lucide.createIcons();
                    } else {
                        maintenanceView.classList.add('hidden');
                    }
                }, (error) => {
                     console.error("Error listening to maintenance status:", error);
                });
            }
            
            // --- App Initialization ---
            initializeFirebase();

            if (auth) {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        await initializeUserSession(user);
                    } else {
                        tearDownUserSession();
                    }
                });
            }

        });
    </script>

</body>
</html>

